<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v8.4.0 <https://hydejack.com/>
-->











<head>
  



<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">




  
<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Calling COM code from Go | yizhang82’s blog</title>
<meta property="og:title" content="Calling COM code from Go" />
<meta name="author" content="Yi Zhang" />
<meta property="og:locale" content="en" />
<meta name="description" content="How to call COM code from Go" />
<meta property="og:description" content="How to call COM code from Go" />
<link rel="canonical" href="http://localhost:4000/calling-com-from-go" />
<meta property="og:url" content="http://localhost:4000/calling-com-from-go" />
<meta property="og:site_name" content="yizhang82’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-01-27T00:00:00-08:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/calling-com-from-go","headline":"Calling COM code from Go","dateModified":"2017-01-27T00:00:00-08:00","datePublished":"2017-01-27T00:00:00-08:00","sameAs":null,"image":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/calling-com-from-go"},"name":null,"author":{"@type":"Person","name":"Yi Zhang"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icons/icon.png"},"name":"Yi Zhang"},"description":"How to call COM code from Go","@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  


<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="yizhang82's blog">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<meta name="application-name" content="yizhang82's blog">
<meta name="msapplication-config" content="/assets/ieconfig.xml">


<meta name="theme-color" content="#193747">


<meta name="generator" content="Hydejack v8.4.0" />

<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="yizhang82's blog" />



<link rel="alternate" href="http://localhost:4000/calling-com-from-go" hreflang="en">

<link rel="shortcut icon" href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon.png">

<link rel="manifest" href="/assets/manifest.json">


  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">


  <link rel="dns-prefetch" href="https://www.google-analytics.com">



<link rel="dns-prefetch" href="/" id="_baseURL">
<link rel="dns-prefetch" href="/assets/js/hydejack-8.4.0.js" id="_hrefJS">
<link rel="dns-prefetch" href="/sw.js" id="_hrefSW">
<link rel="dns-prefetch" href="/assets/bower_components/fontfaceobserver/fontfaceobserver.standalone.js" id="_hrefFFO">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js" id="_hrefKatexJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_hrefKatexCSS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.js" id="_hrefKatexCopyJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.css" id="_hrefKatexCopyCSS">
<link rel="dns-prefetch" href="/assets/img/swipe.svg" id="_hrefSwipeSVG">



<link rel="dns-prefetch" href="https://yizhang82.disqus.com" id="_hrefDisqus">


<script>!function(e,t){"use strict";function n(e,t,n,r){e.addEventListener?e.addEventListener(t,n,r):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,r){var o=t.createElement("script");o.src=e,r&&n(o,"load",r,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(o,a),o},e._loaded=!1,e.loadJSDeferred=function(r,o){function a(){e._loaded=!0,o&&n(d,"load",o,{once:!0});var r=t.scripts[0];r.parentNode.insertBefore(d,r)}var d=t.createElement("script");return d.src=r,e._loaded?a():n(e,"load",a,{once:!0}),d},e.setRel=e.setRelStylesheet=function(e){function n(){this.rel="stylesheet"}var r=t.getElementById(e);r.addEventListener?r.addEventListener("load",n,{once:!0}):r.onload=n}}(window,document);
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
</script>

<script>!function(w, d) {
    w._noPushState = false;
    w._noDrawer = false;

    /**/
    loadJS(d.getElementById('_hrefFFO').href, function() {
      if ('Promise' in w) Promise.all([
        new FontFaceObserver('Noto Sans').load(),
        new FontFaceObserver('Roboto Slab').load(),
      ]).then(function f() { d.body.classList.add('font-active'); }, function() {});
    });
    /**/
}(window, document);</script>

<!--[if gt IE 8]><!---->








  <link rel="stylesheet" href="/assets/css/hydejack-8.4.0.css">
  <link rel="stylesheet" href="/assets/icomoon/style.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Noto+Sans:400,400i,700,700i">
    <noscript>
      <style>
        html { font-family: Noto Sans, Helvetica, Arial, sans-serif!important; }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Roboto Slab, Helvetica, Arial, sans-serif!important; }
      </style>
    </noscript>
  


  <style id="_pageStyle">

.content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba !important}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus,.form-control:focus,.form-control.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}

</style>


<!--<![endif]-->




</head>

<body>
  <div id="_navbar" class="navbar fixed-top">
  <div class="content">
    <div class="nav-btn-bar">
      <span class="sr-only">Jump to:</span>
      <a id="_menu" class="nav-btn no-hover fl" href="#_navigation">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>
    </div>
  </div>
</div>
<hr class="sr-only" hidden />


<hy-push-state
  replace-ids="_main"
  link-selector="a[href]:not([href*='/assets/']):not(.external):not(.no-push-state)"
  duration="250"
  script-selector="script:not([type^='math/tex'])"
  prefetch
>
  
    <main
  id="_main"
  class="content fade-in layout-post"
  role="main"
  data-color="#4fb1ba"
  data-theme-color="#193747"
  
    data-image="/assets/img/sidebar-bg.jpg"
    data-overlay
  
  >
  




<article id="post-com" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      
        Calling COM code from Go
      
    </h1>

    <p class="post-date heading">
      
      <time datetime="2017-01-27T00:00:00-08:00">27 Jan 2017</time>
      
      
      
      
      









in <span>Go</span> / <a href="/category/interop/" class="flip-title">Interop</a> / <span>Com</span>

      











    </p>

    
    

    



  
    <p class="message" >
      How to call COM code from Go

    </p>
  


  </header>

  
    <p>In my previous blog I talked about how to call to C functions directly using syscall module, without using Cgo. We can expand this idea a bit further - to call COM objects in Go. As a simple example, let’s see if we can call IMalloc interface implemented in Windows.</p>

<p>To give a bit background, IMalloc is a COM interface that provides malloc/free equivalent functionality, and more importantly, through the process-wide allocator obtained through <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms693395(v=vs.85).aspx">CoGetMalloc</a>, allow caller/callee to exchange memory ownership, as long as they agree on using the same memory allocator. Simply put, caller from module A could pass a buffer allocated in A, and pass to module B, which can free it, both using process-wide IMalloc allocator. C++ developers are probably familiar with the scenario - if you send a object malloc-ed from one module, and pass to another module which does the free, there is no guaratee that the free would succeed since the two modules might have different allocator used (if they use different CRT library, or both compiled the CRT in statically).</p>

<p>The interface is defined as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
interface IMalloc : public IUnknown
{
public:
    virtual void *STDMETHODCALLTYPE Alloc( 
        /* [in] */ SIZE_T cb) = 0;
    
    virtual void *STDMETHODCALLTYPE Realloc( 
        /* [in] */ void *pv,
        /* [in] */ SIZE_T cb) = 0;
    
    virtual void STDMETHODCALLTYPE Free( 
        /* [in] */ void *pv) = 0;
    
    virtual SIZE_T STDMETHODCALLTYPE GetSize( 
        /* [in] */ void *pv) = 0;
    
    virtual int STDMETHODCALLTYPE DidAlloc( 
        void *pv) = 0;
    
    virtual void STDMETHODCALLTYPE HeapMinimize( void) = 0;
    
};

</code></pre></div></div>

<p>The functions here are pretty straight-forward. If you are curious, you can refer to the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms678425(v=vs.85).aspx">documentation</a></p>

<p>Calling CoGetMalloc should be pretty straight-forward using syscall module as discussed in the previous post. Calling the underlying COM object requires slightly more work. COM is an ABI protocol that supports simple v-table based call dispatch, lifetime management, and threading (probably the most confusing part). To call a COM interface, you only need to call through the v-table, which is a series of function pointer pointing to the underlying code. To define v-table in go, it would look something like this:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">MallocVtbl</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">queryInterface</span><span class="x"> </span><span class="kt">uintptr</span><span class="x"> 
    </span><span class="n">addref</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">release</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">alloc</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">realloc</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">free</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">getSize</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">didAlloc</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">heapMinimize</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
</span><span class="p">}</span><span class="x"> 
</span></code></pre></div></div>

<p>Note that the order is very important - it needs to match exactly with the interface itself, and the first 3 is always coming from IUnknown methods.</p>

<p>The v-table pointer can be obtained from the first pointer in the object.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span><span class="x"> </span><span class="n">malloc</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">;</span><span class="x">  </span><span class="c">// This is the IMalloc*</span><span class="x">

</span><span class="n">mallocVtblPtr</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">malloc</span><span class="p">))</span><span class="x"> </span><span class="c">// Get the vtable pointer</span><span class="x">

</span><span class="n">mallocVtbl</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">MallocVtbl</span><span class="p">)(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">mallocVtblPtr</span><span class="p">))</span><span class="x">  </span><span class="c">// Convert to the right MallocVtbl*</span><span class="x">
</span></code></pre></div></div>

<p>Once we have the vtable, getting the underlying function pointer is a simple matter of using the right fields, and then we can call it using syscall like before:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">memPtr</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">Syscall</span><span class="p">(</span><span class="n">mallocVtbl</span><span class="o">.</span><span class="n">alloc</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">2</span><span class="p">),</span><span class="x"> </span><span class="n">malloc</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="n">memSize</span><span class="p">),</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">0</span><span class="p">))</span><span class="x">  
</span></code></pre></div></div>

<p>You can find the full code below:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="x">
</span><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
    </span><span class="s">"fmt"</span><span class="x">
    </span><span class="s">"log"</span><span class="x">
    </span><span class="s">"syscall"</span><span class="x">
    </span><span class="s">"unsafe"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">type</span><span class="x"> </span><span class="n">MallocVtbl</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">queryInterface</span><span class="x"> </span><span class="kt">uintptr</span><span class="x"> 
    </span><span class="n">addref</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">release</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">alloc</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">realloc</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">free</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">getSize</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">didAlloc</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
    </span><span class="n">heapMinimize</span><span class="x"> </span><span class="kt">uintptr</span><span class="x">
</span><span class="p">}</span><span class="x">   

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Loading ole32.dll...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span><span class="x">

    </span><span class="n">handle</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s">"ole32.dll"</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
        </span><span class="k">return</span><span class="x">
    </span><span class="p">}</span><span class="x">

    </span><span class="n">proc</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="x"> </span><span class="s">"CoGetMalloc"</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">

    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Calling CoGetMalloc</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span><span class="x">
    </span><span class="k">var</span><span class="x"> </span><span class="n">malloc</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">;</span><span class="x">
    </span><span class="n">ret</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">Syscall</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">2</span><span class="p">),</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">1</span><span class="p">),</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">malloc</span><span class="p">)),</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">0</span><span class="p">))</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">ret</span><span class="x"> </span><span class="o">&lt;</span><span class="x"> </span><span class="m">0</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">

    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"CoGetMalloc returned %x</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">malloc</span><span class="p">)</span><span class="x"> 

    </span><span class="n">mallocVtblPtr</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">malloc</span><span class="p">))</span><span class="x">
    </span><span class="n">mallocVtbl</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">MallocVtbl</span><span class="p">)(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">mallocVtblPtr</span><span class="p">))</span><span class="x">

    </span><span class="k">const</span><span class="x"> </span><span class="n">memSize</span><span class="x"> </span><span class="kt">int</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">100</span><span class="x">
    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Calling IMalloc::Alloc(%v)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">memSize</span><span class="p">)</span><span class="x">
    </span><span class="n">memPtr</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">Syscall</span><span class="p">(</span><span class="n">mallocVtbl</span><span class="o">.</span><span class="n">alloc</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">2</span><span class="p">),</span><span class="x"> </span><span class="n">malloc</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="n">memSize</span><span class="p">),</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">0</span><span class="p">))</span><span class="x">
    
    </span><span class="k">if</span><span class="x"> </span><span class="n">memPtr</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="m">0</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
       
    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"IMalloc::Alloc returned %x</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">memPtr</span><span class="p">)</span><span class="x"> 
 
    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Calling IMalloc::GetSize with %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">memPtr</span><span class="p">)</span><span class="x">

    </span><span class="n">returnedSize</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">Syscall</span><span class="p">(</span><span class="n">mallocVtbl</span><span class="o">.</span><span class="n">getSize</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">2</span><span class="p">),</span><span class="x"> </span><span class="n">malloc</span><span class="p">,</span><span class="x"> </span><span class="n">memPtr</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">0</span><span class="p">))</span><span class="x">
    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"IMalloc::GetSize returned %v</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">returnedSize</span><span class="p">)</span><span class="x">

    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Calling IMalloc::Free with %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">memPtr</span><span class="p">);</span><span class="x">
    </span><span class="n">syscall</span><span class="o">.</span><span class="n">Syscall</span><span class="p">(</span><span class="n">mallocVtbl</span><span class="o">.</span><span class="n">free</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">2</span><span class="p">),</span><span class="x"> </span><span class="n">malloc</span><span class="p">,</span><span class="x"> </span><span class="n">memPtr</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">0</span><span class="p">))</span><span class="x">
    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"IMalloc::Free succeeded</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span><span class="x">

    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Calling IMalloc::DidAlloc with %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">memPtr</span><span class="p">)</span><span class="x">
    </span><span class="n">ret</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">Syscall</span><span class="p">(</span><span class="n">mallocVtbl</span><span class="o">.</span><span class="n">didAlloc</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">2</span><span class="p">),</span><span class="x"> </span><span class="n">malloc</span><span class="p">,</span><span class="x"> </span><span class="n">memPtr</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">0</span><span class="p">))</span><span class="x">
    </span><span class="n">didAlloc</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="kt">bool</span><span class="p">(</span><span class="n">ret</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="m">0</span><span class="p">)</span><span class="x">
    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"IMalloc::DidAlloc returned %v</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">didAlloc</span><span class="p">);</span><span class="x">

    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Calling IMalloc::Release</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span><span class="x">
    </span><span class="n">ret</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">syscall</span><span class="o">.</span><span class="n">Syscall</span><span class="p">(</span><span class="n">mallocVtbl</span><span class="o">.</span><span class="n">release</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">1</span><span class="p">),</span><span class="x"> </span><span class="n">malloc</span><span class="p">,</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">0</span><span class="p">),</span><span class="x"> </span><span class="kt">uintptr</span><span class="p">(</span><span class="m">0</span><span class="p">))</span><span class="x">
    </span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"IMalloc::Release returned %v</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">ret</span><span class="p">);</span><span class="x">
</span><span class="p">}</span><span class="x">

</span></code></pre></div></div>


  
</article>


<hr class="dingbat related" />




  
     


  <aside class="about related mt4 mb4" role="complementary">
    
    

<div class="author mt4">
  

  
    


  <hy-img
    
    src="https://placehold.it/128x128"
    class="avatar"
    alt="<firstname> <lastname>"
    srcset="https://placehold.it/128x128 1x,https://placehold.it/256x256 2x"
    
  
    
    root-margin="512px"
  >
    <noscript><img data-ignore 
    src="https://placehold.it/128x128"
    class="avatar"
    alt="<firstname> <lastname>"
    srcset="https://placehold.it/128x128 1x,https://placehold.it/256x256 2x"
    
  /></noscript>
    <span class="loading" slot="loading" hidden>
      <span class="icon-cog"></span>
    </span>
  </hy-img>


  

  
  
  <h2  class="page-title hr">
    About
  </h2>

  <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit,
sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>

<p>Open <code class="highlighter-rouge">_data/authors.yml</code> to edit this text.</p>

<p><a href="https://github.com/qwtel/hydejack-starter-kit/archive/v8.1.1.zip">Download Free</a>
– or –
<a href="https://app.simplegoods.co/i/NATYVLYT">Buy PRO</a></p>



  <div class="sidebar-social">
    <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://twitter.com/<username>" title="Twitter" class="no-mark-external">
      <span class="icon-twitter"></span>
      <span class="sr-only">Twitter</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/<username>" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
  
</ul>

  </div>
</div>

  </aside>


  

  
  

  
    




<aside class="related mb4" role="complementary">
  <h2 class="hr">Related Posts</h2>

  <ul class="related-posts">
    
      


<li>
  <a href="/go-and-async-await" class="h4 flip-title">
    <span>Does Go need async/await?</span>
  </a>
  <time class="heading faded fine" datetime="2018-04-02T00:00:00-07:00">02 Apr 2018</time>
</li>

    
      


<li>
  <a href="/calling-c-from-go" class="h4 flip-title">
    <span>Calling C functions from GO</span>
  </a>
  <time class="heading faded fine" datetime="2017-01-03T00:00:00-08:00">03 Jan 2017</time>
</li>

    
  </ul>
</aside>

  


  
<aside class="comments related" role="complementary">
  <h2 class="hr">Comments</h2>
  

<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>!function(w, d) {
  if (d.getElementById("disqus_thread")) {
    if (w.DISQUS) {
      w.DISQUS.reset({
        reload: true,
        config() {
          this.page.url = w.location.href;
          this.page.title = d.title;
        },
      });
    } else {
      w.disqus_config = function disqusConfig() {
        this.page.url = w.location.href;
        this.page.title = d.title;
      };
      w.loadJSDeferred(d.getElementById("_hrefDisqus").href + '/embed.js');
    }
  }
}(window, document);</script>


</aside>


  
<footer role="contentinfo">
  <hr/>
  
    <p><small class="copyright">© 2017. All rights reserved.
</small></p>
  
  
  <p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">8.4.0</span></small></p>
  <hr class="sr-only"/>
</footer>


</main>

    <hy-drawer
  class=""
  align="left"
  threshold="10"
  touch-events
  prevent-default
>
  <header id="_sidebar" class="sidebar" role="banner">
    
    <div class="sidebar-bg sidebar-overlay" style="background-color:#4fb1ba;background-image:url(/assets/img/sidebar-bg.jpg)"></div>

    <div class="sidebar-sticky">
      <div class="sidebar-about">
        
          <a class="no-hover" href="/" tabindex="-1">
            <img src="/assets/icons/icon.png" class="avatar" alt="yizhang82's blog" data-ignore />
          </a>
        
        <h2 class="h1"><a href="/">yizhang82's blog</a></h2>
        
        
          <p class="">
            Languages, Runtime, Data structures, Databases, and everything in between

          </p>
        
      </div>

      <nav class="sidebar-nav heading" role="navigation">
        <span class="sr-only">Navigation:</span>
<ul>
  
    
    
    

    
      
        <li>
          <a
            id="_navigation"
            href="/blog/"
            class="sidebar-nav-item"
            
            >
            Blog archive
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/dotnet/"
            class="sidebar-nav-item"
            
            >
            .NET / .NET Core
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/database/"
            class="sidebar-nav-item"
            
            >
            Database
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/interop/"
            class="sidebar-nav-item"
            
            >
            Interop
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/about/"
            class="sidebar-nav-item"
            
            >
            About me
          </a>
        </li>
      
    
  
</ul>

      </nav>

      

      <div class="sidebar-social">
        <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://twitter.com/<username>" title="Twitter" class="no-mark-external">
      <span class="icon-twitter"></span>
      <span class="sr-only">Twitter</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/<username>" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
  
</ul>

      </div>
    </div>
  </header>
</hy-drawer>
<hr class="sr-only" hidden />

  
</hy-push-state>


  <!--[if !IE]><!---->
  <script>loadJSDeferred(document.getElementById('_hrefJS').href);</script>
  

  <!--<![endif]-->

  
  <script>!function(w, d) {
    w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;

    /**/
      ga('create', 'UA-93224322-1', 'auto');
    /**/

    var pushStateEl = d.getElementsByTagName('hy-push-state')[0];
    var timeoutId;
    pushStateEl.addEventListener('hy-push-state-load', function() {
      w.clearTimeout(timeoutId);
      timeoutId = w.setTimeout(function() {
        ga('set', 'page', w.location.pathname);
        ga('send', 'pageview');
      }, 500);
    });

    d.addEventListener('hy--cookies-ok', function () {
      w.ga(function(tracker) {
        w.ga("set", "anonymizeIp", undefined);
        localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId"));
      });
    });

    w.loadJSDeferred('https://www.google-analytics.com/analytics.js');
  }(window, document);</script>



  <script>
    if ('serviceWorker' in navigator) {
      
        navigator.serviceWorker.getRegistration()
          .then(r => r.unregister())
          .catch(() => {});
      
    }
  </script>






<h2 class="sr-only" hidden>Templates (for web app):</h2>

<template id="_animation-template" hidden>
  <div class="animation-main fixed-top">
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

<template id="_loading-template" hidden>
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

<template id="_error-template" hidden>
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

<template id="_back-template" hidden>
  <a id="_back" class="back nav-btn fl no-hover">
    <span class="sr-only">Back</span>
    <span class="icon-arrow-left2"></span>
  </a>
</template>

<template id="_permalink-template" hidden>
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="icon-link"></span>
  </a>
</template>




</body>
</html>
