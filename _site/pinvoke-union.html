<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v8.4.0 <https://hydejack.com/>
-->











<head>
  



<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">




  
<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>P/invoke with unions in C# | yizhang82’s blog</title>
<meta property="og:title" content="P/invoke with unions in C#" />
<meta name="author" content="Yi Zhang" />
<meta property="og:locale" content="en" />
<meta name="description" content="Talks about things to watch out for when using unions in C#" />
<meta property="og:description" content="Talks about things to watch out for when using unions in C#" />
<link rel="canonical" href="http://localhost:4000/pinvoke-union" />
<meta property="og:url" content="http://localhost:4000/pinvoke-union" />
<meta property="og:site_name" content="yizhang82’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-03-09T00:00:00-08:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/pinvoke-union","headline":"P/invoke with unions in C#","dateModified":"2017-03-09T00:00:00-08:00","datePublished":"2017-03-09T00:00:00-08:00","sameAs":null,"image":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/pinvoke-union"},"name":null,"author":{"@type":"Person","name":"Yi Zhang"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icons/icon.png"},"name":"Yi Zhang"},"description":"Talks about things to watch out for when using unions in C#","@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  


<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="yizhang82's blog">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<meta name="application-name" content="yizhang82's blog">
<meta name="msapplication-config" content="/assets/ieconfig.xml">


<meta name="theme-color" content="#193747">


<meta name="generator" content="Hydejack v8.4.0" />

<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="yizhang82's blog" />



<link rel="alternate" href="http://localhost:4000/pinvoke-union" hreflang="en">

<link rel="shortcut icon" href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon.png">

<link rel="manifest" href="/assets/manifest.json">


  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">


  <link rel="dns-prefetch" href="https://www.google-analytics.com">



<link rel="dns-prefetch" href="/" id="_baseURL">
<link rel="dns-prefetch" href="/assets/js/hydejack-8.4.0.js" id="_hrefJS">
<link rel="dns-prefetch" href="/sw.js" id="_hrefSW">
<link rel="dns-prefetch" href="/assets/bower_components/fontfaceobserver/fontfaceobserver.standalone.js" id="_hrefFFO">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js" id="_hrefKatexJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_hrefKatexCSS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.js" id="_hrefKatexCopyJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.css" id="_hrefKatexCopyCSS">
<link rel="dns-prefetch" href="/assets/img/swipe.svg" id="_hrefSwipeSVG">



<link rel="dns-prefetch" href="https://yizhang82.disqus.com" id="_hrefDisqus">


<script>!function(e,t){"use strict";function n(e,t,n,r){e.addEventListener?e.addEventListener(t,n,r):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,r){var o=t.createElement("script");o.src=e,r&&n(o,"load",r,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(o,a),o},e._loaded=!1,e.loadJSDeferred=function(r,o){function a(){e._loaded=!0,o&&n(d,"load",o,{once:!0});var r=t.scripts[0];r.parentNode.insertBefore(d,r)}var d=t.createElement("script");return d.src=r,e._loaded?a():n(e,"load",a,{once:!0}),d},e.setRel=e.setRelStylesheet=function(e){function n(){this.rel="stylesheet"}var r=t.getElementById(e);r.addEventListener?r.addEventListener("load",n,{once:!0}):r.onload=n}}(window,document);
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
</script>

<script>!function(w, d) {
    w._noPushState = false;
    w._noDrawer = false;

    /**/
    loadJS(d.getElementById('_hrefFFO').href, function() {
      if ('Promise' in w) Promise.all([
        new FontFaceObserver('Noto Sans').load(),
        new FontFaceObserver('Roboto Slab').load(),
      ]).then(function f() { d.body.classList.add('font-active'); }, function() {});
    });
    /**/
}(window, document);</script>

<!--[if gt IE 8]><!---->








  <link rel="stylesheet" href="/assets/css/hydejack-8.4.0.css">
  <link rel="stylesheet" href="/assets/icomoon/style.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Noto+Sans:400,400i,700,700i">
    <noscript>
      <style>
        html { font-family: Noto Sans, Helvetica, Arial, sans-serif!important; }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Roboto Slab, Helvetica, Arial, sans-serif!important; }
      </style>
    </noscript>
  


  <style id="_pageStyle">

.content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba !important}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus,.form-control:focus,.form-control.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}

</style>


<!--<![endif]-->




</head>

<body>
  <div id="_navbar" class="navbar fixed-top">
  <div class="content">
    <div class="nav-btn-bar">
      <span class="sr-only">Jump to:</span>
      <a id="_menu" class="nav-btn no-hover fl" href="#_navigation">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>
    </div>
  </div>
</div>
<hr class="sr-only" hidden />


<hy-push-state
  replace-ids="_main"
  link-selector="a[href]:not([href*='/assets/']):not(.external):not(.no-push-state)"
  duration="250"
  script-selector="script:not([type^='math/tex'])"
  prefetch
>
  
    <main
  id="_main"
  class="content fade-in layout-post"
  role="main"
  data-color="#4fb1ba"
  data-theme-color="#193747"
  
    data-image="/assets/img/sidebar-bg.jpg"
    data-overlay
  
  >
  




<article id="post-pinvoke-union" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      
        P/invoke with unions in C#
      
    </h1>

    <p class="post-date heading">
      
      <time datetime="2017-03-09T00:00:00-08:00">09 Mar 2017</time>
      
      
      
      
      









in <span>C#</span> / <a href="/category/interop/" class="flip-title">Interop</a> / <a href="/category/dotnet/" class="flip-title">.NET / .NET Core</a>

      











    </p>

    
    

    



  
    <p class="message" >
      Talks about things to watch out for when using unions in C#

    </p>
  


  </header>

  
    <p>When interop with native code using C# p/invokes, some time you need to create unions in C#. They are represented by structs with <code class="highlighter-rouge">[StructLayout(LayoutKind.Explicit)]</code> attribute and the fields annotated with <code class="highlighter-rouge">[FieldOffset(0)]</code> specifying their offset. It looks pretty straight-forward, but in practice this can be very deceiving. In this article, I’ll talk about two important rules when using unions.</p>

<h1 id="no-overlapping-fields-of-reference-fields-and-value-type-fields">No overlapping fields of reference fields and value type fields</h1>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">[StructLayout(LayoutKind.Explicit)]</span>
<span class="k">struct</span> <span class="nc">Foo</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">FieldOffset</span><span class="p">(</span><span class="m">0</span><span class="p">)]</span>
    <span class="kt">string</span> <span class="n">a</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">FieldOffset</span><span class="p">(</span><span class="m">0</span><span class="p">)]</span>
    <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This one doesn’t look that bad on surface - you have a string at offset 0, and it could also be a int at 0. It can’t be much different with a C struct with char * and a int union, right?</p>

<p>Not really. Given that this is .NET, all the objects / reference types are managed by the GC. Imagine if you are GC and you need to determine whether there is a string object at Foo.a needs to be kept alive (marked) - there is a value 0x12345678 at that location. What do you do?</p>
<ol>
  <li>Pretend that it is a object reference and go access it</li>
  <li>Admit defeat, ignore it, and assume it’s a int</li>
</ol>

<p>As you can see, there really isn’t a good option here. There is no way you can tell an arbitary integer and a object reference apart.</p>

<p>Fortunately, CLR Typeloader will quickly point out that this is invalid:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Unhandled Exception: System.TypeLoadException: Could not load type 'Foo' from assembly 'union, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null' because it contains an object field at offset 0 that is incorrectly aligned or overlapped by a non-object field.
</code></pre></div></div>

<p>A slight variant of this is overlapping fields:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">[StructLayout(LayoutKind.Explicit)]</span>
<span class="k">struct</span> <span class="nc">Foo</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">FieldOffset</span><span class="p">(</span><span class="m">0</span><span class="p">)]</span>
    <span class="kt">string</span> <span class="n">a</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">FieldOffset</span><span class="p">(</span><span class="m">1</span><span class="p">)]</span>
    <span class="kt">string</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now you got a string reference at offset 0, and a string reference at offset 1. Again, if you are reading an pointer value (really, that’s what object reference is) out of offset 0, is it string a, or a 3/4 of string b? Don’t know. Again, type loader would blow up and give you the same exception.</p>

<h1 id="overlapping-c-union-fields-must-be-blittable">Overlapping C# union fields must be blittable</h1>

<p>This one is slightly more subtle, but not that bad once you understand how .NET interop marshalling works.</p>

<p>First let me clarify what blittable means - it means the native and managed representation is the same. Obviously any reference type is not blittable. Char is also not blittable by default since char is UTF-16 in managed, and UTF-8/ANSI in native (according to CLR marshalling rules - otherwise it can be whatever you want). Simple integer types are blittable. The reason it is named blittable, means that we can simply copy the bits (blit) over and the result is guarantee to be correct by definition, without marshaling/copying field by field.</p>

<p>Let’s look at this example:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>

<span class="na">[StructLayout(LayoutKind.Explicit)]</span>
<span class="k">struct</span> <span class="nc">Foo</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">FieldOffset</span><span class="p">(</span><span class="m">0</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">FieldOffset</span><span class="p">(</span><span class="m">0</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">char</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="nc">NativeFoo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">NativeFoo</span> <span class="n">nativeFoo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NativeFoo</span><span class="p">();</span>
        <span class="n">nativeFoo</span><span class="p">.</span><span class="n">a</span> <span class="p">=</span> <span class="m">0x12345678</span><span class="p">;</span>
        <span class="n">Foo</span> <span class="n">managedFoo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Foo</span><span class="p">();</span>

        <span class="n">managedFoo</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">PtrToStructure</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;(</span><span class="k">new</span> <span class="nf">IntPtr</span><span class="p">(&amp;</span><span class="n">nativeFoo</span><span class="p">));</span> 
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"{0:x}"</span><span class="p">,</span> <span class="n">managedFoo</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>The union in this case is a Foo struct with a int field and char field. We are calling <code class="highlighter-rouge">Marshal.PtrToStructure&lt;Foo&gt;</code> to convert the equivalent structure NativeFoo with a int field <code class="highlighter-rouge">0x12345678</code> to Foo. Can you guess what the result is?</p>

<p>This is what I get on my MBP:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yizhang@yzha-mbp:~/var/union$ dotnet run
12340078
</code></pre></div></div>

<p>Now reverse the two fields:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">[StructLayout(LayoutKind.Explicit)]</span>
<span class="k">struct</span> <span class="nc">Foo2</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">FieldOffset</span><span class="p">(</span><span class="m">0</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">char</span> <span class="n">a</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">FieldOffset</span><span class="p">(</span><span class="m">0</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is what I got:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yizhang@yzha-mbp:~/var/union$ dotnet run
12345678
</code></pre></div></div>

<p>You might wonder: wait a minute, the two Foo are clearly the same thing, and the result should also be the same. Layout-wise, yes. But from CLR interop marshalling point of view, they are quite different. Before we discuss further, I need to bring your attention to the char field. It is a 2-byte UTF-16 char in C#, but by default it is a 1-byte char when we marshal it. When CLR marshals structs, the fields are marshaled one-by-one (duh!). This usually works as expected without surprise, but with overlapping fields that requires additional marshalling, it means the contents of the struct depends on the order of fields!</p>

<p>Let’s look at the two structs again:</p>
<ol>
  <li>Foo - CLR converts integer a first, writes 0x12345678 to the buffer where the struct is located. In intel machines, where least significant byte shows up first, the memory layout is <code class="highlighter-rouge">0x78, 0x56, 0x34, 0x12</code>. CLR then converts the char. The 1-byte char is 0x78 at offset 0. Converting that to a UTF-16 char meaning writing 0x0078, which is <code class="highlighter-rouge">0x78, 0x00</code> to offset 0. Now the memory content becomes: <code class="highlighter-rouge">0x78, 0x00, 0x34, 0x12</code>. Reversing that to get the integer - <code class="highlighter-rouge">0x12340078</code>!</li>
  <li>Foo2 - CLR converts char first, 1-byte 0x78 becomes 0x0078 and therefore 0x78, 0x00. The memory is now <code class="highlighter-rouge">0x78, 0x00, 0x??, 0x??</code> (0x?? means garbage uninitialized bytes). Then CLR writes the entire int 0x12345678 to the buffer, erasing all the work it did in the first field. Now the buffer is the integer value <code class="highlighter-rouge">0x12345678</code>.</li>
</ol>

<p>In short, if you have overlapping fields that requires marshalling, the contents of the field are determined by their order!</p>

<p>Languages like C doesn’t have this problem because they take the union as-is without any conversion, and it is entirely up to the programmer to interpret the value (C++ is perhaps a different story if you try to have unions with C++ class fields with copy constructors and then copy them around…). This is obviously a more hands-off approach, but it works usually as expected when the programmer clearly knows what he/she wants. Unfortunately, C# has no idea what your intention is. One way that this can be improved is to error out if there are overlapping fields requiring marshalling. Unfortunately it is too late to change that now without potentially breaking people accidentally taking dependency on the ordering. Another potential approach is to have a selector construct that allows you to specify which portion of the struct is valid - a good example is perhaps VARIANT. However, the complexity is perhaps not worth it.</p>

<p>If you think unions are too complicated, just stick to simple blittable unions - it’ll make your life much easier.</p>

  
</article>


<hr class="dingbat related" />




  
     


  <aside class="about related mt4 mb4" role="complementary">
    
    

<div class="author mt4">
  

  
    


  <hy-img
    
    src="https://placehold.it/128x128"
    class="avatar"
    alt="<firstname> <lastname>"
    srcset="https://placehold.it/128x128 1x,https://placehold.it/256x256 2x"
    
  
    
    root-margin="512px"
  >
    <noscript><img data-ignore 
    src="https://placehold.it/128x128"
    class="avatar"
    alt="<firstname> <lastname>"
    srcset="https://placehold.it/128x128 1x,https://placehold.it/256x256 2x"
    
  /></noscript>
    <span class="loading" slot="loading" hidden>
      <span class="icon-cog"></span>
    </span>
  </hy-img>


  

  
  
  <h2  class="page-title hr">
    About
  </h2>

  <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit,
sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>

<p>Open <code class="highlighter-rouge">_data/authors.yml</code> to edit this text.</p>

<p><a href="https://github.com/qwtel/hydejack-starter-kit/archive/v8.1.1.zip">Download Free</a>
– or –
<a href="https://app.simplegoods.co/i/NATYVLYT">Buy PRO</a></p>



  <div class="sidebar-social">
    <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://twitter.com/<username>" title="Twitter" class="no-mark-external">
      <span class="icon-twitter"></span>
      <span class="sr-only">Twitter</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/<username>" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
  
</ul>

  </div>
</div>

  </aside>


  

  
  

  
    




<aside class="related mb4" role="complementary">
  <h2 class="hr">Related Posts</h2>

  <ul class="related-posts">
    
      


<li>
  <a href="/dotnet-generics-typeof-t" class="h4 flip-title">
    <span>typeof(TSecret) - the secret magic behind .NET generics</span>
  </a>
  <time class="heading faded fine" datetime="2018-04-09T00:00:00-07:00">09 Apr 2018</time>
</li>

    
      


<li>
  <a href="/ref-counted-handle" class="h4 flip-title">
    <span>Top secret .NET handles - Part 2 - Ref-Counted handles</span>
  </a>
  <time class="heading faded fine" datetime="2018-02-12T00:00:00-08:00">12 Feb 2018</time>
</li>

    
      


<li>
  <a href="/dependent-handle" class="h4 flip-title">
    <span>Top secret .NET handles - Part 1 - Dependent handles</span>
  </a>
  <time class="heading faded fine" datetime="2018-01-24T00:00:00-08:00">24 Jan 2018</time>
</li>

    
  </ul>
</aside>

  


  
<aside class="comments related" role="complementary">
  <h2 class="hr">Comments</h2>
  

<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>!function(w, d) {
  if (d.getElementById("disqus_thread")) {
    if (w.DISQUS) {
      w.DISQUS.reset({
        reload: true,
        config() {
          this.page.url = w.location.href;
          this.page.title = d.title;
        },
      });
    } else {
      w.disqus_config = function disqusConfig() {
        this.page.url = w.location.href;
        this.page.title = d.title;
      };
      w.loadJSDeferred(d.getElementById("_hrefDisqus").href + '/embed.js');
    }
  }
}(window, document);</script>


</aside>


  
<footer role="contentinfo">
  <hr/>
  
    <p><small class="copyright">© 2017. All rights reserved.
</small></p>
  
  
  <p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">8.4.0</span></small></p>
  <hr class="sr-only"/>
</footer>


</main>

    <hy-drawer
  class=""
  align="left"
  threshold="10"
  touch-events
  prevent-default
>
  <header id="_sidebar" class="sidebar" role="banner">
    
    <div class="sidebar-bg sidebar-overlay" style="background-color:#4fb1ba;background-image:url(/assets/img/sidebar-bg.jpg)"></div>

    <div class="sidebar-sticky">
      <div class="sidebar-about">
        
          <a class="no-hover" href="/" tabindex="-1">
            <img src="/assets/icons/icon.png" class="avatar" alt="yizhang82's blog" data-ignore />
          </a>
        
        <h2 class="h1"><a href="/">yizhang82's blog</a></h2>
        
        
          <p class="">
            Languages, Runtime, Data structures, Databases, and everything in between

          </p>
        
      </div>

      <nav class="sidebar-nav heading" role="navigation">
        <span class="sr-only">Navigation:</span>
<ul>
  
    
    
    

    
      
        <li>
          <a
            id="_navigation"
            href="/blog/"
            class="sidebar-nav-item"
            
            >
            Blog archive
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/dotnet/"
            class="sidebar-nav-item"
            
            >
            .NET / .NET Core
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/database/"
            class="sidebar-nav-item"
            
            >
            Database
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/interop/"
            class="sidebar-nav-item"
            
            >
            Interop
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/about/"
            class="sidebar-nav-item"
            
            >
            About me
          </a>
        </li>
      
    
  
</ul>

      </nav>

      

      <div class="sidebar-social">
        <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://twitter.com/<username>" title="Twitter" class="no-mark-external">
      <span class="icon-twitter"></span>
      <span class="sr-only">Twitter</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/<username>" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
  
</ul>

      </div>
    </div>
  </header>
</hy-drawer>
<hr class="sr-only" hidden />

  
</hy-push-state>


  <!--[if !IE]><!---->
  <script>loadJSDeferred(document.getElementById('_hrefJS').href);</script>
  

  <!--<![endif]-->

  
  <script>!function(w, d) {
    w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;

    /**/
      ga('create', 'UA-93224322-1', 'auto');
    /**/

    var pushStateEl = d.getElementsByTagName('hy-push-state')[0];
    var timeoutId;
    pushStateEl.addEventListener('hy-push-state-load', function() {
      w.clearTimeout(timeoutId);
      timeoutId = w.setTimeout(function() {
        ga('set', 'page', w.location.pathname);
        ga('send', 'pageview');
      }, 500);
    });

    d.addEventListener('hy--cookies-ok', function () {
      w.ga(function(tracker) {
        w.ga("set", "anonymizeIp", undefined);
        localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId"));
      });
    });

    w.loadJSDeferred('https://www.google-analytics.com/analytics.js');
  }(window, document);</script>



  <script>
    if ('serviceWorker' in navigator) {
      
        navigator.serviceWorker.getRegistration()
          .then(r => r.unregister())
          .catch(() => {});
      
    }
  </script>






<h2 class="sr-only" hidden>Templates (for web app):</h2>

<template id="_animation-template" hidden>
  <div class="animation-main fixed-top">
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

<template id="_loading-template" hidden>
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

<template id="_error-template" hidden>
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

<template id="_back-template" hidden>
  <a id="_back" class="back nav-btn fl no-hover">
    <span class="sr-only">Back</span>
    <span class="icon-arrow-left2"></span>
  </a>
</template>

<template id="_permalink-template" hidden>
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="icon-link"></span>
  </a>
</template>




</body>
</html>
