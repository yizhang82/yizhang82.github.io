<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v8.4.0 <https://hydejack.com/>
-->











<head>
  



<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">




  
<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Home | yizhang82’s blog</title>
<meta property="og:title" content="Home" />
<meta name="author" content="Yi Zhang" />
<meta property="og:locale" content="en" />
<meta name="description" content="The official Hydejack blog. Version updates, example content and how-to guides on how to blog with Jekyll. Open index.html to edit this text." />
<meta property="og:description" content="The official Hydejack blog. Version updates, example content and how-to guides on how to blog with Jekyll. Open index.html to edit this text." />
<link rel="canonical" href="http://localhost:4000/page-2/" />
<meta property="og:url" content="http://localhost:4000/page-2/" />
<meta property="og:site_name" content="yizhang82’s blog" />
<link rel="prev" href="http://localhost:4000/">
<link rel="next" href="http://localhost:4000/page-3/">
<script type="application/ld+json">
{"url":"http://localhost:4000/page-2/","headline":"Home","dateModified":null,"datePublished":null,"sameAs":null,"image":null,"mainEntityOfPage":null,"name":null,"author":{"@type":"Person","name":"Yi Zhang"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icons/icon.png"},"name":"Yi Zhang"},"description":"The official Hydejack blog. Version updates, example content and how-to guides on how to blog with Jekyll. Open index.html to edit this text.","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  


<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="yizhang82's blog">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<meta name="application-name" content="yizhang82's blog">
<meta name="msapplication-config" content="/assets/ieconfig.xml">


<meta name="theme-color" content="#193747">


<meta name="generator" content="Hydejack v8.4.0" />

<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="yizhang82's blog" />



<link rel="alternate" href="http://localhost:4000/page-2/" hreflang="en">

<link rel="shortcut icon" href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon.png">

<link rel="manifest" href="/assets/manifest.json">


  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">


  <link rel="dns-prefetch" href="https://www.google-analytics.com">



<link rel="dns-prefetch" href="/" id="_baseURL">
<link rel="dns-prefetch" href="/assets/js/hydejack-8.4.0.js" id="_hrefJS">
<link rel="dns-prefetch" href="/sw.js" id="_hrefSW">
<link rel="dns-prefetch" href="/assets/bower_components/fontfaceobserver/fontfaceobserver.standalone.js" id="_hrefFFO">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js" id="_hrefKatexJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_hrefKatexCSS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.js" id="_hrefKatexCopyJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.css" id="_hrefKatexCopyCSS">
<link rel="dns-prefetch" href="/assets/img/swipe.svg" id="_hrefSwipeSVG">



<link rel="dns-prefetch" href="https://yizhang82.disqus.com" id="_hrefDisqus">


<script>!function(e,t){"use strict";function n(e,t,n,r){e.addEventListener?e.addEventListener(t,n,r):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,r){var o=t.createElement("script");o.src=e,r&&n(o,"load",r,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(o,a),o},e._loaded=!1,e.loadJSDeferred=function(r,o){function a(){e._loaded=!0,o&&n(d,"load",o,{once:!0});var r=t.scripts[0];r.parentNode.insertBefore(d,r)}var d=t.createElement("script");return d.src=r,e._loaded?a():n(e,"load",a,{once:!0}),d},e.setRel=e.setRelStylesheet=function(e){function n(){this.rel="stylesheet"}var r=t.getElementById(e);r.addEventListener?r.addEventListener("load",n,{once:!0}):r.onload=n}}(window,document);
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
</script>

<script>!function(w, d) {
    w._noPushState = false;
    w._noDrawer = false;

    /**/
    loadJS(d.getElementById('_hrefFFO').href, function() {
      if ('Promise' in w) Promise.all([
        new FontFaceObserver('Noto Sans').load(),
        new FontFaceObserver('Roboto Slab').load(),
      ]).then(function f() { d.body.classList.add('font-active'); }, function() {});
    });
    /**/
}(window, document);</script>

<!--[if gt IE 8]><!---->








  <link rel="stylesheet" href="/assets/css/hydejack-8.4.0.css">
  <link rel="stylesheet" href="/assets/icomoon/style.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Noto+Sans:400,400i,700,700i">
    <noscript>
      <style>
        html { font-family: Noto Sans, Helvetica, Arial, sans-serif!important; }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Roboto Slab, Helvetica, Arial, sans-serif!important; }
      </style>
    </noscript>
  


  <style id="_pageStyle">

.content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba !important}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus,.form-control:focus,.form-control.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}

</style>


<!--<![endif]-->




</head>

<body>
  <div id="_navbar" class="navbar fixed-top">
  <div class="content">
    <div class="nav-btn-bar">
      <span class="sr-only">Jump to:</span>
      <a id="_menu" class="nav-btn no-hover fl" href="#_navigation">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>
    </div>
  </div>
</div>
<hr class="sr-only" hidden />


<hy-push-state
  replace-ids="_main"
  link-selector="a[href]:not([href*='/assets/']):not(.external):not(.no-push-state)"
  duration="250"
  script-selector="script:not([type^='math/tex'])"
  prefetch
>
  
    <hy-drawer
  class="cover"
  align="left"
  threshold="10"
  touch-events
  prevent-default
>
  <header id="_sidebar" class="sidebar" role="banner">
    
    <div class="sidebar-bg sidebar-overlay" style="background-color:#4fb1ba;background-image:url(/assets/img/sidebar-bg.jpg)"></div>

    <div class="sidebar-sticky">
      <div class="sidebar-about">
        
          <a class="no-hover" href="/" tabindex="-1">
            <img src="/assets/icons/icon.png" class="avatar" alt="yizhang82's blog" data-ignore />
          </a>
        
        <h2 class="h1"><a href="/">yizhang82's blog</a></h2>
        
        
          <p class="">
            Languages, Runtime, Data structures, Databases, and everything in between

          </p>
        
      </div>

      <nav class="sidebar-nav heading" role="navigation">
        <span class="sr-only">Navigation:</span>
<ul>
  
    
    
    

    
      
        <li>
          <a
            id="_navigation"
            href="/blog/"
            class="sidebar-nav-item"
            
            >
            Blog archive
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/dotnet/"
            class="sidebar-nav-item"
            
            >
            .NET / .NET Core
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/database/"
            class="sidebar-nav-item"
            
            >
            Database
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/interop/"
            class="sidebar-nav-item"
            
            >
            Interop
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/about/"
            class="sidebar-nav-item"
            
            >
            About me
          </a>
        </li>
      
    
  
</ul>

      </nav>

      

      <div class="sidebar-social">
        <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://twitter.com/<username>" title="Twitter" class="no-mark-external">
      <span class="icon-twitter"></span>
      <span class="sr-only">Twitter</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/<username>" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
  
</ul>

      </div>
    </div>
  </header>
</hy-drawer>
<hr class="sr-only" hidden />

    <main
  id="_main"
  class="content fade-in layout-blog"
  role="main"
  data-color="#4fb1ba"
  data-theme-color="#193747"
  
    data-image="/assets/img/sidebar-bg.jpg"
    data-overlay
  
  >
  


  
    




<article id="post-sorting-structured-data-1" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/sorting-structured-data-1" class="flip-title">
        Sorting structured data in a unstructured way using memcmp-friendly encoding
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2019-02-17T00:00:00-08:00">17 Feb 2019</time>
      
      
      
      
      









in <span>Storage</span> / <a href="/category/database/" class="flip-title">Database</a> / <span>C++</span> / <span>Algorithm</span> / <span>Design</span>

      











    </p>

    
    

    



  
    <p class="message" >
      Sorting structured data in a unstructed way using memcmp-friendly encoding part 1

    </p>
  


  </header>

  
    <p>In many interesting data storage applications, one often need to sort the data in order to do efficient searching - it is such a fundamental operation. The data is often structured like in databases (or it is using a database under the hood) - the application knows exactly what the data is - for example, a record/row with an integer field, a string field, as well as datetime field, etc. In those cases, you can easily sort these data by interpreting the data as what it is, and then comparing them one by one. This is usually achieved by having a base class with virtual functions, and having several derived class implementing the comparison function as well as determine the length to move the next one:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Data</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="kt">int</span> <span class="n">Compare</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">left</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">right</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">int</span> <span class="n">GetLength</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">class</span> <span class="nc">UInt32_Data</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Data</span> <span class="p">{</span> <span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="kt">int</span> <span class="n">Compare</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">left</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">right</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">left_int</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">right_int</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">left_int</span> <span class="o">&lt;</span> <span class="n">right_int</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">left_int</span> <span class="o">==</span> <span class="n">right_int</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="kt">int</span> <span class="n">GetLength</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// No need to read data - uint32_t is always fixed size
</span>    <span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>

<p>You can merge these two function into one - for better efficiency. For clarity I’m keeping them separate.</p>

<p>Besides virtual functions, you can also implement this with a jump table that points to a list of functions, or even a switch / case, etc. They are not that fundamentally different - all of them can involve having a table of address to call/jump to, and use a memory lookup to determine the target address.</p>

<p>However, the additional cost of invoking the right comparing functions isn’t zero - as a matter fact it is quite significant comparing to the actual comparison function itself in the case of a virtual function call, which involves putting arguments into registry/stack, pushing return address into stack, setting up frame pointer, etc.</p>

<p>If you are an experienced system programmer, you might know tricks to optimize this further. For example, given this is the exact same problem as an interpreter, and people like interpreter to be fast, VM like Dalvik employed <a href="http://wing-linux.sourceforge.net/online-pdk/guide/dalvik.html#dalvikInterpreter">advanced techniques</a> like writing the code in assembly, using <em>threaded execution</em> (which is a fancy way of saying the end of interpreter loop decodes the next instruction instead of jumping to the beginning), and using computing address instead of jump table. These are interesting topics that I might talk about at some point in the future. Anyway, those are not easy to implement and maintain.</p>

<p>But are there other ways to get around this? Is there a way to compare this without understanding what the data is?</p>

<p>The most straight-forward comparison is a byte comparison or <code class="highlighter-rouge">memcmp</code>, and this is the most universal way to compare two byte sequences. Many key/value stores (like levelDB/RocksDB) only support byte comparison and allow you to plugin a custom comparator. But before you go ahead and try to implement the custom comparator, let’s give one idea a try: what if we can represent the data somehow as a byte-comparison friendly format?</p>

<p>The challenge are two fold:</p>
<ol>
  <li>Encoding the data so that byte order is the correct sorting order</li>
  <li>Support variable length data properly so that you don’t accidentally compare unrelated data</li>
</ol>

<h2 id="unsigned-32-bit-integer">Unsigned 32-bit integer</h2>

<p>Let’s start with something most straight-forward: a 32-bit unsigned integer. Assume you are working on a Intel machine just like everybody else (and not something esoteric like SPARC) - those unsigned 32-bit integers are represented as <a href="https://en.wikipedia.org/wiki/Endianness">little-endian</a>, which means least significant byte will be in memory before the most significant ones. So <code class="highlighter-rouge">0x12345678</code> will be represented in memory as:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x78, 0x56, 0x34, 0x12
</code></pre></div></div>

<p>Obviously this isn’t what we want - we need the compare the most significant byte first, which is exactly <em>Big-Endian</em>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x12, 0x34, 0x56, 0x78
</code></pre></div></div>

<p>Now it’s safe to do a <code class="highlighter-rouge">memcmp</code> them now - the bytes are in most-significant to least significant order, and the length is fixed 4-bytes.</p>

<p>Now those SPARC CPU looks pretty sweet, right?</p>

<h2 id="signed-32-bit">Signed 32-bit</h2>

<p>Let’s make this a bit more interesting. What if the integer is signed?</p>

<p>For signed 32-bit, the range is <code class="highlighter-rouge">-2147483648</code> to <code class="highlighter-rouge">+2147483647</code>. There are two cases:</p>
<ol>
  <li>Negative: <code class="highlighter-rouge">-214783648</code> (<code class="highlighter-rouge">0x10000000</code>) to <code class="highlighter-rouge">-1</code> (<code class="highlighter-rouge">0xffffffff</code>),</li>
  <li>Non-Negative: <code class="highlighter-rouge">0</code> (<code class="highlighter-rouge">0x00000000</code>) to <code class="highlighter-rouge">+2147483647</code> (<code class="highlighter-rouge">0x7fffffff</code>)</li>
</ol>

<p>The non-negative case looks alright - just like the unsigned 32-bit integer case, as long as they are converted to Big-Endian.</p>

<p>For the negative case, the order is correct: <code class="highlighter-rouge">-214783648</code> (<code class="highlighter-rouge">0x10000000</code>), <code class="highlighter-rouge">-214783647</code> (<code class="highlighter-rouge">0x10000001</code>), … (<code class="highlighter-rouge">0xffffffff</code>), except the most significant bit is always one, which makes it bigger than the non-negative case. It is not hard to come up with a fix - just flip the sign bit. Now it becomes:</p>
<ol>
  <li>Non-Negative: <code class="highlighter-rouge">-214783648</code> (<code class="highlighter-rouge">0x00000000</code>) to <code class="highlighter-rouge">-1</code> (<code class="highlighter-rouge">0x7fffffff</code>),</li>
  <li>Negative: <code class="highlighter-rouge">0</code> (<code class="highlighter-rouge">0x80000000</code>) to <code class="highlighter-rouge">+2147483647</code> (<code class="highlighter-rouge">0xffffffff</code>)</li>
</ol>

<p>Now this looks really nice, and these two ranges are now in the right order, and -1 (0x7ffffffff)+1 = 0 (0x80000000). Now the universe is balanced.</p>

<h2 id="8-bit-ascii-strings">8-bit ASCII Strings</h2>

<p>For strings, let’s again start with the easy case - 8-bit ASCII strings (we’ll refer it to ASCII string from now on, just for simplicity). For a fixed length ASCII string, it’s really easy - memcmp just works. But how about variable length ASCII?</p>

<p>In such case, the real problem happens when you have string A and B and A is a prefix of B:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A: A, A, A, A, A, A
B: A, A, A, A, A, A, B, B, B
</code></pre></div></div>

<p>What if just after A there is other data:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A: A, A, A, A, A, A, 0x43
B: A, A, A, A, A, A, B, B 
</code></pre></div></div>

<p>In this case, 0x43 = ‘C’ which is bigger than B, even though A string is smaller than B. Oops.</p>

<p>The key to the problem is that you have to compare the two strings by themselves - you can’t compare other unrelated data by accident (which is our challenge #2, earlier, if you paid attention). You could pad the strings so that they are equal, if you know the maximum length ahead of time (for example, in SQL VARCHAR has max length), but that can be a waste of space.</p>

<p>If you dig deeper, one interesting insight is that if you can have a magic special character that is always guarantee to be smaller than any valid contents in the other string before it ends, then it’ll just work. In many cases, we had no such luxury as strings may have embedded NULLs. But that does provide some additional hint: what if we can artifically inject such marker into the string such that the one that is longer has a bigger byte marker?</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A: A, A, A, A, A, A, 0x0
B: A, A, A, A, A, A, 0x1, B, B, B, 0x0
</code></pre></div></div>

<p>In the above case, A ends with 0x0, while B injects 0x1 as 7th char, making sure it is bigger than A when A ends. Note that 0x1 in this case means there are more data after this, so the encoder/decoder need to take that into account. This looks nice, but we do need to make sure the markers are always at the same place. In order to do that, we can pad/break the strings to split them into predictable fixed length parts with a marker at the last byte. Let’s say if we break it apart at 6 characters, it’ll be exactly like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A: A, A, A, A, A, A, 0x0
B: A, A, A, A, A, A, 0x1, B, B, B, 0x0, 0x0, 0x0, 0x0
</code></pre></div></div>

<p>Note the 4 0x0 (‘ ‘) padding in between, making sure we break the strings every 6 characters. Now, any experienced programmer will tell you that you should always ends things at power of 2 (so that it works better with cache, alignment, etc), so 8/16/32/… would be obviously a better choice. For now let’s go with 8 just to make it easier:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A: A, A, A, A, A, A, 0x0, 0x0
B: A, A, A, A, A, A,   A, 0x1, B, B, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0
</code></pre></div></div>

<p>A bit wasteful, but much better than storing the entire string padded to max length. Also, keep in mind that this encoding supports storing NULL characters as the 0 at every 8th character has special meaning.</p>

<p>But we are not done yet. Do you see there is one more problem?</p>

<p>We are padding the strings with 0x0, and now the strings have some unwanted 0x0 characters padded which we are not able to distingush with actual spaces. Fortunately we still have plenty of run away with the encoding, we can put 1~8 there to indicate number of real characaters (not the padding):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A: A, A, A, A, A, A, 0x0, 0x0
B: A, A, A, A, A, A,   A, 0x2, B, B, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0
</code></pre></div></div>

<p>But this isn’t quite right yet, this can easily get broken (thanks for <a href="https://disqus.com/by/disqus_EhHho2AGRq/">Thief</a> pointing it out) as the marker themselves get into comparison:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A: A, A, A, A, A, A, A, 0x3, A, A,   A, 0x0, 0x0, 0x0, 0x0, 0x0
B: A, A, A, A, A, A, A, 0x2, B, B, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0
</code></pre></div></div>

<p>To fix this, instead of signaling the number of characters in next segment, it can represent the number of characters in the current segment:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A: A, A, A, A, A, A, A, 0x7, A, A, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2
B: A, A, A, A, A, A, A, 0x7, A, A,   B, 0x0, 0x0, 0x0, 0x0, 0x3
</code></pre></div></div>

<p>For non-NULL characters, it’ll work as any other character will be bigger. For embedded NULL characters, either the last non-NULL character would help:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A: A, A, A, A, A, A, A, 0x7, A, A, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2
B: A, A, A, A, A, A, A, 0x7, A, A, 0x0,   A, 0x0, 0x0, 0x0, 0x4
</code></pre></div></div>

<p>Or for pure NULL padding case, the last 0x2/0x4 will help disambuigate any difference.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A: A, A, A, A, A, A, A, 0x7, A, A, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2
B: A, A, A, A, A, A, A, 0x7, A, A, 0x0, 0x0, 0x0, 0x0, 0x0, 0x4
</code></pre></div></div>

<p>This is still not quite perfect, though. If a string happens to end at N boundary:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A, A, A, A, A, A, A, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0
</code></pre></div></div>

<p>The final N bytes are wasted just to provide the indicator. The fix is simple: instead of N - 1 indicating more characters, we can have two cases:</p>
<ol>
  <li>N - 1 : the segment is full and there are no more characters</li>
  <li>N : the segment is full and there are more characters</li>
</ol>

<p>To illustrate this idea:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A, A, A, A, A,   A,   A, 0x8, B, B, B, 0x0, 0x0, 0x0, 0x0, 0x3
A, A, A, A, A,   A,   A, 0x7 
A, A, A, A, A, 0x0, 0x0, 0x5  
</code></pre></div></div>

<p>In summary, we break down the string in the chunk of 8/16/32/… characters and using the every Nth character a special marker that indicates:</p>
<ol>
  <li>1 ~ N - 1 : the number of characters in the current segment. The rest is 0x0 padding.</li>
  <li>N : the current segment is full and there are more characters</li>
</ol>

<h2 id="what-about-non-ascii-strings">What about non-ASCII strings?</h2>

<p>We can always convert it into a case that we know about - if we can convert such string into UTF-8, which works great in byte comparison even in the case of multi-byte characters. If you haven’t looked at it yet, you should. It’s brilliant, and everyone should be talking in UTF-8 (I’m looking at you, Windows). Just go to https://en.wikipedia.org/wiki/UTF-8.</p>

<h2 id="what-about-sort-ordering-and-collation">What about sort ordering and collation?</h2>

<p>Those cases can get really complicated depends on the encoding + collation so I won’t get into them. But the idea is always the same: transform the bytes into the correct sorting order as dicated by the character set/encoding. If the encoding byte order happens to be the right sorting order (UTF-8, for example), all the better.</p>

<p>If you are interested you might want to give your favorite encoding a try.</p>

<h2 id="we-are-not-done-yet">We are not done yet</h2>

<p>In this post I’ve discussed approaches to encode your data in a way that is sort friendly. In cases where there are lot of read/seek/lookup, it can make a really huge difference in terms of lookup performance, but in write heavy environments it may not be the right trade-off as the overhead of the encoding become bigger and the caching to offset the decoding cost become less effective. At the end of the day, there is no silver bullet and you need to pick the right solution for your scenario at hand.</p>

<p>However, we are not quite done yet. There is one more interesting scenario we can look at: floats. This is a non-trivial topic as we need to dive into the binary format of floats/doubles. Hope I’ll see you next time!</p>

<blockquote>
  <p>EDIT NOTE:
This article has been updated to address some bugs in the examples and in the encoding. Thanks everyone for the suggestion/corrections!</p>
</blockquote>


    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/sorting-structured-data-1">Sorting structured data in a unstructured way using memcmp-friendly encoding</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-process-startinfo" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/process-startinfo" class="flip-title">
        The tale of InvalidOperationException
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2018-07-12T00:00:00-07:00">12 Jul 2018</time>
      
      
      
      
      









in <span>Dotnetcore</span> / <a href="/category/dotnet/" class="flip-title">.NET / .NET Core</a> / <span>Csharp</span> / <span>Api</span> / <span>Design</span> / <span>Investigation</span>

      











    </p>

    
    

    



  <div class="hr pb0"></div>


  </header>

  
    <h2 id="the-tale-of-invalidoperationexception">The tale of InvalidOperationException</h2>

<p>This came up when I was helping someone looking into a strange issue. Recently some process dump capture tool started throwing InvalidOperationException:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Unhandled Exception: System.InvalidOperationException: Process was not started by this object, so requested information cannot be determined.
   at System.Diagnostics.Process.get_StartInfo()
   at SomeTestUtility.WaitForSomeProcessToExit()
</code></pre></div></div>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/process-startinfo">The tale of InvalidOperationException</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-isolation-level" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/db-isolation-level" class="flip-title">
        Summary of database isolation levels
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2018-04-14T00:00:00-07:00">14 Apr 2018</time>
      
      
      
      
      









in <a href="/category/database/" class="flip-title">Database</a> / <span>Concurrency</span> / <span>Lock</span> / <span>Transaction</span>

      











    </p>

    
    

    



  
    <p class="message" >
      Summary of different database isolation levels

    </p>
  


  </header>

  
    <p>I’ve been always a bit confused about different isolation levels on databases. So I spent a bit of time going through them and summarize it in a post. This is both for myself and also hopefully will help others looking for similar information as well.</p>

<p>In this post we’ll talk about:</p>

<ul>
  <li>Meaning of different isolation levels - read committed, repeatable reads, snapshot isolation, serializable</li>
  <li>How they use locks inside transactions</li>
  <li>How they affect performance</li>
</ul>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/db-isolation-level">Summary of database isolation levels</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-dotnet-generics-typeof" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/dotnet-generics-typeof-t" class="flip-title">
        typeof(TSecret) - the secret magic behind .NET generics
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2018-04-09T00:00:00-07:00">09 Apr 2018</time>
      
      
      
      
      









in <span>C#</span> / <span>Clr</span> / <span>Netcore</span> / <span>Typesystem</span> / <span>Generics</span> / <a href="/category/dotnet/" class="flip-title">.NET / .NET Core</a>

      











    </p>

    
    

    



  
    <p class="message" >
      How typeof(T) works in .NET generics

    </p>
  


  </header>

  
    <h2 id="typeoftsecret---the-secret-magic-behind-net-generics">typeof(TSecret) - the secret magic behind .NET generics</h2>

<p>In <a href="http://yizhang82.me/dotnet-generics-sharing">last post</a> we’ve talked about how .NET does code sharing for reference types. This time let’s take a look at how <code class="highlighter-rouge">typeof(T)</code> does its black magic.</p>

<p>In particular, how does the code knows what <code class="highlighter-rouge">typeof(T)</code> is, in the presence of code sharing?</p>

<p>Obviously if there is no code sharing at all, each method instantiation are different and the code would be instantiated with the correct <code class="highlighter-rouge">typeof(T)</code> code where T is a real type, it obviously would “just work”.</p>

<p>Before we dive into the implementation, let’s take a first crack at this problem and see what are the challenges.</p>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/dotnet-generics-typeof-t">typeof(TSecret) - the secret magic behind .NET generics</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-go-and-async-await" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/go-and-async-await" class="flip-title">
        Does Go need async/await?
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2018-04-02T00:00:00-07:00">02 Apr 2018</time>
      
      
      
      
      









in <span>Async</span> / <span>Go</span> / <span>Concurrency</span>

      











    </p>

    
    

    



  
    <p class="message" >
      Does the go language need async/await support?

    </p>
  


  </header>

  
    <p>Recently I’ve been spending a bit of time playing with Go language. Coming from a C++ and C# background, I’ve been wondering what does C# async await (C++ coroutines, or node.js await/promise - pick your choice), would look like in Go.</p>

<p>It turns out go does not need async/await - every thing can be synchronous by default.</p>

<p>Let me explain why I arrived at this conclusion.</p>

<p>But before that, let’s take a look at why we need the async/await in the first place.</p>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/go-and-async-await">Does Go need async/await?</a>

      </p>
    </footer>
  
</article>

  

  <h2 class="sr-only">Pagination</h2>
<nav class="pagination heading clearfix" role="navigation">
  <ul>
    <li class="pagination-item older" >
      
      
      
  <a
    class=" "
    href="/page-3/"
    rel="next"
    
  >
    Older
  </a>


    </li>
    <li class="pagination-item newer" >
      
      
      
  <a
    class=" "
    href="/"
    rel="prev"
    
  >
    Newer
  </a>


    </li>
  </ul>
</nav>



  

  
<footer role="contentinfo">
  <hr/>
  
    <p><small class="copyright">© 2017. All rights reserved.
</small></p>
  
  
  <p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">8.4.0</span></small></p>
  <hr class="sr-only"/>
</footer>


</main>

  
</hy-push-state>


  <!--[if !IE]><!---->
  <script>loadJSDeferred(document.getElementById('_hrefJS').href);</script>
  

  <!--<![endif]-->

  
  <script>!function(w, d) {
    w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;

    /**/
      ga('create', 'UA-93224322-1', 'auto');
    /**/

    var pushStateEl = d.getElementsByTagName('hy-push-state')[0];
    var timeoutId;
    pushStateEl.addEventListener('hy-push-state-load', function() {
      w.clearTimeout(timeoutId);
      timeoutId = w.setTimeout(function() {
        ga('set', 'page', w.location.pathname);
        ga('send', 'pageview');
      }, 500);
    });

    d.addEventListener('hy--cookies-ok', function () {
      w.ga(function(tracker) {
        w.ga("set", "anonymizeIp", undefined);
        localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId"));
      });
    });

    w.loadJSDeferred('https://www.google-analytics.com/analytics.js');
  }(window, document);</script>



  <script>
    if ('serviceWorker' in navigator) {
      
        navigator.serviceWorker.getRegistration()
          .then(r => r.unregister())
          .catch(() => {});
      
    }
  </script>






<h2 class="sr-only" hidden>Templates (for web app):</h2>

<template id="_animation-template" hidden>
  <div class="animation-main fixed-top">
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

<template id="_loading-template" hidden>
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

<template id="_error-template" hidden>
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

<template id="_back-template" hidden>
  <a id="_back" class="back nav-btn fl no-hover">
    <span class="sr-only">Back</span>
    <span class="icon-arrow-left2"></span>
  </a>
</template>

<template id="_permalink-template" hidden>
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="icon-link"></span>
  </a>
</template>




</body>
</html>
