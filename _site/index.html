<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v8.4.0 <https://hydejack.com/>
-->











<head>
  



<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">




  
<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Home | yizhang82’s blog</title>
<meta property="og:title" content="Home" />
<meta name="author" content="Yi Zhang" />
<meta property="og:locale" content="en" />
<meta name="description" content="The official Hydejack blog. Version updates, example content and how-to guides on how to blog with Jekyll. Open index.html to edit this text." />
<meta property="og:description" content="The official Hydejack blog. Version updates, example content and how-to guides on how to blog with Jekyll. Open index.html to edit this text." />
<link rel="canonical" href="http://localhost:4000/" />
<meta property="og:url" content="http://localhost:4000/" />
<meta property="og:site_name" content="yizhang82’s blog" />
<link rel="next" href="http://localhost:4000/page-2/">
<script type="application/ld+json">
{"url":"http://localhost:4000/","headline":"Home","dateModified":null,"datePublished":null,"sameAs":["https://twitter.com/yizhang82","https://github.com/yizhang82"],"image":null,"mainEntityOfPage":null,"name":"Yi Zhang","author":{"@type":"Person","name":"Yi Zhang"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icons/icon.png"},"name":"Yi Zhang"},"description":"The official Hydejack blog. Version updates, example content and how-to guides on how to blog with Jekyll. Open index.html to edit this text.","@type":"WebSite","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  


<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="yizhang82's blog">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<meta name="application-name" content="yizhang82's blog">
<meta name="msapplication-config" content="/assets/ieconfig.xml">


<meta name="theme-color" content="#193747">


<meta name="generator" content="Hydejack v8.4.0" />

<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="yizhang82's blog" />



<link rel="alternate" href="http://localhost:4000/" hreflang="en">

<link rel="shortcut icon" href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon.png">

<link rel="manifest" href="/assets/manifest.json">


  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">


  <link rel="dns-prefetch" href="https://www.google-analytics.com">



<link rel="dns-prefetch" href="/" id="_baseURL">
<link rel="dns-prefetch" href="/assets/js/hydejack-8.4.0.js" id="_hrefJS">
<link rel="dns-prefetch" href="/sw.js" id="_hrefSW">
<link rel="dns-prefetch" href="/assets/bower_components/fontfaceobserver/fontfaceobserver.standalone.js" id="_hrefFFO">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js" id="_hrefKatexJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_hrefKatexCSS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.js" id="_hrefKatexCopyJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.css" id="_hrefKatexCopyCSS">
<link rel="dns-prefetch" href="/assets/img/swipe.svg" id="_hrefSwipeSVG">



<link rel="dns-prefetch" href="https://yizhang82.disqus.com" id="_hrefDisqus">


<script>!function(e,t){"use strict";function n(e,t,n,r){e.addEventListener?e.addEventListener(t,n,r):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,r){var o=t.createElement("script");o.src=e,r&&n(o,"load",r,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(o,a),o},e._loaded=!1,e.loadJSDeferred=function(r,o){function a(){e._loaded=!0,o&&n(d,"load",o,{once:!0});var r=t.scripts[0];r.parentNode.insertBefore(d,r)}var d=t.createElement("script");return d.src=r,e._loaded?a():n(e,"load",a,{once:!0}),d},e.setRel=e.setRelStylesheet=function(e){function n(){this.rel="stylesheet"}var r=t.getElementById(e);r.addEventListener?r.addEventListener("load",n,{once:!0}):r.onload=n}}(window,document);
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
</script>

<script>!function(w, d) {
    w._noPushState = false;
    w._noDrawer = false;

    /**/
    loadJS(d.getElementById('_hrefFFO').href, function() {
      if ('Promise' in w) Promise.all([
        new FontFaceObserver('Noto Sans').load(),
        new FontFaceObserver('Roboto Slab').load(),
      ]).then(function f() { d.body.classList.add('font-active'); }, function() {});
    });
    /**/
}(window, document);</script>

<!--[if gt IE 8]><!---->








  <link rel="stylesheet" href="/assets/css/hydejack-8.4.0.css">
  <link rel="stylesheet" href="/assets/icomoon/style.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Noto+Sans:400,400i,700,700i">
    <noscript>
      <style>
        html { font-family: Noto Sans, Helvetica, Arial, sans-serif!important; }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Roboto Slab, Helvetica, Arial, sans-serif!important; }
      </style>
    </noscript>
  


  <style id="_pageStyle">

.content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba !important}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus,.form-control:focus,.form-control.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}

</style>


<!--<![endif]-->




</head>

<body>
  <div id="_navbar" class="navbar fixed-top">
  <div class="content">
    <div class="nav-btn-bar">
      <span class="sr-only">Jump to:</span>
      <a id="_menu" class="nav-btn no-hover fl" href="#_navigation">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>
    </div>
  </div>
</div>
<hr class="sr-only" hidden />


<hy-push-state
  replace-ids="_main"
  link-selector="a[href]:not([href*='/assets/']):not(.external):not(.no-push-state)"
  duration="250"
  script-selector="script:not([type^='math/tex'])"
  prefetch
>
  
    <hy-drawer
  class="cover"
  align="left"
  threshold="10"
  touch-events
  prevent-default
>
  <header id="_sidebar" class="sidebar" role="banner">
    
    <div class="sidebar-bg sidebar-overlay" style="background-color:#4fb1ba;background-image:url(/assets/img/sidebar-bg.jpg)"></div>

    <div class="sidebar-sticky">
      <div class="sidebar-about">
        
          <a class="no-hover" href="/" tabindex="-1">
            <img src="/assets/icons/icon.png" class="avatar" alt="yizhang82's blog" data-ignore />
          </a>
        
        <h2 class="h1"><a href="/">yizhang82's blog</a></h2>
        
        
          <p class="">
            Languages, Runtime, Data structures, Databases, and everything in between

          </p>
        
      </div>

      <nav class="sidebar-nav heading" role="navigation">
        <span class="sr-only">Navigation:</span>
<ul>
  
    
    
    

    
      
        <li>
          <a
            id="_navigation"
            href="/blog/"
            class="sidebar-nav-item"
            
            >
            Blog archive
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/dotnet/"
            class="sidebar-nav-item"
            
            >
            .NET / .NET Core
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/database/"
            class="sidebar-nav-item"
            
            >
            Database
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/interop/"
            class="sidebar-nav-item"
            
            >
            Interop
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/about/"
            class="sidebar-nav-item"
            
            >
            About me
          </a>
        </li>
      
    
  
</ul>

      </nav>

      

      <div class="sidebar-social">
        <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://twitter.com/<username>" title="Twitter" class="no-mark-external">
      <span class="icon-twitter"></span>
      <span class="sr-only">Twitter</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/<username>" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
  
</ul>

      </div>
    </div>
  </header>
</hy-drawer>
<hr class="sr-only" hidden />

    <main
  id="_main"
  class="content fade-in layout-blog"
  role="main"
  data-color="#4fb1ba"
  data-theme-color="#193747"
  
    data-image="/assets/img/sidebar-bg.jpg"
    data-overlay
  
  >
  


  
    




<article id="post-innodb-repeatable-reads" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/innodb-repeatable-read" class="flip-title">
        Repeatable reads in InnoDB comes with a catch
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2019-05-05T00:00:00-07:00">05 May 2019</time>
      
      
      
      
      









in <a href="/category/database/" class="flip-title">Database</a> / <span>Innodb</span> / <span>Transaction</span> / <span>Threading</span>

      











    </p>

    
    

    



  <div class="hr pb0"></div>


  </header>

  
    <p>A few days ago I was looking into a deadlock issue that is caused by a behavioral difference between MySQL storage engine transaction behavior in repeatable reads. This leads me to dig deeper into repeatable read behavior in InnoDB and what I found is quite interesting:</p>

<h2 id="the-basics">The basics</h2>

<p>Before we dig deeper, let’s revisit some of the basics of database isolation levels. You can refer to my <a href="https://yizhang82.dev/db-isolation-level">earlier post</a> for a more detailed explanation / comparison. Database isolation level defines the behavior of data read/write operations within transactions, and those can have a signficant impact to protecting the data integrity of your application. <em>Repeatable reads</em> guaratees that you would always observe the same value once you read it, and it would never change unless you’ve made the change yourself, giving you the illusion that it is exclusively owned by you and there is no one else. Of course, this isn’t true in practice as there are pessimistic locking and optimistic locking that defines the behavior when write conflict occurs.</p>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/innodb-repeatable-read">Repeatable reads in InnoDB comes with a catch</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-mysql-connect-error" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/mysql-client-connect-error" class="flip-title">
        Diagnosing interesting MySQL client connection error in localhost through the source code
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2019-04-18T00:00:00-07:00">18 Apr 2019</time>
      
      
      
      
      









in <span>Mysql</span> / <a href="/category/database/" class="flip-title">Database</a>

      











    </p>

    
    

    



  
    <p class="message" >
      The art of argument parsing and policy transparency

    </p>
  


  </header>

  
    <p>When working with MySQL the often most frustrating part is getting strange connection errors. I’ve wasted two hours trying to connect to a MySQL server using TCP port (unix domain sockets works fine) and I’ll talk about why it didn’t work, and as usual we’ll dive into the code to understand exactly why.</p>

<p>To simplify the problem, let’s say I have MySQL server at port 13010 and bound to localhost, with user name root and empty password (don’t do that in production):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[~/mysql]: mysql -p 13010 -h localhost -u root
Enter password:
ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' (2)
</code></pre></div></div>

<p>This is typical error many people will run into and you can find many similar posts that discuss the problem but few ever got to the bottom of it. Let’s jump right in.</p>

<h2 id="-p-and--p">-p and -P</h2>

<p>Obviously when I write <code class="highlighter-rouge">-p 13010</code> I meant to tell <code class="highlighter-rouge">mysql</code> client to connect to server using port 13010, but that’s not quite right:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[~/mysql]: mysql --help
  -p, --password[=name]
                      Password to use when connecting to server. If password is
  -P, --port=#        Port number to use for connection or 0 for default
</code></pre></div></div>

<p>So I actually told mysql the password is 13010 instead. Supporting both <code class="highlighter-rouge">-p</code> and <code class="highlighter-rouge">-P</code> is a apparently very bad idea.</p>

<blockquote>
  <p>Linux tools often have excessive amount of short options, like this one from man page for ls:</p>

  <p>ls [-ABCFGHLOPRSTUW@abcdefghiklmnopqrstuwx1] [file …]</p>

  <p>Personally I think they should go easy and only include the most common ones rather than using the entire alphabet.</p>
</blockquote>

<p>However, the mystery is not yet solved. Note that we have been asked to enter the password, which explains why most people never suspected <code class="highlighter-rouge">-p</code> actually means password. Put in other words - if <code class="highlighter-rouge">-p</code> means password, why is this command is still asking for password?</p>

<p>The answer lies in the source code:</p>

<p><a href="https://github.com/mysql/mysql-server/blob/5.6/mysys_ssl/my_getopt.cc">my_getopt.cc</a></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">for</span> <span class="p">(</span><span class="n">optend</span><span class="o">=</span> <span class="n">cur_arg</span><span class="p">;</span> <span class="o">*</span><span class="n">optend</span><span class="p">;</span> <span class="n">optend</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">opt_found</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	  <span class="k">for</span> <span class="p">(</span><span class="n">optp</span><span class="o">=</span> <span class="n">longopts</span><span class="p">;</span> <span class="n">optp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">optp</span><span class="o">++</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">optp</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">uchar</span><span class="p">)</span> <span class="o">*</span><span class="n">optend</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="cm">/* Option recognized. Find next what to do with it */</span>
	      <span class="n">opt_found</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">arg_type</span> <span class="o">==</span> <span class="n">REQUIRED_ARG</span> <span class="o">||</span>
		        <span class="n">optp</span><span class="o">-&gt;</span><span class="n">arg_type</span> <span class="o">==</span> <span class="n">OPT_ARG</span><span class="p">)</span>
	      <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">optend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="cm">/* The rest of the option is option argument */</span>
						<span class="n">argument</span><span class="o">=</span> <span class="n">optend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
						<span class="cm">/* This is in effect a jump out of the outer loop */</span>
						<span class="n">optend</span><span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="s">" "</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">arg_type</span> <span class="o">==</span> <span class="n">OPT_ARG</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">var_type</span> <span class="o">==</span> <span class="n">GET_BOOL</span><span class="p">)</span>
								<span class="o">*</span><span class="p">((</span><span class="n">my_bool</span><span class="o">*</span><span class="p">)</span> <span class="n">optp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span><span class="o">=</span> <span class="p">(</span><span class="n">my_bool</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">get_one_option</span> <span class="o">&amp;&amp;</span> <span class="n">get_one_option</span><span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">optp</span><span class="p">,</span> <span class="n">argument</span><span class="p">))</span>
								<span class="k">return</span> <span class="n">EXIT_UNSPECIFIED_ERROR</span><span class="p">;</span>
							<span class="k">continue</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="cm">/* Check if there are more arguments after this one */</span>
      		  <span class="n">argument</span><span class="o">=</span> <span class="o">*++</span><span class="n">pos</span><span class="p">;</span>
		        <span class="p">(</span><span class="o">*</span><span class="n">argc</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">*(optend + 1)</code> is the most interesting part. If a short-form option is being recognized, the rest immediately following the short option is treated as argument:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>					<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">optend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="cm">/* The rest of the option is option argument */</span>
						<span class="n">argument</span><span class="o">=</span> <span class="n">optend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
						<span class="cm">/* This is in effect a jump out of the outer loop */</span>
						<span class="n">optend</span><span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="s">" "</span><span class="p">;</span>
</code></pre></div></div>

<p>Given that we are not passing <code class="highlighter-rouge">-p13010</code>, the <code class="highlighter-rouge">13010</code> part is ignored.</p>

<p>But wait, why does <code class="highlighter-rouge">-h localhost</code> work fine?</p>

<p>Just keep looking:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>						<span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">arg_type</span> <span class="o">==</span> <span class="n">OPT_ARG</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">var_type</span> <span class="o">==</span> <span class="n">GET_BOOL</span><span class="p">)</span>
								<span class="o">*</span><span class="p">((</span><span class="n">my_bool</span><span class="o">*</span><span class="p">)</span> <span class="n">optp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span><span class="o">=</span> <span class="p">(</span><span class="n">my_bool</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">get_one_option</span> <span class="o">&amp;&amp;</span> <span class="n">get_one_option</span><span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">optp</span><span class="p">,</span> <span class="n">argument</span><span class="p">))</span>
								<span class="k">return</span> <span class="n">EXIT_UNSPECIFIED_ERROR</span><span class="p">;</span>
							<span class="k">continue</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="cm">/* Check if there are more arguments after this one */</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		        <span class="p">{</span>
              <span class="k">return</span> <span class="n">EXIT_ARGUMENT_REQUIRED</span><span class="p">;</span>
	       	  <span class="p">}</span>
      		  <span class="n">argument</span><span class="o">=</span> <span class="o">*++</span><span class="n">pos</span><span class="p">;</span>
		        <span class="p">(</span><span class="o">*</span><span class="n">argc</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
</code></pre></div></div>

<p>So if the argument is an optional arg, it’ll give up and only check for immediate following argument. Otherwise, for OPT_REQUIRED, it assumes the next one is the argument.</p>

<p>Let’s take a look at where they are defined:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">{</span><span class="s">"password"</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span>
   <span class="s">"Password to use when connecting to server. If password is not given it's asked from the tty."</span><span class="p">,</span>
   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_PASSWORD</span><span class="p">,</span> <span class="n">OPT_ARG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
  <span class="p">{</span><span class="s">"host"</span><span class="p">,</span> <span class="sc">'h'</span><span class="p">,</span> <span class="s">"Connect to host."</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_host</span><span class="p">,</span>
   <span class="o">&amp;</span><span class="n">current_host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_STR_ALLOC</span><span class="p">,</span> <span class="n">REQUIRED_ARG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
</code></pre></div></div>

<p>As expected, password is optional and host is required.</p>

<p>Also, note that how it never checked for ‘=’? So the syntax <code class="highlighter-rouge">-p=abc</code> wouldn’t work as expected as well. And hilariously <code class="highlighter-rouge">=abc</code> would become the password. For arguments with a bit more error checking like port, the error message is a bit better:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[~/mysql]: mysql -P=13010 
mysql: [ERROR] Unknown suffix '=' used for variable 'port' (value '=13010')
mysql: [ERROR] mysql: Error while setting value '=13010' to 'port'
</code></pre></div></div>

<p>Note the ‘=13010’ part?</p>

<h2 id="default-protocol">Default protocol</h2>

<p>OK. Let’s try again:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[~/mysql/mysql-fork]: mysql -P 13010 -h localhost -u root
ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' (2)
</code></pre></div></div>

<p>Still doesn’t work. We know it’s not the parsing of -P because port is OPT_REQUIRED:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">{</span><span class="s">"port"</span><span class="p">,</span> <span class="sc">'P'</span><span class="p">,</span> <span class="s">"Port number to use for connection or 0 for default to, in "</span>
   <span class="s">"order of preference, my.cnf, $MYSQL_TCP_PORT, "</span>
<span class="cp">#if MYSQL_PORT_DEFAULT == 0
</span>   <span class="s">"/etc/services, "</span>
<span class="cp">#endif
</span>   <span class="s">"built-in default ("</span> <span class="n">STRINGIFY_ARG</span><span class="p">(</span><span class="n">MYSQL_PORT</span><span class="p">)</span> <span class="s">")."</span><span class="p">,</span>
   <span class="o">&amp;</span><span class="n">opt_mysql_port</span><span class="p">,</span>
   <span class="o">&amp;</span><span class="n">opt_mysql_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_UINT</span><span class="p">,</span> <span class="n">REQUIRED_ARG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">},</span>
</code></pre></div></div>

<p>Note the error message <code class="highlighter-rouge">socket '/var/lib/mysql/mysql.sock</code>. This is for domain socket.</p>

<p>To confirm this is the issue, let’s search for the actual error message:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">client_errors</span><span class="p">[]</span><span class="o">=</span>
<span class="p">{</span>
  <span class="s">"Unknown MySQL error"</span><span class="p">,</span>
  <span class="s">"Can't create UNIX socket (%d)"</span><span class="p">,</span>
  <span class="s">"Can't connect to local MySQL server through socket '%-.100s' (%d)"</span><span class="p">,</span>
</code></pre></div></div>

<p>The client_errors are looked up from error codes:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define ER(X) (((X) &gt;= CR_ERROR_FIRST &amp;&amp; (X) &lt;= CR_ERROR_LAST)? \
               client_errors[(X)-CR_ERROR_FIRST]: client_errors[CR_UNKNOWN_ERROR])
</span></code></pre></div></div>

<p>And the 3rd error is <code class="highlighter-rouge">CR_SOCKET_CREATE_ERROR</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define CR_ERROR_FIRST  	2000 /*Copy first error nr.*/
#define CR_UNKNOWN_ERROR	2000
#define CR_SOCKET_CREATE_ERROR	2001
</code></pre></div></div>

<p>Searching for that leads us back to client.cc:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">vio</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="o">!</span><span class="n">mysql</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">protocol</span> <span class="o">||</span>
       <span class="n">mysql</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">MYSQL_PROTOCOL_SOCKET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="n">unix_socket</span> <span class="o">||</span> <span class="n">mysql_unix_port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="o">!</span><span class="n">host</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">LOCAL_HOST</span><span class="p">)))</span>
  <span class="p">{</span>
    <span class="n">my_socket</span> <span class="n">sock</span><span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">DBUG_PRINT</span><span class="p">(</span><span class="s">"info"</span><span class="p">,</span> <span class="p">(</span><span class="s">"Using socket"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">set_mysql_extended_error</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">CR_SOCKET_CREATE_ERROR</span><span class="p">,</span>
                               <span class="n">unknown_sqlstate</span><span class="p">,</span>
                               <span class="n">ER</span><span class="p">(</span><span class="n">CR_SOCKET_CREATE_ERROR</span><span class="p">),</span>
                               <span class="n">socket_errno</span><span class="p">);</span>
      <span class="n">DBUG_RETURN</span><span class="p">(</span><span class="n">STATE_MACHINE_FAILED</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>So this means by default we are connecting using Unix domain socket, and only if host is not specifed or is localhost!</p>

<blockquote>
  <p>Programs should be transparent about its policies, and give information about what it is doing. If that can end up being too verbose, add a verbose option. I’ll write a separate post about this because I’ve been bitten too many times by similar issues and now my favorite past-time is to add print/printf.</p>
</blockquote>

<p>So there are two ways to fix this:</p>

<ol>
  <li>Instead of local host, use <code class="highlighter-rouge">127.0.0.1</code>. This fails the UNIX socket check and will fallback to TCP.</li>
  <li>Use <code class="highlighter-rouge">--protocol tcp</code> to force using TCP.</li>
</ol>

<p>So the right command would be:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql -P 13010 -h localhost -u root --protocol tcp 
</code></pre></div></div>

<p>or</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql -P 13010 -h 127.0.0.1 -u root
</code></pre></div></div>

<h2 id="summary">Summary</h2>

<p>These two problems can be easily avoided by adding more messages to the mysql client, such as:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Trying to connect to UNIX domain socket localhost...
Connecting to database `12310`. 
</code></pre></div></div>

<p>These would’ve avoided wasting collectively god knows how much time wasted. Maybe I should submit a patch when I get a chance.</p>

<p>The gotchas:</p>

<ol>
  <li>
    <p>mysql short-option with optional args only accept arguments when they immediately follow the option, such as ‘-pmypassword’. Specifying as ‘-p blah’ and blah will be interpreted as current database. Short option with required args don’t have this problem.</p>
  </li>
  <li>
    <p>When there is no protocol specified, mysql will try to connect as UNIX domain socket if connecting to localhost or host isn’t specified. To work around it, use IP address instead of localhost, or specify protocol explicitly using <code class="highlighter-rouge">--protocol</code>.</p>
  </li>
</ol>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/mysql-client-connect-error">Diagnosing interesting MySQL client connection error in localhost through the source code</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-transitioning-to-linux" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/byebye-windows" class="flip-title">
        Byebye Windows - going full linux
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2019-03-31T00:00:00-07:00">31 Mar 2019</time>
      
      
      
      
      









in <span>Tools</span> / <span>Os</span> / <span>Linux</span> / <span>Mac</span> / <span>Windows</span> / <span>Productivity</span>

      











    </p>

    
    

    



  
    <p class="message" >
      Going linux full time

    </p>
  


  </header>

  
    <p>In my new job, no one cares about windows.</p>

<p>Every single developer (with a few exceptions) use MacBook Pro, and connect to their linux VM to get work done. Some people have the trash can MacPro. You get the idea. Being in Microsoft for ~12 years, this is admittingly a interesting adventure. Even though in several Microsoft projects in the past that I have been working on had linux versions (CoreCLR, Service Fabric, etc), most development is still done in Windows, and then ported to Linux/Mac. Whenever occasionally you wonder into the no-man’s land in Linux where the <em>project</em> tooling / infrastructure is falling significantly behind, you want to pull your hair out. Not Linux’s fault - but a matter of priority. In some extreme cases you’d wonder how even one can put out a linux version out at all.</p>

<p>Not anymore. Now linux (or Mac, if you count that in) is <em>the</em> full time job.</p>

<p>After a few weeks of research and practice, I’ve been happyily chugging along with TMUX + VIM + MOSH with my custom key bindings. In this article I’ll talk about a bit of my experience of making the transition.</p>

<h2 id="i-miss-visual-studio">I miss Visual Studio</h2>

<p>Let’s get this one out of the way first. There is <em>no</em> replacement for Visual Studio. Period. The code completion (or Intelli-Sense) and debugging is simply unmatched by anything else in the market. VS Code is awesome in terms of just browsing code and doing some occasional debugging, but for writing code it is just OK as the “inteli-sense” (forgive my Microsoft VS Jargon) can be a hit or miss. Vim is good for text editing, and with plugins you can get some basic stuff to work, but again it’s no where near the quality of experience of Visual Studio. Usually it’s a love/hate relationship with Visual Studio - it’s kinda slow and some times buggy, but you can’t live without it. Well, you can, but you don’t want to.</p>

<p>Nowadays I use vim or VS Code / Atom for writing code, and gdb for debugging.</p>

<h2 id="debugging-using-gdb-is-fine">Debugging using GDB is fine</h2>

<p>Being an reasonably experienced WinDbg user, Gdb’s command line taking a bit getting used to, but that’s about it. GDB also supports a TUI mode that shows the integrated text window for source/register/etc and a command window. It’s not great as many simple key bindings stop working in that mode (taken over by the TUI component) but as long as I can see a source code “window” over SSH I’m happy.</p>

<h1 id="tmux-is-awesome">TMUX is awesome</h1>

<p>TMUX is a terminal multiplexer. With TMUX you won’t lose your working state - even if you disconnect from SSH, just ‘tmux attach’ you’ll resume where you left off. In this sense it is equivalent to a Windows Remote Desktop session.</p>

<p>The most powerful part is that it also allow you to break the terminal into multiple panes and windows, and this way you don’t have to leave the terminal and can easily switch between many different tasks with quick shortcuts. No more need to manage windows - everything is within the terminal. It’s like a virtual desktop for terminals. It’s build in the way that you barely had to touch the mouse anymore. Well, until you move to the browser, that is.</p>

<h1 id="vim-ftw">VIM ftw</h1>

<p>In my Microsoft job I use vim for simple editing purposes, and I like the vim way of thinking so much that I put all my editors into vim mode / vim plugin / vim key bindings.  These days I found myself spending even more time in vim over SSH and so I invested more time finding better VIM configurations and plugins.</p>

<p>I use <a href="https://github.com/junegunn/vim-plug">junegunn/vim-plug</a> as my VIM plugin manager. It’s pretty minimal and gets the job done.</p>

<p>This is the list of plugins I use:</p>

<ul>
  <li><a href="https://github.com/wincent/command-t">Command-T</a> - blazing fast fuzzy file finder</li>
  <li><a href="https://github.com/Raimondi/delimitMate">delimitMate</a> - automaticlly inserting delimiters such as (), [], etc</li>
  <li><a href="https://github.com/mileszs/ack.vim">ack</a> - text search tool</li>
  <li><a href="https://github.com/airblade/vim-gitgutter">vim-gitgutter</a> - shows in leftmost column where are the git changes using +/-/~</li>
  <li><a href="https://github.com/tpope/vim-fugitive">vim-fugitive</a> - great git command wrappers</li>
  <li><a href="https://github.com/xolox/vim-easytags">vim-easytags</a> - automated tag generation and syntax highlighting. I found the syntax highlighting can cause performance issue in large files so I turne the syntax highlighting off.</li>
  <li><a href="https://github.com/christoomey/vim-tmux-navigator">vim-tmux-navigator</a> - navigate between vim and tmux like they are integrated</li>
  <li><a href="https://github.com/vim-scripts/a.vim">a</a> - switch between header and source. Enough said.</li>
  <li><a href="https://github.com/tomtom/tcomment_vim">tcomment_vim</a> - toggle comment/uncomment for lines</li>
  <li><a href="https://github.com/tpope/vim-surround">vim-surround</a> - easy change/add surround characters like (), [], {}</li>
  <li><a href="https://github.com/scrooloose/nerdtree">nerdtree</a> - navigate file/directory tree</li>
  <li><a href="https://github.com/jistr/vim-nerdtree-tabs">vim-nerdtree-tabs</a> - making nerd-tree like an integrated panel</li>
  <li><a href="https://github.com/ntpeters/vim-better-whitespace">vim-better-whitespace</a> - highlight trailing whitespace characters. They are annoying for sure and lint warns about them</li>
  <li><a href="https://github.com/itchyny/lightline.vim">lightline</a> - a light and configurable status line for vim</li>
  <li><a href="https://github.com/junegunn/goyo.vim">goyo</a> - distraction free writing. Best for writing docs</li>
</ul>

<h2 id="ssh-is-the-old-remote-desktop">SSH is the old Remote Desktop</h2>

<p>In my old job I usually “remote” into my development machines at office - and “remote” means “Windows Remote Desktop”. In a reasonable connection it is actually quite nice - there is little lag and you almost feel you are working on a local machine, with all the graphical UI - it’s really amazing.</p>

<p>With linux, you fallback to the good old text-based SSH. It’s kinda amazing in its own way that you can have text-based remote protocol for complicated full screen programs like vim. You don’t get graphical UI this way - but for the most part you don’t need to, and it’s usually blazing fast.</p>

<p>Mosh improves over SSH that it is async (doesn’t wait for server response) so it feels even more responsive. The trade-off is that it can get a bit jarring when you type something and it does’t react correctly initially.</p>

<h2 id="shell-matters">Shell matters</h2>

<p>Windows Commmand Prompt is fine. It works. I still remember I learned my first DOS commands at a 33MHZ 386DX. But it hadn’t changed much since then. ConEmu is a popular terminal and some people (especally admins) use PowerShell as well. But none of those match the flexiblity of linux shells - they just have so much more to offer. You can switch between different shells, adding customizations, even plugins.</p>

<p>For now I’m using ZSH with <a href="https://github.com/robbyrussell/oh-my-zsh">oh-my-zsh</a>. It has fantastic themes and plugins. My favorite features are:</p>
<ul>
  <li>Plugins that shows me all kind of status, such as git status, any pending background process, how long the last command took, etc.</li>
  <li>Auto-suggestion. It automatically suggest the full command based on best match and it grays out the rest of the command that you didn’t type. It’s simple but almost feels like magic when you see it for the first time in action.</li>
  <li>Syntax highlighting. Enough said.</li>
  <li>VIM editing. Yes, you can now use VIM commands to edit your shell commands. Just think that you can easily navigate with all the muscle memory you had with vim. This <em>should</em> be mandatory in every thing that deal with text editing.</li>
</ul>

<p>With all these, and throw in a few custom key bindings, the plain shell / windows command prompt just seems so boring.</p>

<h1 id="you-need-to-work-on-your-configurations">You need to work on your configurations</h1>

<p>However, tweaking these tools so that they work for you takes time. I find myself spending quite a bit of time tweaking the configurations to make it work better for me - and the time spent paid off. All the different configuration options are indeed quite overwhelming if starting from scratch so I use <a href="https://github.com/Parth/dotfiles">Awesome dotfiles</a> project as my starting point for tweaking and forked my own version <a href="https://github.com/yizhang82/dotfiles">yizhang82/dotfiles</a>. There are a lot of things that I like about the way the things are setup:</p>
<ul>
  <li>One script to deploy everything - TMUX/ZSH, the entire github repo containing dotfiles, and back them up</li>
  <li>Dotfiles are configured to include the settings/scripts from the repo at <code class="highlighter-rouge">~/dotfiles</code> - this way things can be automatically synchronized through a git pull. This is actually quite brilliant.</li>
  <li>Automatically pulls the github repo every time ZSH starts - so it’s always up to date</li>
</ul>

<p>Of course, many of the configurations there are already pretty good and is perfect as a starting point for my own configurations.</p>

<p>It contains all my TMUX, ZSH, VIM configurations, and by simplying cloning and running a script it goes into a new machine effortlessly. Most of these is done by the original author and I’m simply tweaking it to my needs.</p>

<h2 id="i-like-it">I like it</h2>

<p>It did take a bit getting used to, but I’m happy to report that I now feel very much productive roughly on the same level of productivity when I’m working on Windows (if not more). I do miss having a fully integrated Visual Studio experience, but the command line experience (with TMUX, etc) in Linux is so much better that it more than makes up for that. Of course, at the end of the day, what matters is getting the job done - just use the right tool for the job. In a future post I can get into a bit more details with my experience with these tools and share some of my learnings/tips.</p>

<p>P.S. I still use Windows at home. I have custom built (by myself) PC that has i7 4770K, 32G RAM, nVidia 2080 RTX mostly for gaming. I think Windows has mostly lost the mindshare of developers these days, but it’s still <em>the</em> OS for gamers, and will be for quite some time.</p>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/byebye-windows">Byebye Windows - going full linux</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-txn-and-move-semantics" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/move-semantics" class="flip-title">
        Fun C++ bug - transactional objects should have move semantics
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2019-03-22T00:00:00-07:00">22 Mar 2019</time>
      
      
      
      
      









in <span>C++</span> / <span>Design</span>

      











    </p>

    
    

    



  
    <p class="message" >
      Objects with transactional semantics need move support

    </p>
  


  </header>

  
    <p>OK. I must admit this probably isn’t the best title out there.</p>

<p>Let’s imagine I have an object that represents a file in a transaction. Recall that transaction needs to be all-or-nothing - if the transaction is complete the files can be kept around / moved to the final destination, otherwise they need to be deleted.</p>

<p>The more or less obvious idea that comes to mind is to represent this with a TxnFile class (TransactionalFile). This is the best part I love about C++, BTW - very clean scoped / destruction semantics.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TxnFile</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TxnFile</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">m_file</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">m_committed</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>
  
  <span class="o">~</span><span class="n">TxnFile</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_committed</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">get_file</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_file</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">commit</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">m_comitted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_file</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">m_committed</span><span class="p">;</span>
<span class="p">};</span>

</code></pre></div></div>

<p>OK. So far so good. Let’s actually implement that business logic:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TxnFile</span><span class="o">&gt;</span> <span class="n">txn_files</span><span class="p">;</span>

<span class="c1">// Collect the files
</span><span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">file</span> <span class="o">:</span> <span class="n">some_files</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">txn_files</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Do something with them. If exception is thrown we'll remove the files
</span><span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">txn_file</span> <span class="o">:</span> <span class="n">txn_files</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">do_some_work</span><span class="p">(</span><span class="n">txn_file</span><span class="p">.</span><span class="n">get_file</span><span class="p">());</span>  
<span class="p">}</span> 

<span class="c1">// If all is well, commit
</span><span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">txn_file</span> <span class="o">:</span> <span class="n">txn_files</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">txn_file</span><span class="p">.</span><span class="n">commit</span><span class="p">();</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Looks rather straight-forward, right? If you try this out yourself, you’ll soon realize something is off - the files are being deleted for no reason at all!</p>

<p>The problem itself is obvious-ish: it really should’ve been a <code class="highlighter-rouge">auto &amp;</code> as otherwise are constructing copies of TxnFile and upon destruction will remove the file!</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// If all is well, commit
</span><span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">txn_file</span> <span class="o">:</span> <span class="n">txn_files</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">do_some_work</span><span class="p">(</span><span class="n">txn_file</span><span class="p">.</span><span class="n">get_file</span><span class="p">());</span>
<span class="p">}</span>

</code></pre></div></div>

<p>However, we are not done yet. The problem is still happening - and in some cases, the files are even removed before we actually do work!</p>

<p>The problem, perhaps not that surprisingly, lies with the <code class="highlighter-rouge">std::vector</code> class. When expanding size of <code class="highlighter-rouge">std::vector</code>, STL will try to create a new block of memory, and copy/move the memory to it. If the class doesn’t have a move constructor, it’ll default to copy, and destroy the old one - which isn’t unlike the <code class="highlighter-rouge">auto txn_file</code> problem we discussed earlier, though a bit more subtle to catch.</p>

<p>Let’s try fixing it:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TxnFile</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TxnFile</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">m_file</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">m_committed</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>
  
  <span class="n">TxnFile</span><span class="p">(</span><span class="k">const</span> <span class="n">TxnFile</span> <span class="o">&amp;&amp;</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">m_file</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">m_file</span><span class="p">);</span>
    <span class="n">m_committed</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="n">committed</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">~</span><span class="n">TxnFile</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_committed</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">get_file</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_file</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">commit</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">m_comitted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_file</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">m_committed</span><span class="p">;</span>
<span class="p">};</span>

</code></pre></div></div>

<p>Looks reasonable, right? Actually the problem is still there! The problem is that you now have a const r-value reference <code class="highlighter-rouge">const TxnFile &amp;&amp;</code>. This means that even though you have a r-value reference, you can’t change it at all - and what’s the point of that if you want the move semantics? The right way is to use a regular r-value reference <code class="highlighter-rouge">TxnFile &amp;&amp;</code>. Keep in mind declaring move constructor disable the copy constructor so you shouldn’t run into this problem again. But just for better clarifying the intention, it’s a good practice to delete the copy constructor explicitly.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TxnFile</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TxnFile</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">m_file</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">m_committed</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>
  
  <span class="n">TxnFile</span><span class="p">(</span><span class="k">const</span> <span class="n">TxnFile</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
  <span class="n">TxnFile</span> <span class="o">&amp;</span><span class="k">operator</span> <span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">TxnFile</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>

  <span class="n">TxnFile</span><span class="p">(</span><span class="n">TxnFile</span> <span class="o">&amp;&amp;</span><span class="n">rhs</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">m_file</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">m_file</span><span class="p">),</span> <span class="n">m_committed</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">m_committed</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="n">TxnFile</span> <span class="o">&amp;</span><span class="k">operator</span> <span class="o">=</span> <span class="p">(</span><span class="n">TxnFile</span> <span class="o">&amp;&amp;</span><span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">reset</span><span class="p">();</span>

    <span class="n">m_file</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">m_file</span><span class="p">);</span>
    <span class="n">m_committed</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">m_committed</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">~</span><span class="n">TxnFile</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">reset</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">reset</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_committed</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">get_file</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_file</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">commit</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">m_comitted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_file</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">m_committed</span><span class="p">;</span>
<span class="p">};</span>

</code></pre></div></div>

<h2 id="a-bit-of-rant">A bit of rant</h2>

<p>OK. We are finally done. Personally I think C++ has grown to the point that it is too complicated for most people and the interaction between different features can lead to really surprising behaviors. Even if you want to write a simple class there is already too much things to consider (copy/move semantics). And don’t get me started on template meta programming. However, if you stick to a relatively sane subset of C++, maybe you’ll be fine. Just maybe. I’ve been working in large C++ codebases profesionally for 14+ years and I still make stupid mistakes.</p>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/move-semantics">Fun C++ bug - transactional objects should have move semantics</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-set-environment-variable" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/set-environment-variable" class="flip-title">
        CoreCLR's environment is not your environment
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2019-02-28T00:00:00-08:00">28 Feb 2019</time>
      
      
      
      
      









in <a href="/category/dotnet/" class="flip-title">.NET / .NET Core</a> / <span>Dotnetcore</span> / <span>Version</span> / <span>Api</span> / <span>Design</span>

      











    </p>

    
    

    



  
    <p class="message" >
      CoreCLR maintains its own private copy of environment variables

    </p>
  


  </header>

  
    <p>This came up when I was helping another collegue in a previous job (where I still write C# code probably 50% of the time), diagnosing a library load failure problem inside a linux container. Internally there is this library that loads different implementations (mock implementation and real implementation) of another library based on a environment variable <code class="highlighter-rouge">USE_MAGIC_TEST_LIB</code>, and the .NET code calling that library is calling <code class="highlighter-rouge">SetEnvironmentVariable</code> to set it conditionally as part of a testing framework:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">useTestFramework</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Environment</span><span class="p">.</span><span class="nf">SetEnvironmentVariable</span><span class="p">(</span><span class="s">"USE_MAGIC_TEST_LIB"</span><span class="p">,</span> <span class="s">"1"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">NativeCode</span><span class="p">.</span><span class="nf">CallToSomeNativeLibraryThatLoadsDifferentLibraryDependsOnEnv</span><span class="p">();</span>

</code></pre></div></div>

<p>This looks reasonable except that it didn’t work at all. It loaded the wrong library and things quickly went down hill after that.</p>

<p>We were scratching our heads for a while until we decided to add a trace to see if the environment is actually taking effect or not in the native code. Interestingly, the native code didn’t see it at all. It’s like they don’t know about each other’s environment!</p>

<p>Actually that observation is more or less what’s going on. Before we dig in a bit deeper, here is a bit of history of CoreCLR cross-platform implementation. Not surprisingly, .NET code started as Windows centric and all the OS calls are strictly Windows API. At some point folks decide to port it to linux/Mac as part of Rotor (later Silverlight), there are two options:</p>
<ol>
  <li>Design a new platform abstraction from scratch and move it to that</li>
  <li>Align the API design to Windows and implement Windows API on top of Linux API</li>
</ol>

<p>2 is obviously the cheaper solution and has the advantage that Windows code would be untouched and therefore won’t get regressions, which is super important. The caveat is that implementing Windows API using Linux API can get tricky, but is the risk people are willing to take. So the new PAL layer is introduced with “new” APIs that looks exactly like Windows APIs implemented using Linux APIs.</p>

<p>In the case of <code class="highlighter-rouge">SetEnvironmentVariable</code>, it is implemented in PAL/environ.cpp:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span>
<span class="n">PALAPI</span>
<span class="nf">SetEnvironmentVariableA</span><span class="p">(</span>
            <span class="n">IN</span> <span class="n">LPCSTR</span> <span class="n">lpName</span><span class="p">,</span>
            <span class="n">IN</span> <span class="n">LPCSTR</span> <span class="n">lpValue</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...
</span>
    <span class="c1">// All the conditions are met. Set the variable.
</span>    <span class="kt">int</span> <span class="n">iLen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">lpName</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">lpValue</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">LPSTR</span> <span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPSTR</span><span class="p">)</span> <span class="n">PAL_malloc</span><span class="p">(</span><span class="n">iLen</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">bRet</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">ERROR</span><span class="p">(</span><span class="s">"Unable to allocate memory</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">SetLastError</span><span class="p">(</span><span class="n">ERROR_NOT_ENOUGH_MEMORY</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">sprintf_s</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">iLen</span><span class="p">,</span> <span class="s">"%s=%s"</span><span class="p">,</span> <span class="n">lpName</span><span class="p">,</span> <span class="n">lpValue</span><span class="p">);</span>
    <span class="n">nResult</span> <span class="o">=</span> <span class="n">EnvironPutenv</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">PAL_free</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
    <span class="n">string</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

    <span class="c1">// If EnvironPutenv returns FALSE, it almost certainly failed to allocate memory.
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">nResult</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">bRet</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">ERROR</span><span class="p">(</span><span class="s">"Unable to allocate memory</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">SetLastError</span><span class="p">(</span><span class="n">ERROR_NOT_ENOUGH_MEMORY</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>This looks a bit fishy. It’s allocating its own buffer and calls into EnvironPutenv, which basically does this:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">existingEquals</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sc">'='</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">existingEquals</span> <span class="o">-</span> <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">nameLength</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nameLength</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">free</span><span class="p">(</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">;</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_ASSERTE</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">palEnvironmentCapacity</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">palEnvironmentCapacity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">// We found the first null, but it's the last element in our environment
</span>            <span class="c1">// block. We need more space in our environment, so let's double its size.
</span>            <span class="kt">int</span> <span class="n">resizeRet</span> <span class="o">=</span> <span class="n">ResizeEnvironment</span><span class="p">(</span><span class="n">palEnvironmentCapacity</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">resizeRet</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">free</span><span class="p">(</span><span class="n">copy</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">_ASSERTE</span><span class="p">(</span><span class="n">copy</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">);</span>
        <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">;</span>
        <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="n">palEnvironmentCount</span><span class="o">++</span><span class="p">;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>So it’s basically managing its own memory in <code class="highlighter-rouge">palEnvironment</code> environment array! No wonder things don’t work.</p>

<p>But why go through all the trouble while Linux has its own <code class="highlighter-rouge">getenv</code>/<code class="highlighter-rouge">setenv</code>?</p>

<p>These posts provides the answer:</p>

<p>http://rachelbythebay.com/w/2017/01/30/env/</p>

<blockquote>
  <p>Modifications of environment variables are not allowed in multi-threaded programs.
– the glibc manual</p>
</blockquote>

<p>https://github.com/dotnet/coreclr/issues/635</p>

<blockquote>
  <p>From looking at the code, I suspect that the cached environment was attempt to fix thread safety or consistency problems between Environment.GetEnvironmentVariables and Environment.SetEnvironmentVariable.</p>
</blockquote>

<blockquote>
  <p>The enumeration of the environment starts by reading the <a href="http://linux.die.net/man/5/environ">environ</a> global variable, without any locks. Consider what may happen if somebody calls setenv while the enumeration is in progress.</p>
</blockquote>

<p>It’s because <code class="highlighter-rouge">setenv</code>/<code class="highlighter-rouge">getenv</code> isn’t particularly thread safe - you can crash when reading environment while the environment get modifed by another thread, or two threads modifying environment at the same time can lead to leaks.</p>

<p>In this case, one can see a few options:</p>

<ol>
  <li>Do nothing - the issues are linux-specific and you should take care when calling these functions, the same way just like you call them in linux.</li>
  <li>Throw PlatformNotSupported - getenv/setenv just isn’t safe</li>
  <li>Adding critical section around getenv/setenv - make them safe to be called in multiple threads</li>
  <li>Implement your own safe environment helpers - as a result rest of the native library won’t observe the change through <code class="highlighter-rouge">getenv</code>/<code class="highlighter-rouge">setenv</code></li>
</ol>

<p>1 isn’t really acceptable because .NET developers need the code to be portable - they don’t want handle the platform special oddies to make their code portable. They would like .NET platform library to be safe and reliable.</p>

<p>2 isn’t great either for the same reason, and also it’ll break a ton of code when ported to linux.</p>

<p>3 makes .NET code safe, but it wouldn’t protect against native code racing with getenv/setenv calls from within .NET code, so race conditions would still occur and .NET developer has little control.</p>

<p>4 is safe, but can lead to subtle breaking changes.</p>

<p>Unfortunately there isn’t a great option here. 1, 2, and 4 are safe option, but all of them have their downsides. At the end of the day, it comes down to compatibility/portability vs surprising behavior. .NET team favors compatibility and portability. While it can lead to sutble breaking changes, fortunately the breaking changes are consistent and therefore easier to diagnose. In our case being a container launched by another system makes the whole thing much harder to diagnose, but that’s more a problem of the container launcher itself. Even though we were bit by the very same problem, I agree it is most likely the better choice.</p>

<p>For more information, you can refer to CoreCLR code here:</p>

<p>https://github.com/dotnet/coreclr/blob/master/src/pal/src/misc/environ.cpp#L607</p>

<p>And here is a simple code snippet to demonstrate the issue. I’ve tested this on my MBP.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>


<span class="k">namespace</span> <span class="nn">set_env</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"/usr/lib/system/libsystem_c.dylib"</span><span class="p">)]</span>
        <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">getenv</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">);</span>

        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"/usr/lib/system/libsystem_c.dylib"</span><span class="p">)]</span>
        <span class="k">static</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">setenv</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="k">value</span><span class="p">);</span>

         <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">envName</span> <span class="p">=</span> <span class="s">"MY_ENV"</span><span class="p">;</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"MY_ENV={0}"</span><span class="p">,</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="n">envName</span><span class="p">));</span>

            <span class="n">Environment</span><span class="p">.</span><span class="nf">SetEnvironmentVariable</span><span class="p">(</span><span class="n">envName</span><span class="p">,</span> <span class="s">"~/path"</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Setting it to ~/path"</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"MY_ENV={0}"</span><span class="p">,</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="n">envName</span><span class="p">));</span>

            <span class="n">IntPtr</span> <span class="n">env</span> <span class="p">=</span> <span class="nf">getenv</span><span class="p">(</span><span class="n">envName</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">envStr</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStringAnsi</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"getenv(MY_ENV)={0}"</span><span class="p">,</span> <span class="n">envStr</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Setting it using setenv"</span><span class="p">);</span>
            <span class="nf">setenv</span><span class="p">(</span><span class="n">envName</span><span class="p">,</span> <span class="s">"~/path"</span><span class="p">);</span>

            <span class="n">env</span> <span class="p">=</span> <span class="nf">getenv</span><span class="p">(</span><span class="n">envName</span><span class="p">);</span>
            <span class="n">envStr</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStringAnsi</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"getenv(MY_ENV)={0}"</span><span class="p">,</span> <span class="n">envStr</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now if you are interested to dig in a bit more, here are some bonus questions for your consideration:</p>
<ol>
  <li>Does the same problem happen in Windows? And why/why not?</li>
  <li>Why does the above code above use <code class="highlighter-rouge">Marshal.PtrToStringAnsi</code> instead of just have <code class="highlighter-rouge">getenv</code> returning the string?</li>
</ol>

<p>That’s all for now. Thanks for reading!</p>


    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/set-environment-variable">CoreCLR's environment is not your environment</a>

      </p>
    </footer>
  
</article>

  

  <h2 class="sr-only">Pagination</h2>
<nav class="pagination heading clearfix" role="navigation">
  <ul>
    <li class="pagination-item older" >
      
      
      
  <a
    class=" "
    href="/page-2/"
    rel="next"
    
  >
    Older
  </a>


    </li>
    <li class="pagination-item newer" >
      
      
      
  <span class=" ">Newer</span>


    </li>
  </ul>
</nav>



  

  
<footer role="contentinfo">
  <hr/>
  
    <p><small class="copyright">© 2017. All rights reserved.
</small></p>
  
  
  <p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">8.4.0</span></small></p>
  <hr class="sr-only"/>
</footer>


</main>

  
</hy-push-state>


  <!--[if !IE]><!---->
  <script>loadJSDeferred(document.getElementById('_hrefJS').href);</script>
  

  <!--<![endif]-->

  
  <script>!function(w, d) {
    w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;

    /**/
      ga('create', 'UA-93224322-1', 'auto');
    /**/

    var pushStateEl = d.getElementsByTagName('hy-push-state')[0];
    var timeoutId;
    pushStateEl.addEventListener('hy-push-state-load', function() {
      w.clearTimeout(timeoutId);
      timeoutId = w.setTimeout(function() {
        ga('set', 'page', w.location.pathname);
        ga('send', 'pageview');
      }, 500);
    });

    d.addEventListener('hy--cookies-ok', function () {
      w.ga(function(tracker) {
        w.ga("set", "anonymizeIp", undefined);
        localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId"));
      });
    });

    w.loadJSDeferred('https://www.google-analytics.com/analytics.js');
  }(window, document);</script>



  <script>
    if ('serviceWorker' in navigator) {
      
        navigator.serviceWorker.getRegistration()
          .then(r => r.unregister())
          .catch(() => {});
      
    }
  </script>






<h2 class="sr-only" hidden>Templates (for web app):</h2>

<template id="_animation-template" hidden>
  <div class="animation-main fixed-top">
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

<template id="_loading-template" hidden>
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

<template id="_error-template" hidden>
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

<template id="_back-template" hidden>
  <a id="_back" class="back nav-btn fl no-hover">
    <span class="sr-only">Back</span>
    <span class="icon-arrow-left2"></span>
  </a>
</template>

<template id="_permalink-template" hidden>
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="icon-link"></span>
  </a>
</template>




</body>
</html>
