<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v8.4.0 <https://hydejack.com/>
-->











<head>
  



<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">




  
<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Diagnosing interesting MySQL client connection error in localhost through the source code | yizhang82’s blog</title>
<meta property="og:title" content="Diagnosing interesting MySQL client connection error in localhost through the source code" />
<meta name="author" content="Yi Zhang" />
<meta property="og:locale" content="en" />
<meta name="description" content="The art of argument parsing and policy transparency" />
<meta property="og:description" content="The art of argument parsing and policy transparency" />
<link rel="canonical" href="http://localhost:4000/mysql-client-connect-error" />
<meta property="og:url" content="http://localhost:4000/mysql-client-connect-error" />
<meta property="og:site_name" content="yizhang82’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-18T00:00:00-07:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/mysql-client-connect-error","headline":"Diagnosing interesting MySQL client connection error in localhost through the source code","dateModified":"2019-04-18T00:00:00-07:00","datePublished":"2019-04-18T00:00:00-07:00","sameAs":null,"image":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/mysql-client-connect-error"},"name":null,"author":{"@type":"Person","name":"Yi Zhang"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icons/icon.png"},"name":"Yi Zhang"},"description":"The art of argument parsing and policy transparency","@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  


<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="yizhang82's blog">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<meta name="application-name" content="yizhang82's blog">
<meta name="msapplication-config" content="/assets/ieconfig.xml">


<meta name="theme-color" content="#193747">


<meta name="generator" content="Hydejack v8.4.0" />

<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="yizhang82's blog" />



<link rel="alternate" href="http://localhost:4000/mysql-client-connect-error" hreflang="en">

<link rel="shortcut icon" href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon.png">

<link rel="manifest" href="/assets/manifest.json">


  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">


  <link rel="dns-prefetch" href="https://www.google-analytics.com">



<link rel="dns-prefetch" href="/" id="_baseURL">
<link rel="dns-prefetch" href="/assets/js/hydejack-8.4.0.js" id="_hrefJS">
<link rel="dns-prefetch" href="/sw.js" id="_hrefSW">
<link rel="dns-prefetch" href="/assets/bower_components/fontfaceobserver/fontfaceobserver.standalone.js" id="_hrefFFO">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js" id="_hrefKatexJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_hrefKatexCSS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.js" id="_hrefKatexCopyJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.css" id="_hrefKatexCopyCSS">
<link rel="dns-prefetch" href="/assets/img/swipe.svg" id="_hrefSwipeSVG">



<link rel="dns-prefetch" href="https://yizhang82.disqus.com" id="_hrefDisqus">


<script>!function(e,t){"use strict";function n(e,t,n,r){e.addEventListener?e.addEventListener(t,n,r):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,r){var o=t.createElement("script");o.src=e,r&&n(o,"load",r,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(o,a),o},e._loaded=!1,e.loadJSDeferred=function(r,o){function a(){e._loaded=!0,o&&n(d,"load",o,{once:!0});var r=t.scripts[0];r.parentNode.insertBefore(d,r)}var d=t.createElement("script");return d.src=r,e._loaded?a():n(e,"load",a,{once:!0}),d},e.setRel=e.setRelStylesheet=function(e){function n(){this.rel="stylesheet"}var r=t.getElementById(e);r.addEventListener?r.addEventListener("load",n,{once:!0}):r.onload=n}}(window,document);
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
</script>

<script>!function(w, d) {
    w._noPushState = false;
    w._noDrawer = false;

    /**/
    loadJS(d.getElementById('_hrefFFO').href, function() {
      if ('Promise' in w) Promise.all([
        new FontFaceObserver('Noto Sans').load(),
        new FontFaceObserver('Roboto Slab').load(),
      ]).then(function f() { d.body.classList.add('font-active'); }, function() {});
    });
    /**/
}(window, document);</script>

<!--[if gt IE 8]><!---->








  <link rel="stylesheet" href="/assets/css/hydejack-8.4.0.css">
  <link rel="stylesheet" href="/assets/icomoon/style.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Noto+Sans:400,400i,700,700i">
    <noscript>
      <style>
        html { font-family: Noto Sans, Helvetica, Arial, sans-serif!important; }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Roboto Slab, Helvetica, Arial, sans-serif!important; }
      </style>
    </noscript>
  


  <style id="_pageStyle">

.content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba !important}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus,.form-control:focus,.form-control.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}

</style>


<!--<![endif]-->




</head>

<body>
  <div id="_navbar" class="navbar fixed-top">
  <div class="content">
    <div class="nav-btn-bar">
      <span class="sr-only">Jump to:</span>
      <a id="_menu" class="nav-btn no-hover fl" href="#_navigation">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>
    </div>
  </div>
</div>
<hr class="sr-only" hidden />


<hy-push-state
  replace-ids="_main"
  link-selector="a[href]:not([href*='/assets/']):not(.external):not(.no-push-state)"
  duration="250"
  script-selector="script:not([type^='math/tex'])"
  prefetch
>
  
    <main
  id="_main"
  class="content fade-in layout-post"
  role="main"
  data-color="#4fb1ba"
  data-theme-color="#193747"
  
    data-image="/assets/img/sidebar-bg.jpg"
    data-overlay
  
  >
  




<article id="post-mysql-connect-error" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      
        Diagnosing interesting MySQL client connection error in localhost through the source code
      
    </h1>

    <p class="post-date heading">
      
      <time datetime="2019-04-18T00:00:00-07:00">18 Apr 2019</time>
      
      
      
      
      









in <span>Mysql</span> / <a href="/category/database/" class="flip-title">Database</a>

      











    </p>

    
    

    



  
    <p class="message" >
      The art of argument parsing and policy transparency

    </p>
  


  </header>

  
    <p>When working with MySQL the often most frustrating part is getting strange connection errors. I’ve wasted two hours trying to connect to a MySQL server using TCP port (unix domain sockets works fine) and I’ll talk about why it didn’t work, and as usual we’ll dive into the code to understand exactly why.</p>

<p>To simplify the problem, let’s say I have MySQL server at port 13010 and bound to localhost, with user name root and empty password (don’t do that in production):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[~/mysql]: mysql -p 13010 -h localhost -u root
Enter password:
ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' (2)
</code></pre></div></div>

<p>This is typical error many people will run into and you can find many similar posts that discuss the problem but few ever got to the bottom of it. Let’s jump right in.</p>

<h2 id="-p-and--p">-p and -P</h2>

<p>Obviously when I write <code class="highlighter-rouge">-p 13010</code> I meant to tell <code class="highlighter-rouge">mysql</code> client to connect to server using port 13010, but that’s not quite right:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[~/mysql]: mysql --help
  -p, --password[=name]
                      Password to use when connecting to server. If password is
  -P, --port=#        Port number to use for connection or 0 for default
</code></pre></div></div>

<p>So I actually told mysql the password is 13010 instead. Supporting both <code class="highlighter-rouge">-p</code> and <code class="highlighter-rouge">-P</code> is a apparently very bad idea.</p>

<blockquote>
  <p>Linux tools often have excessive amount of short options, like this one from man page for ls:</p>

  <p>ls [-ABCFGHLOPRSTUW@abcdefghiklmnopqrstuwx1] [file …]</p>

  <p>Personally I think they should go easy and only include the most common ones rather than using the entire alphabet.</p>
</blockquote>

<p>However, the mystery is not yet solved. Note that we have been asked to enter the password, which explains why most people never suspected <code class="highlighter-rouge">-p</code> actually means password. Put in other words - if <code class="highlighter-rouge">-p</code> means password, why is this command is still asking for password?</p>

<p>The answer lies in the source code:</p>

<p><a href="https://github.com/mysql/mysql-server/blob/5.6/mysys_ssl/my_getopt.cc">my_getopt.cc</a></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">for</span> <span class="p">(</span><span class="n">optend</span><span class="o">=</span> <span class="n">cur_arg</span><span class="p">;</span> <span class="o">*</span><span class="n">optend</span><span class="p">;</span> <span class="n">optend</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">opt_found</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	  <span class="k">for</span> <span class="p">(</span><span class="n">optp</span><span class="o">=</span> <span class="n">longopts</span><span class="p">;</span> <span class="n">optp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">optp</span><span class="o">++</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">optp</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">uchar</span><span class="p">)</span> <span class="o">*</span><span class="n">optend</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="cm">/* Option recognized. Find next what to do with it */</span>
	      <span class="n">opt_found</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">arg_type</span> <span class="o">==</span> <span class="n">REQUIRED_ARG</span> <span class="o">||</span>
		        <span class="n">optp</span><span class="o">-&gt;</span><span class="n">arg_type</span> <span class="o">==</span> <span class="n">OPT_ARG</span><span class="p">)</span>
	      <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">optend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="cm">/* The rest of the option is option argument */</span>
						<span class="n">argument</span><span class="o">=</span> <span class="n">optend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
						<span class="cm">/* This is in effect a jump out of the outer loop */</span>
						<span class="n">optend</span><span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="s">" "</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">arg_type</span> <span class="o">==</span> <span class="n">OPT_ARG</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">var_type</span> <span class="o">==</span> <span class="n">GET_BOOL</span><span class="p">)</span>
								<span class="o">*</span><span class="p">((</span><span class="n">my_bool</span><span class="o">*</span><span class="p">)</span> <span class="n">optp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span><span class="o">=</span> <span class="p">(</span><span class="n">my_bool</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">get_one_option</span> <span class="o">&amp;&amp;</span> <span class="n">get_one_option</span><span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">optp</span><span class="p">,</span> <span class="n">argument</span><span class="p">))</span>
								<span class="k">return</span> <span class="n">EXIT_UNSPECIFIED_ERROR</span><span class="p">;</span>
							<span class="k">continue</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="cm">/* Check if there are more arguments after this one */</span>
      		  <span class="n">argument</span><span class="o">=</span> <span class="o">*++</span><span class="n">pos</span><span class="p">;</span>
		        <span class="p">(</span><span class="o">*</span><span class="n">argc</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">*(optend + 1)</code> is the most interesting part. If a short-form option is being recognized, the rest immediately following the short option is treated as argument:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>					<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">optend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="cm">/* The rest of the option is option argument */</span>
						<span class="n">argument</span><span class="o">=</span> <span class="n">optend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
						<span class="cm">/* This is in effect a jump out of the outer loop */</span>
						<span class="n">optend</span><span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="s">" "</span><span class="p">;</span>
</code></pre></div></div>

<p>Given that we are not passing <code class="highlighter-rouge">-p13010</code>, the <code class="highlighter-rouge">13010</code> part is ignored.</p>

<p>But wait, why does <code class="highlighter-rouge">-h localhost</code> work fine?</p>

<p>Just keep looking:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>						<span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">arg_type</span> <span class="o">==</span> <span class="n">OPT_ARG</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">var_type</span> <span class="o">==</span> <span class="n">GET_BOOL</span><span class="p">)</span>
								<span class="o">*</span><span class="p">((</span><span class="n">my_bool</span><span class="o">*</span><span class="p">)</span> <span class="n">optp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span><span class="o">=</span> <span class="p">(</span><span class="n">my_bool</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">get_one_option</span> <span class="o">&amp;&amp;</span> <span class="n">get_one_option</span><span class="p">(</span><span class="n">optp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">optp</span><span class="p">,</span> <span class="n">argument</span><span class="p">))</span>
								<span class="k">return</span> <span class="n">EXIT_UNSPECIFIED_ERROR</span><span class="p">;</span>
							<span class="k">continue</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="cm">/* Check if there are more arguments after this one */</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		        <span class="p">{</span>
              <span class="k">return</span> <span class="n">EXIT_ARGUMENT_REQUIRED</span><span class="p">;</span>
	       	  <span class="p">}</span>
      		  <span class="n">argument</span><span class="o">=</span> <span class="o">*++</span><span class="n">pos</span><span class="p">;</span>
		        <span class="p">(</span><span class="o">*</span><span class="n">argc</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
</code></pre></div></div>

<p>So if the argument is an optional arg, it’ll give up and only check for immediate following argument. Otherwise, for OPT_REQUIRED, it assumes the next one is the argument.</p>

<p>Let’s take a look at where they are defined:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">{</span><span class="s">"password"</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span>
   <span class="s">"Password to use when connecting to server. If password is not given it's asked from the tty."</span><span class="p">,</span>
   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_PASSWORD</span><span class="p">,</span> <span class="n">OPT_ARG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
  <span class="p">{</span><span class="s">"host"</span><span class="p">,</span> <span class="sc">'h'</span><span class="p">,</span> <span class="s">"Connect to host."</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_host</span><span class="p">,</span>
   <span class="o">&amp;</span><span class="n">current_host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_STR_ALLOC</span><span class="p">,</span> <span class="n">REQUIRED_ARG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
</code></pre></div></div>

<p>As expected, password is optional and host is required.</p>

<p>Also, note that how it never checked for ‘=’? So the syntax <code class="highlighter-rouge">-p=abc</code> wouldn’t work as expected as well. And hilariously <code class="highlighter-rouge">=abc</code> would become the password. For arguments with a bit more error checking like port, the error message is a bit better:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[~/mysql]: mysql -P=13010 
mysql: [ERROR] Unknown suffix '=' used for variable 'port' (value '=13010')
mysql: [ERROR] mysql: Error while setting value '=13010' to 'port'
</code></pre></div></div>

<p>Note the ‘=13010’ part?</p>

<h2 id="default-protocol">Default protocol</h2>

<p>OK. Let’s try again:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[~/mysql/mysql-fork]: mysql -P 13010 -h localhost -u root
ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' (2)
</code></pre></div></div>

<p>Still doesn’t work. We know it’s not the parsing of -P because port is OPT_REQUIRED:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">{</span><span class="s">"port"</span><span class="p">,</span> <span class="sc">'P'</span><span class="p">,</span> <span class="s">"Port number to use for connection or 0 for default to, in "</span>
   <span class="s">"order of preference, my.cnf, $MYSQL_TCP_PORT, "</span>
<span class="cp">#if MYSQL_PORT_DEFAULT == 0
</span>   <span class="s">"/etc/services, "</span>
<span class="cp">#endif
</span>   <span class="s">"built-in default ("</span> <span class="n">STRINGIFY_ARG</span><span class="p">(</span><span class="n">MYSQL_PORT</span><span class="p">)</span> <span class="s">")."</span><span class="p">,</span>
   <span class="o">&amp;</span><span class="n">opt_mysql_port</span><span class="p">,</span>
   <span class="o">&amp;</span><span class="n">opt_mysql_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_UINT</span><span class="p">,</span> <span class="n">REQUIRED_ARG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">},</span>
</code></pre></div></div>

<p>Note the error message <code class="highlighter-rouge">socket '/var/lib/mysql/mysql.sock</code>. This is for domain socket.</p>

<p>To confirm this is the issue, let’s search for the actual error message:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">client_errors</span><span class="p">[]</span><span class="o">=</span>
<span class="p">{</span>
  <span class="s">"Unknown MySQL error"</span><span class="p">,</span>
  <span class="s">"Can't create UNIX socket (%d)"</span><span class="p">,</span>
  <span class="s">"Can't connect to local MySQL server through socket '%-.100s' (%d)"</span><span class="p">,</span>
</code></pre></div></div>

<p>The client_errors are looked up from error codes:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define ER(X) (((X) &gt;= CR_ERROR_FIRST &amp;&amp; (X) &lt;= CR_ERROR_LAST)? \
               client_errors[(X)-CR_ERROR_FIRST]: client_errors[CR_UNKNOWN_ERROR])
</span></code></pre></div></div>

<p>And the 3rd error is <code class="highlighter-rouge">CR_SOCKET_CREATE_ERROR</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define CR_ERROR_FIRST  	2000 /*Copy first error nr.*/
#define CR_UNKNOWN_ERROR	2000
#define CR_SOCKET_CREATE_ERROR	2001
</code></pre></div></div>

<p>Searching for that leads us back to client.cc:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">vio</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="o">!</span><span class="n">mysql</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">protocol</span> <span class="o">||</span>
       <span class="n">mysql</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">MYSQL_PROTOCOL_SOCKET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="n">unix_socket</span> <span class="o">||</span> <span class="n">mysql_unix_port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="o">!</span><span class="n">host</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">LOCAL_HOST</span><span class="p">)))</span>
  <span class="p">{</span>
    <span class="n">my_socket</span> <span class="n">sock</span><span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">DBUG_PRINT</span><span class="p">(</span><span class="s">"info"</span><span class="p">,</span> <span class="p">(</span><span class="s">"Using socket"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="n">SOCKET_ERROR</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">set_mysql_extended_error</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">CR_SOCKET_CREATE_ERROR</span><span class="p">,</span>
                               <span class="n">unknown_sqlstate</span><span class="p">,</span>
                               <span class="n">ER</span><span class="p">(</span><span class="n">CR_SOCKET_CREATE_ERROR</span><span class="p">),</span>
                               <span class="n">socket_errno</span><span class="p">);</span>
      <span class="n">DBUG_RETURN</span><span class="p">(</span><span class="n">STATE_MACHINE_FAILED</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>So this means by default we are connecting using Unix domain socket, and only if host is not specifed or is localhost!</p>

<blockquote>
  <p>Programs should be transparent about its policies, and give information about what it is doing. If that can end up being too verbose, add a verbose option. I’ll write a separate post about this because I’ve been bitten too many times by similar issues and now my favorite past-time is to add print/printf.</p>
</blockquote>

<p>So there are two ways to fix this:</p>

<ol>
  <li>Instead of local host, use <code class="highlighter-rouge">127.0.0.1</code>. This fails the UNIX socket check and will fallback to TCP.</li>
  <li>Use <code class="highlighter-rouge">--protocol tcp</code> to force using TCP.</li>
</ol>

<p>So the right command would be:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql -P 13010 -h localhost -u root --protocol tcp 
</code></pre></div></div>

<p>or</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql -P 13010 -h 127.0.0.1 -u root
</code></pre></div></div>

<h2 id="summary">Summary</h2>

<p>These two problems can be easily avoided by adding more messages to the mysql client, such as:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Trying to connect to UNIX domain socket localhost...
Connecting to database `12310`. 
</code></pre></div></div>

<p>These would’ve avoided wasting collectively god knows how much time wasted. Maybe I should submit a patch when I get a chance.</p>

<p>The gotchas:</p>

<ol>
  <li>
    <p>mysql short-option with optional args only accept arguments when they immediately follow the option, such as ‘-pmypassword’. Specifying as ‘-p blah’ and blah will be interpreted as current database. Short option with required args don’t have this problem.</p>
  </li>
  <li>
    <p>When there is no protocol specified, mysql will try to connect as UNIX domain socket if connecting to localhost or host isn’t specified. To work around it, use IP address instead of localhost, or specify protocol explicitly using <code class="highlighter-rouge">--protocol</code>.</p>
  </li>
</ol>


  
</article>


<hr class="dingbat related" />




  
     


  <aside class="about related mt4 mb4" role="complementary">
    
    

<div class="author mt4">
  

  
    


  <hy-img
    
    src="https://placehold.it/128x128"
    class="avatar"
    alt="<firstname> <lastname>"
    srcset="https://placehold.it/128x128 1x,https://placehold.it/256x256 2x"
    
  
    
    root-margin="512px"
  >
    <noscript><img data-ignore 
    src="https://placehold.it/128x128"
    class="avatar"
    alt="<firstname> <lastname>"
    srcset="https://placehold.it/128x128 1x,https://placehold.it/256x256 2x"
    
  /></noscript>
    <span class="loading" slot="loading" hidden>
      <span class="icon-cog"></span>
    </span>
  </hy-img>


  

  
  
  <h2  class="page-title hr">
    About
  </h2>

  <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit,
sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>

<p>Open <code class="highlighter-rouge">_data/authors.yml</code> to edit this text.</p>

<p><a href="https://github.com/qwtel/hydejack-starter-kit/archive/v8.1.1.zip">Download Free</a>
– or –
<a href="https://app.simplegoods.co/i/NATYVLYT">Buy PRO</a></p>



  <div class="sidebar-social">
    <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://twitter.com/<username>" title="Twitter" class="no-mark-external">
      <span class="icon-twitter"></span>
      <span class="sr-only">Twitter</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/<username>" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
  
</ul>

  </div>
</div>

  </aside>


  

  
  

  
    




  


  
<aside class="comments related" role="complementary">
  <h2 class="hr">Comments</h2>
  

<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>!function(w, d) {
  if (d.getElementById("disqus_thread")) {
    if (w.DISQUS) {
      w.DISQUS.reset({
        reload: true,
        config() {
          this.page.url = w.location.href;
          this.page.title = d.title;
        },
      });
    } else {
      w.disqus_config = function disqusConfig() {
        this.page.url = w.location.href;
        this.page.title = d.title;
      };
      w.loadJSDeferred(d.getElementById("_hrefDisqus").href + '/embed.js');
    }
  }
}(window, document);</script>


</aside>


  
<footer role="contentinfo">
  <hr/>
  
    <p><small class="copyright">© 2017. All rights reserved.
</small></p>
  
  
  <p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">8.4.0</span></small></p>
  <hr class="sr-only"/>
</footer>


</main>

    <hy-drawer
  class=""
  align="left"
  threshold="10"
  touch-events
  prevent-default
>
  <header id="_sidebar" class="sidebar" role="banner">
    
    <div class="sidebar-bg sidebar-overlay" style="background-color:#4fb1ba;background-image:url(/assets/img/sidebar-bg.jpg)"></div>

    <div class="sidebar-sticky">
      <div class="sidebar-about">
        
          <a class="no-hover" href="/" tabindex="-1">
            <img src="/assets/icons/icon.png" class="avatar" alt="yizhang82's blog" data-ignore />
          </a>
        
        <h2 class="h1"><a href="/">yizhang82's blog</a></h2>
        
        
          <p class="">
            Languages, Runtime, Data structures, Databases, and everything in between

          </p>
        
      </div>

      <nav class="sidebar-nav heading" role="navigation">
        <span class="sr-only">Navigation:</span>
<ul>
  
    
    
    

    
      
        <li>
          <a
            id="_navigation"
            href="/blog/"
            class="sidebar-nav-item"
            
            >
            Blog archive
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/dotnet/"
            class="sidebar-nav-item"
            
            >
            .NET / .NET Core
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/database/"
            class="sidebar-nav-item"
            
            >
            Database
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/interop/"
            class="sidebar-nav-item"
            
            >
            Interop
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/about/"
            class="sidebar-nav-item"
            
            >
            About me
          </a>
        </li>
      
    
  
</ul>

      </nav>

      

      <div class="sidebar-social">
        <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://twitter.com/<username>" title="Twitter" class="no-mark-external">
      <span class="icon-twitter"></span>
      <span class="sr-only">Twitter</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/<username>" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
  
</ul>

      </div>
    </div>
  </header>
</hy-drawer>
<hr class="sr-only" hidden />

  
</hy-push-state>


  <!--[if !IE]><!---->
  <script>loadJSDeferred(document.getElementById('_hrefJS').href);</script>
  

  <!--<![endif]-->

  
  <script>!function(w, d) {
    w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;

    /**/
      ga('create', 'UA-93224322-1', 'auto');
    /**/

    var pushStateEl = d.getElementsByTagName('hy-push-state')[0];
    var timeoutId;
    pushStateEl.addEventListener('hy-push-state-load', function() {
      w.clearTimeout(timeoutId);
      timeoutId = w.setTimeout(function() {
        ga('set', 'page', w.location.pathname);
        ga('send', 'pageview');
      }, 500);
    });

    d.addEventListener('hy--cookies-ok', function () {
      w.ga(function(tracker) {
        w.ga("set", "anonymizeIp", undefined);
        localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId"));
      });
    });

    w.loadJSDeferred('https://www.google-analytics.com/analytics.js');
  }(window, document);</script>



  <script>
    if ('serviceWorker' in navigator) {
      
        navigator.serviceWorker.getRegistration()
          .then(r => r.unregister())
          .catch(() => {});
      
    }
  </script>






<h2 class="sr-only" hidden>Templates (for web app):</h2>

<template id="_animation-template" hidden>
  <div class="animation-main fixed-top">
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

<template id="_loading-template" hidden>
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

<template id="_error-template" hidden>
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

<template id="_back-template" hidden>
  <a id="_back" class="back nav-btn fl no-hover">
    <span class="sr-only">Back</span>
    <span class="icon-arrow-left2"></span>
  </a>
</template>

<template id="_permalink-template" hidden>
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="icon-link"></span>
  </a>
</template>




</body>
</html>
