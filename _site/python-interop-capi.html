<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v7.5.0 <https://qwtel.com/hydejack/>
-->




<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">


  
<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Calling C functions from Python - part 2 - writing CPython extensions using Python/C API | yizhang82’s blog</title>
<meta property="og:title" content="Calling C functions from Python - part 2 - writing CPython extensions using Python/C API" />
<meta name="author" content="Yi Zhang" />
<meta property="og:locale" content="en" />
<meta name="description" content="Calling C functions from Python - part 2 - writing CPython extensions using Python/C API" />
<meta property="og:description" content="Calling C functions from Python - part 2 - writing CPython extensions using Python/C API" />
<link rel="canonical" href="http://localhost:4000/python-interop-capi" />
<meta property="og:url" content="http://localhost:4000/python-interop-capi" />
<meta property="og:site_name" content="yizhang82’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-01-15T00:00:00-08:00" />
<script type="application/ld+json">
{"name":null,"description":"Calling C functions from Python - part 2 - writing CPython extensions using Python/C API","author":{"@type":"Person","name":"Yi Zhang"},"@type":"BlogPosting","url":"http://localhost:4000/python-interop-capi","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icons/icon.png"},"name":"Yi Zhang"},"image":null,"headline":"Calling C functions from Python - part 2 - writing CPython extensions using Python/C API","dateModified":"2018-01-15T00:00:00-08:00","datePublished":"2018-01-15T00:00:00-08:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/python-interop-capi"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  
    <meta name="keywords" content="">
  


<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="yizhang82's blog">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<meta name="application-name" content="yizhang82's blog">
<meta name="msapplication-config" content="/assets/ieconfig.xml">


<meta name="theme-color" content="#4fb1ba">


<meta name="generator" content="Hydejack v7.5.0">

<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="yizhang82's blog" />



<link rel="alternate" href="http://localhost:4000/python-interop-capi" hreflang="en">

<link rel="shortcut icon" href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon.png">

<link rel="manifest" href="/assets/manifest.json">


  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">





<link id="_disqusJS" rel="dns-prefetch" href="https://yizhang82.disqus.com/embed.js">



<link id="_katexJS"  rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js">
<link id="_katexCSS" rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css">

<script>
  function stdOnEnd(n,e){n.onload=function(){this.onerror=this.onload=null,e(null,n)},n.onerror=function(){this.onerror=this.onload=null,e(new Error("Failed to load "+this.src),n)}}function ieOnEnd(n,e){n.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||(this.onreadystatechange=null,e(null,n))}}window.setRelStylesheet=function(n){function e(){this.rel="stylesheet"}var o=document.getElementById(n);o.addEventListener?o.addEventListener("load",e,!1):o.onload=e},window._loaded=!1,window.loadJSDeferred=function(n,e){function o(){window._loaded=!0;var o=document.createElement("script");o.src=n,e&&(("onload"in o?stdOnEnd:ieOnEnd)(o,e),o.onload||stdOnEnd(o,e));var t=document.scripts[0];t.parentNode.insertBefore(o,t)}window._loaded?o():window.addEventListener?window.addEventListener("load",o,!1):window.onload=o};
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);

  window._noPushState = false;
  window._noDrawer = false;
</script>

<!--[if gt IE 8]><!---->


<script>
  WebFontConfig = {
    
    google: {
      families: ['Roboto+Slab:700','Noto+Sans:400,400i,700,700i']
    },
    

    custom: {
      families: ['icomoon'],
      urls: ['/assets/icomoon/style.css']
    }
  };
  (function(d) {
    var wf = d.createElement('script'), s = d.scripts[0];
    wf.src = "/assets/bower_components/webfontloader/webfontloader.js";
    s.parentNode.insertBefore(wf, s);
  }(document));
</script>
<!--<![endif]-->

<noscript>
  
  

  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i">
    <style>
      html { font-family: Noto Sans, Helvetica, Arial, sans-serif }
      h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Roboto Slab, Helvetica, Arial, sans-serif }
    </style>
  

  <link rel="stylesheet" href="/assets/icomoon/style.css">
</noscript>

<!--[if gt IE 8]><!---->



  <link rel="stylesheet" href="/assets/css/hydejack-7.5.0.css">



<style id="_pageStyle">

.content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}

</style>

<!--<![endif]-->




</head>

<body>
  <div class="navbar fixed-top">
  <div class="content">
    <div class="nav-btn-bar">
      <span class="sr-only">Jump to:</span>
      <a id="_menu" class="nav-btn no-hover" href="#_navigation">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>
    </div>
  </div>
</div>


<hy-push-state>
  <main
    id="_main"
    class="content fade-in layout-post"
    role="main"
    data-color="#4fb1ba"
    data-theme-color=""
    
      data-image="/assets/img/sidebar-bg.jpg"
      data-overlay
    
    >
    


<article id="post-python-interop-2" class="page post" role="article">
  <header>
    <h1 class="post-title">
      
        Calling C functions from Python - part 2 - writing CPython extensions using Python/C API
      
    </h1>

    <p class="post-date heading">
      
      <time datetime="2018-01-15T00:00:00-08:00">15 Jan 2018</time>
      
      
      
      
      









in <span>Python</span> / <span>Cpython</span> / <a href="/category/interop/" class="flip-title">interop</a> / <span>Extensions</span>

      











    </p>

    



  
    <p class="message" >
      Calling C functions from Python - part 2 - writing CPython extensions using Python/C API

    </p>
  


  </header>

  
    <p>In my <a href="http://yizhang82.me/python-interop-ctypes">previous post</a> we’ve briefly looked at using ctypes module to call C APIs. In this post let’s dive into a completely different approach - writing a C extension using Python/C API. From the C extension you can then call whatever C/C++ code you want. This is a pretty popular approach to expose a 3rd party C library as python module. The downside is this module would only be loaded by CPython, which is usually not a big issue - unless you use other Python implementation like <a href="http://pypy.org/">PyPy</a>.</p>

<p>Imagine if we want to build a better integer library supporting faster integer operations. In this example it won’t be really faster - just a hypothetical example :)</p>

<h1 id="its-all-c-code">It’s all C code</h1>

<p>CPython, as the name suggests, is written in C (mostly). It has a set of data types describes what are python objects, defines a set of operations on python objects, and use those definition + operations to implement core language functionality and internal modules. A subset of those APIs are opened for extension module writers to access the interpreter directly, pretty much like internal modules. Not surprisingly, this is extremely powerful - you have almost the same power as the interpreter itself.</p>

<p>Unfortunately, this also means:</p>

<ul>
  <li>
    <p>the extension module is bound to CPython. In theory another Python implementation could implement the entire CPython API surface area - but that effectively means that you are rewriting a significant part of CPython from scratch with the same interface, implementing it with your own Python implementation - a daunting (if not challenging) task for sure.</p>
  </li>
  <li>
    <p>CPython always needs to implement those APIs which means that overhauling the interpreter is now more difficult and needs to happen incrementally while maintaining compatibility of the C API.</p>
  </li>
</ul>

<h1 id="a-module-with-only-static-methods">A module with only static methods</h1>

<p>Let’s jump right in. Any Python/C extension module needs to start by including <code class="highlighter-rouge">python.h</code> to get all the definitions of Python/C API and types. Don’t worry about details of building yet - we’ll get to that later.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;Python.h&gt;
</span></code></pre></div></div>

<p>Now we need to define what the static method looks like:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">FastIntModule_StaticMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="s">"add"</span><span class="p">,</span> <span class="n">FastInt_Add</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span> <span class="s">"Add two integers"</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">PyMethodDef</code> is the C struct type describing python methods. You need to supply:</p>
<ul>
  <li>the name - “add”</li>
  <li>the actual C function implementation - <code class="highlighter-rouge">FastInt_Add</code>. We’ll fill it in later.</li>
  <li>flags - <code class="highlighter-rouge">METH_VARARGS</code> meaning it accepts arbitary number of arguments via tuples</li>
  <li>doc - “Add two integers”</li>
</ul>

<p>The last one with all NULLs is a sentinel tell Python to stop looking at more entries, kinda like a <code class="highlighter-rouge">\0</code> terminator. It’s a convention that you’ll need to remember. This way you don’t have to pass size around.</p>

<p>Now we need to tell Python that we have a module with these static functions:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PYMODINIT_FUNC</span> <span class="nf">initfastint</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Py_InitModule</span><span class="p">(</span><span class="s">"fastint"</span><span class="p">,</span> <span class="n">FastIntModule_StaticMethods</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>All python initialization module functions need to be named <code class="highlighter-rouge">init&lt;module_name&gt;</code> - this is how python knows which function to call in your extension module. All it needs to do right now is to register the module with the list of static methods you supplied.</p>

<p>With all the setup, now all we need to do is to add the real method:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span><span class="nf">FastInt_Add</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"ii"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">"i"</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>There are quite a few things here and can look a bit scary first time. Let’s go through this one thing at a time.</p>

<p>First, all Python objects are <code class="highlighter-rouge">PyObject*</code>.</p>

<p>You can think this as the “base class pointer” as every python object are “derived” from PyObject. The code is written using C so the inheritance is really built by hand through inserting a PyObject field into all the subclasses. We’ll see more of that later.</p>

<p>A <code class="highlighter-rouge">PyObject</code> is really a ref count + its type.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct _object {
    _PyObject_HEAD_EXTRA
    Py_ssize_t ob_refcnt;
    struct _typeobject *ob_type;
} PyObject;
</code></pre></div></div>

<p>Then, in <code class="highlighter-rouge">FastInt_Add</code>, it accepts <code class="highlighter-rouge">self</code> and rest of the arguments in <code class="highlighter-rouge">args</code> as a tuple. <code class="highlighter-rouge">PyArg_ParseTuple</code> is used to parse the arguments and break them down into dividual local variables, using a printf/scanf style format - <code class="highlighter-rouge">ii</code> means following two pointers are int*. The result is added together, and then returned in the same manner constructing a Python integer object.</p>

<p>That’s it!</p>

<h1 id="buliding-the-module">Buliding the module</h1>

<p>In this case I’m using CMake. You can use whatever you want but CMake makes it pretty easy to build it in multiple platforms.</p>

<p>First, you need to let CMakfind_package(PythonLibs 2.7 REQUIRED)e find the python package:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find_package(PythonLibs 2.7 REQUIRED)
</code></pre></div></div>

<p>This sets necessary <code class="highlighter-rouge">PYTHON_INCLUDE_DIRS</code> and <code class="highlighter-rouge">PYTHON_LIBRARIES</code> variables that you can use later.</p>

<p>One interesting problem you might run into is that you need to have a matching bitness of python with your build. For example, if you are building x86 and yet your python is 64-bit, you may see a package lookup failure. Try adding 
<code class="highlighter-rouge">-DCMAKE_GENERATOR_PLATFORM=x64</code> to building as 64-bit instead.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include_directories(${PYTHON_INCLUDE_DIRS})target_link_libraries(FASTINT_DLL ${PYTHON_LIBRARIES})
</code></pre></div></div>

<p>To build your code as a python extension module, it obviously needs to be a shared library (<code class="highlighter-rouge">DLL</code>/<code class="highlighter-rouge">dylib</code>/<code class="highlighter-rouge">so</code>), and should have the extension <code class="highlighter-rouge">.pyd</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_library(FASTINT_DLL SHARED main.c)
set_target_properties(FASTINT_DLL PROPERTIES SUFFIX ".pyd")
</code></pre></div></div>

<p>One interesting problem that I ran into in Windows 64-bit python 2.7 is that Python.h tries to redirect your lib to the debug lib python27_d.lib which doesn’t really exist in python distribution by default unless you build your own debug python. This is done in <code class="highlighter-rouge">pyconfig.h</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* For an MSVC DLL, we can nominate the .lib files used by extensions */</span>
<span class="cp">#ifdef MS_COREDLL
#	ifndef Py_BUILD_CORE </span><span class="cm">/* not building the core - must be an ext */</span><span class="cp">
#		if defined(_MSC_VER)
</span>			<span class="cm">/* So MSVC users need not specify the .lib file in
			their Makefile (other compilers are generally
			taken care of by distutils.) */</span>
<span class="cp">#			ifdef _DEBUG
#				pragma comment(lib,"python27_d.lib")
#			else
#				pragma comment(lib,"python27.lib")
#			endif </span><span class="cm">/* _DEBUG */</span><span class="cp">
#		endif </span><span class="cm">/* _MSC_VER */</span><span class="cp">
#	endif </span><span class="cm">/* Py_BUILD_CORE */</span><span class="cp">
#endif </span><span class="cm">/* MS_COREDLL */</span><span class="cp">
</span></code></pre></div></div>

<p>This is unnecessary in my opinion as it should be perfectly OK to build your extension as debug and use Python/C API as release. I tried to use some knobs such as <code class="highlighter-rouge">MS_COREDLL</code> but having _DEBUG flag ultimately force Python.h go down the path of linking against debug version of API:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>main.obj : error LNK2019: unresolved external symbol Py_InitModule4TraceRefs_64 referenced in function initFastInt
</code></pre></div></div>

<p>Turns out <code class="highlighter-rouge">Py_InitModule4TraceRefs_64</code> only exists in debug libs.</p>

<p>The simpliest thing to do is to stick with release build - and use debug build of Python if you want to build your extension as debug. In my opinion this is not designed properly - _DEBUG should control debug-ness of the module and python itself should use a different one, but this is probably topic for another day.</p>

<h1 id="trying-it-out">Trying it out</h1>

<p>Once we build the module using cmake, we can finally give this a try:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">fastint</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">fastint</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="mi">30</span>
</code></pre></div></div>

<p>If Python refuse to load the module, you might need to tweak <code class="highlighter-rouge">syspath</code>, such as:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">'path/to/my/module'</span><span class="p">)</span>
</code></pre></div></div>

<p>Or, load it directly:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fastint</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_dynamic</span><span class="p">(</span><span class="s">'fastint'</span><span class="p">,</span> <span class="s">r'path/to/my/module/fastint.pyd'</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="defining-a-fastint-class">Defining a fastint class</h1>

<p>If we want to define a fastint type, it is a bit more involved.</p>

<p>Let’s start by defining our own PyObject “subclass”:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
    <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FastIntObject</span><span class="p">;</span>
</code></pre></div></div>

<p>Recall our earlier discussion on <code class="highlighter-rouge">PyObject</code> “manual” inheritance - <code class="highlighter-rouge">PyObject_HEAD</code> is the magic that inserts the <code class="highlighter-rouge">PyObject</code> fields:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define PyObject_HEAD                   \
    _PyObject_HEAD_EXTRA                \
    Py_ssize_t ob_refcnt;               \
    struct _typeobject *ob_type;
</span></code></pre></div></div>

<p>And all what we need in addition to that is a int field.</p>

<p>Once we have the object definition, let’s define the type:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">PyTypeObject</span> <span class="n">FastIntType</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s">"fastint.fastInt"</span><span class="p">,</span>         <span class="cm">/* tp_name */</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">FastIntObject</span><span class="p">),</span>     <span class="cm">/* tp_basicsize */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_itemsize */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_dealloc */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_print */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_getattr */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_setattr */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_reserved */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_repr */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_as_number */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_as_sequence */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_as_mapping */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_hash  */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_call */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_str */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_getattro */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_setattro */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_as_buffer */</span>
    <span class="n">Py_TPFLAGS_DEFAULT</span><span class="p">,</span>        <span class="cm">/* tp_flags */</span>
    <span class="s">"Fast int object"</span><span class="p">,</span>         <span class="cm">/* tp_doc */</span>    
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_traverse */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_clear */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_richcompare */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_weaklistoffset */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_iter */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_iternext */</span>
    <span class="n">FastInt_methods</span><span class="p">,</span>           <span class="cm">/* tp_methods */</span>
    <span class="n">FastInt_members</span><span class="p">,</span>           <span class="cm">/* tp_members */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_getset */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_base */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_dict */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_descr_get */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_descr_set */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_dictoffset */</span>
    <span class="p">(</span><span class="n">initproc</span><span class="p">)</span><span class="n">FastInt_init</span><span class="p">,</span>    <span class="cm">/* tp_init */</span>
    <span class="mi">0</span><span class="p">,</span>                         <span class="cm">/* tp_alloc */</span>
    <span class="n">FastInt_new</span><span class="p">,</span>               <span class="cm">/* tp_new */</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Although this looks rather intimidating at first, this is simply a struct with a bunch of fields that defines what this type is. This defines a type object - an object that represents the fastint type.</p>

<h2 id="every-field-is-a-well-defined-operation">Every field is a well-defined operation</h2>

<p>Every single field here is a well-defined operation understood by the interpreter. For example, <code class="highlighter-rouge">tp_alloc</code> is for memory allocation, and <code class="highlighter-rouge">tp_new</code> and <code class="highlighter-rouge">tp_init</code> is for object initialization (including initialization for its fields). If you are familiar with COM or C++, you’ll quickly notice that this is simply a v-table with function pointers. By providing field values, you are effectively <em>overriding</em> the base implementation. Oh, where is the actual inheritance, you say? It is handled by <code class="highlighter-rouge">PyType_Ready</code> helper - we need to call <code class="highlighter-rouge">PyType_Ready</code> to fill in the blanks - initializing fields from base type.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">PyType_Ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FastIntType</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="fastinttype-itself-is-an-pyobject">FastIntType itself is an PyObject</h2>

<p>Take a look at the <code class="highlighter-rouge">PyVarObject_HEAD_INIT</code> macro that initializes PyObject’s fields:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define PyObject_HEAD_INIT(type)        \
    _PyObject_EXTRA_INIT                \
    1, type,
</span>
<span class="cp">#define PyVarObject_HEAD_INIT(type, size)       \
    PyObject_HEAD_INIT(type) size,
</span></code></pre></div></div>

<p>As you can see above, it is giving a 1 ref count and NULL type (which we’ll fill in later). All Python objects are ref-counted and as a extension writer we need to maintain ref count correctly. A new object starts with 1, not surprisingly.</p>

<blockquote>
  <p>In theory CPython could be designed with a garbage collector and avoid ref counting. There are quite a few challenges implementing a real garbage collector, such as reducing stop-othe-world collections, fine-tune memory growth policy, knowing where stack and static objects are at all times, avoiding fragmentation, finding the right balance between keeping objects alive vs reclaiming objects, etc. At the end of the day, implementing ref counting is the simplest thing to do, and it stuck. In practice it works usually pretty well, except for cycles (and the perf cost of ref-counting). Python does have a cycle detection algorithm and <code class="highlighter-rouge">tp_traverse</code> to help with pointer traversal, but it’s optional.</p>
</blockquote>

<h2 id="tp_new-field-defines-the-new-function"><code class="highlighter-rouge">tp_new</code> field defines the new function</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">FastInt_new</span><span class="p">(</span><span class="n">PyTypeObject</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwds</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">FastIntObject</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>

    <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">FastIntObject</span> <span class="o">*</span><span class="p">)</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">tp_alloc</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The new function does the allocation and minimum initialization. Conveniently, we’ll use the type object of fastint type to allocate a type object, using the <code class="highlighter-rouge">tp_alloc</code> helper. As mentioned previously, <code class="highlighter-rouge">tp_alloc</code> wasn’t provided by us but rather filled-in by <code class="highlighter-rouge">PyType_Ready</code>, kinda like calling the base constructor.</p>

<p>Note that we also has a init function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span>
<span class="nf">FastInt_init</span><span class="p">(</span><span class="n">FastIntObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwds</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"i"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It calls <code class="highlighter-rouge">PyArg_ParseTuple</code> to assign the internal value with the supplied int argument. Intuitively, you might think <code class="highlighter-rouge">tp_init</code> is the <code class="highlighter-rouge">__init__</code> function and <code class="highlighter-rouge">tp_new</code> is the <code class="highlighter-rouge">__new__</code> function, and you are right. <code class="highlighter-rouge">__new__</code> is the creation method while <code class="highlighter-rouge">__init__</code> is the initialization method.</p>

<h2 id="tp_methods-define-list-of-methods"><code class="highlighter-rouge">tp_methods</code> define list of methods</h2>

<p>We only have one:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">FastInt_methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="s">"inc"</span><span class="p">,</span> <span class="p">(</span><span class="n">PyCFunction</span><span class="p">)</span> <span class="n">FastInt_inc</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">,</span> <span class="s">"inc method"</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Again, NULLs are the sentinel.</p>

<p>The inc method looks like this - and is pretty straight-forward:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">FastInt_inc</span><span class="p">(</span><span class="n">FastIntObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">operand</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">"i"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">operand</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">self</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+=</span> <span class="n">operand</span><span class="p">;</span>

    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that it returns <code class="highlighter-rouge">self</code> back to the caller. In Python, returning a object needs to come with an add ref (just like COM). So we need to call Py_INCREF. If you think about it, there is a good reason for it - the caller needs to be sure that the returned object is usable (otherwise the object could be gone after the return, or even before), and having a usable object meaning doing an explicit <code class="highlighter-rouge">Py_INCREF</code>. The caller can then use it knowing it is always safe, and release it by calling <code class="highlighter-rouge">Py_DECREF</code> when it’s done. There are exceptions to this rule - if by certain implied contract that the caller knows the returned object is always going to be alive (usually tied to a <em>parent</em> object), it can return the object without a addref (one such example being <code class="highlighter-rouge">PyTuple_GetItem</code>). Always consult the documentation.</p>

<h2 id="tp_members-define-its-members">tp_members define its members</h2>

<p>We have one member - the value field:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">PyMemberDef</span> <span class="n">FastInt_members</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="s">"value"</span><span class="p">,</span> <span class="n">T_INT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">FastIntObject</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"value of the integer"</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nb">NULL</span> <span class="p">}</span>  <span class="cm">/* Sentinel */</span>
<span class="p">};</span>
</code></pre></div></div>

<p>We basically tell python - here is a field with this offset and you can show it as a member called “value”. The struct field name can be whatever name you want since python doesn’t care what you call your struct fields - meaning that they don’t have to match, but it is nice that they do.</p>

<h1 id="initializing-the-type">Initializing the type</h1>

<p>Now that we have the type with all its members, we need to tell Python that it is there. Not surprisingly, the best place to do so is the module init function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PYMODINIT_FUNC</span> <span class="nf">initfastint</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">PyType_Ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FastIntType</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">Py_InitModule</span><span class="p">(</span><span class="s">"fastint"</span><span class="p">,</span> <span class="n">FastIntModule_StaticMethods</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">Py_INCREF</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FastIntType</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">"fastInt"</span><span class="p">,</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">FastIntType</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">PyType_Ready</code> initialize the type object by assigning its fields with base and other necessary adjustments and error checking</li>
  <li><code class="highlighter-rouge">PyModule_AddObject</code> registers the type on the module so that Python knows this module now has this type.</li>
</ul>

<h1 id="trying-out-fastint-type">Trying out fastInt type</h1>

<p>Now it’s time to try out our new (not at all) fastint type.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">fastint</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">fastint</span><span class="o">.</span><span class="n">fastInt</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">i</span><span class="o">.</span><span class="n">value</span>
<span class="mi">10</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">i</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">fastint</span><span class="o">.</span><span class="n">fastInt</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x0000000004A610D8</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">i</span><span class="o">.</span><span class="n">value</span>
<span class="mi">30</span>
</code></pre></div></div>

<h1 id="where-is-the-code">Where is the code</h1>

<p>You can find the code at <a href="https://github.com/yizhang82/bindings_example/tree/master/python/fastint">github</a></p>

<h1 id="whats-next">What’s next</h1>

<p>As previously mentioned, I’ll cover Python C API in the next post and dive into ctypes implementation in CPython (which are written using python C API).</p>

<p>I’ll update them with links once they become available:</p>

<ul>
  <li><a href="/python-interop-ctypes">Part 1 - CTypes</a></li>
  <li><a href="/python-interop-capi">Part 2 - writing CPython extensions using Python/C API</a></li>
  <li><a href="/python-interop-inside-ctypes">Part 3 - Deep dive into ctypes implementation in CPython</a></li>
  <li>Part 4 - PyPy and CFFI</li>
</ul>

  
</article>


<hr class="dingbat related" />




  
     


  <aside class="about related mt4 mb4" role="complementary">
    
    

<div class="author mt4">
  

  
    
    
<img class="avatar" src="https://avatars1.githubusercontent.com/yizhang82?v=3&s=128" alt="yizhang82" srcset="https://avatars1.githubusercontent.com/yizhang82?v=3&s=128 1x, https://avatars1.githubusercontent.com/yizhang82?v=3&s=256 2x, https://avatars1.githubusercontent.com/yizhang82?v=3&s=384 3x, https://avatars1.githubusercontent.com/yizhang82?v=3&s=512 4x" width="128" height="128" data-proofer-ignore="true" />

  

  
  
  <h2  class="page-title hr">
    About
  </h2>

  <p>Principal Software Engineer working on Windows Azure focusing on transactional data programming and storage solution across multiple languages. Previously worked in .NET / CLR team for ~10 years on full .NET, .NET Core, and .NET Native. Amature piano player, passionate gamer, and proud dad.</p>


  <div class="sidebar-social">
    <span class="sr-only">Social:</span>
<ul>
  

  

  
    













<li>
  <a href="https://twitter.com/yizhang82" title="Twitter" class="no-mark-external">
    <span class="icon-twitter"></span>
    <span class="sr-only">Twitter</span>
  </a>
</li>

  
    













<li>
  <a href="https://github.com/yizhang82" title="GitHub" class="no-mark-external">
    <span class="icon-github"></span>
    <span class="sr-only">GitHub</span>
  </a>
</li>

  
    













<li>
  <a href="mailto:mail@yizhang82.me" title="Email" class="no-mark-external">
    <span class="icon-mail"></span>
    <span class="sr-only">Email</span>
  </a>
</li>

  
</ul>

  </div>
</div>

  </aside>


  

  
  

  
    




<aside class="related mb4" role="complementary">
  <h2 class="hr">Related Posts</h2>

  <ul class="related-posts">
    
      


<li>
  <a href="/python-interop-inside-ctypes" class="h4 flip-title">
    <span>Calling C functions from Python - part 3 - deep dive into ctypes implementation in CPython</span>
  </a>
  <time class="heading faded fine" datetime="2018-01-22T00:00:00-08:00">22 Jan 2018</time>
</li>

    
      


<li>
  <a href="/python-interop-ctypes" class="h4 flip-title">
    <span>Calling C functions from Python - part 1 - using ctypes</span>
  </a>
  <time class="heading faded fine" datetime="2018-01-08T00:00:00-08:00">08 Jan 2018</time>
</li>

    
  </ul>
</aside>


  


    

<aside class="comments related" role="complementary">
  <h2 class="hr">Comments</h2>
  <div id="disqus_thread"></div>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</aside>


    <footer role="contentinfo">
  <hr/>
  
    <p><small class="copyright">© 2017. All rights reserved.
</small></p>
  
  
  <p><small>Powered by <a class="external" href="https://qwtel.com/hydejack/">Hydejack</a> v<span id="_version">7.5.0</span></small></p>
  <hr class="sr-only"/>
</footer>

  </main>
  <hy-drawer>
  <header id="_sidebar" class="sidebar" role="banner">
    
    <div class="sidebar-bg sidebar-overlay" style="background-color:#4fb1ba;background-image:url(/assets/img/sidebar-bg.jpg)"></div>

    <div class="sidebar-sticky">
      <div class="sidebar-about">
        <h2 class="h1"><a href="/">yizhang82's blog</a></h2>
        
        
          <p class="">
            Languages, Runtime, Data structures, Databases, and everything in between

          </p>
        
      </div>

      <nav class="sidebar-nav heading" role="navigation">
        <span class="sr-only">Navigation:</span>
<ul>
  
  
  
  
    
      <li>
        <a
          id="_navigation"
          href="/blog/"
          class="sidebar-nav-item"
          
          >
          Blog archive
        </a>
      </li>
    
  
    
      <li>
        <a
          
          href="/category/dotnet/"
          class="sidebar-nav-item"
          
          >
          .NET
        </a>
      </li>
    
  
    
      <li>
        <a
          
          href="/category/interop/"
          class="sidebar-nav-item"
          
          >
          interop
        </a>
      </li>
    
  
    
      <li>
        <a
          
          href="/about/"
          class="sidebar-nav-item"
          
          >
          About me
        </a>
      </li>
    
  
</ul>

      </nav>

      

      <div class="sidebar-social">
        <span class="sr-only">Social:</span>
<ul>
  

  

  
    













<li>
  <a href="https://twitter.com/yizhang82" title="Twitter" class="no-mark-external">
    <span class="icon-twitter"></span>
    <span class="sr-only">Twitter</span>
  </a>
</li>

  
    













<li>
  <a href="https://github.com/yizhang82" title="GitHub" class="no-mark-external">
    <span class="icon-github"></span>
    <span class="sr-only">GitHub</span>
  </a>
</li>

  
    













<li>
  <a href="mailto:mail@yizhang82.me" title="Email" class="no-mark-external">
    <span class="icon-mail"></span>
    <span class="sr-only">Email</span>
  </a>
</li>

  
</ul>

      </div>
    </div>
  </header>
</hy-drawer>

</hy-push-state>


  

  <!--[if gt IE 9]><!---->
  
  <script>loadJSDeferred('/assets/js/hydejack-7.5.0.js');</script>
  
  <!--<![endif]-->



  
<hr class="sr-only"/>
<h2 class="sr-only">Templates (for web app):</h2>

<template id="_animation-template">
  <div class="animation-main fixed-top">
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

<template id="_loading-template">
  <div class="loading">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

<template id="_error-template">
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

<template id="_back-template">
  <a id="_back" class="back nav-btn no-hover">
    <span class="sr-only">Back</span>
    <span class="icon-arrow-left2"></span>
  </a>
</template>

<template id="_permalink-template">
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="icon-link"></span>
  </a>
</template>



</body>
</html>
