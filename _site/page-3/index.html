<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v8.4.0 <https://hydejack.com/>
-->











<head>
  



<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">




  
<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Home | yizhang82’s blog</title>
<meta property="og:title" content="Home" />
<meta name="author" content="Yi Zhang" />
<meta property="og:locale" content="en" />
<meta name="description" content="The official Hydejack blog. Version updates, example content and how-to guides on how to blog with Jekyll. Open index.html to edit this text." />
<meta property="og:description" content="The official Hydejack blog. Version updates, example content and how-to guides on how to blog with Jekyll. Open index.html to edit this text." />
<link rel="canonical" href="http://localhost:4000/page-3/" />
<meta property="og:url" content="http://localhost:4000/page-3/" />
<meta property="og:site_name" content="yizhang82’s blog" />
<link rel="prev" href="http://localhost:4000/page-2/">
<link rel="next" href="http://localhost:4000/page-4/">
<script type="application/ld+json">
{"url":"http://localhost:4000/page-3/","headline":"Home","dateModified":null,"datePublished":null,"sameAs":null,"image":null,"mainEntityOfPage":null,"name":null,"author":{"@type":"Person","name":"Yi Zhang"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icons/icon.png"},"name":"Yi Zhang"},"description":"The official Hydejack blog. Version updates, example content and how-to guides on how to blog with Jekyll. Open index.html to edit this text.","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  


<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="yizhang82's blog">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<meta name="application-name" content="yizhang82's blog">
<meta name="msapplication-config" content="/assets/ieconfig.xml">


<meta name="theme-color" content="#193747">


<meta name="generator" content="Hydejack v8.4.0" />

<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="yizhang82's blog" />



<link rel="alternate" href="http://localhost:4000/page-3/" hreflang="en">

<link rel="shortcut icon" href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon.png">

<link rel="manifest" href="/assets/manifest.json">


  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">


  <link rel="dns-prefetch" href="https://www.google-analytics.com">



<link rel="dns-prefetch" href="/" id="_baseURL">
<link rel="dns-prefetch" href="/assets/js/hydejack-8.4.0.js" id="_hrefJS">
<link rel="dns-prefetch" href="/sw.js" id="_hrefSW">
<link rel="dns-prefetch" href="/assets/bower_components/fontfaceobserver/fontfaceobserver.standalone.js" id="_hrefFFO">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js" id="_hrefKatexJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_hrefKatexCSS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.js" id="_hrefKatexCopyJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.css" id="_hrefKatexCopyCSS">
<link rel="dns-prefetch" href="/assets/img/swipe.svg" id="_hrefSwipeSVG">



<link rel="dns-prefetch" href="https://yizhang82.disqus.com" id="_hrefDisqus">


<script>!function(e,t){"use strict";function n(e,t,n,r){e.addEventListener?e.addEventListener(t,n,r):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,r){var o=t.createElement("script");o.src=e,r&&n(o,"load",r,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(o,a),o},e._loaded=!1,e.loadJSDeferred=function(r,o){function a(){e._loaded=!0,o&&n(d,"load",o,{once:!0});var r=t.scripts[0];r.parentNode.insertBefore(d,r)}var d=t.createElement("script");return d.src=r,e._loaded?a():n(e,"load",a,{once:!0}),d},e.setRel=e.setRelStylesheet=function(e){function n(){this.rel="stylesheet"}var r=t.getElementById(e);r.addEventListener?r.addEventListener("load",n,{once:!0}):r.onload=n}}(window,document);
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
</script>

<script>!function(w, d) {
    w._noPushState = false;
    w._noDrawer = false;

    /**/
    loadJS(d.getElementById('_hrefFFO').href, function() {
      if ('Promise' in w) Promise.all([
        new FontFaceObserver('Noto Sans').load(),
        new FontFaceObserver('Roboto Slab').load(),
      ]).then(function f() { d.body.classList.add('font-active'); }, function() {});
    });
    /**/
}(window, document);</script>

<!--[if gt IE 8]><!---->








  <link rel="stylesheet" href="/assets/css/hydejack-8.4.0.css">
  <link rel="stylesheet" href="/assets/icomoon/style.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Noto+Sans:400,400i,700,700i">
    <noscript>
      <style>
        html { font-family: Noto Sans, Helvetica, Arial, sans-serif!important; }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Roboto Slab, Helvetica, Arial, sans-serif!important; }
      </style>
    </noscript>
  


  <style id="_pageStyle">

.content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba !important}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus,.form-control:focus,.form-control.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}

</style>


<!--<![endif]-->




</head>

<body>
  <div id="_navbar" class="navbar fixed-top">
  <div class="content">
    <div class="nav-btn-bar">
      <span class="sr-only">Jump to:</span>
      <a id="_menu" class="nav-btn no-hover fl" href="#_navigation">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>
    </div>
  </div>
</div>
<hr class="sr-only" hidden />


<hy-push-state
  replace-ids="_main"
  link-selector="a[href]:not([href*='/assets/']):not(.external):not(.no-push-state)"
  duration="250"
  script-selector="script:not([type^='math/tex'])"
  prefetch
>
  
    <hy-drawer
  class="cover"
  align="left"
  threshold="10"
  touch-events
  prevent-default
>
  <header id="_sidebar" class="sidebar" role="banner">
    
    <div class="sidebar-bg sidebar-overlay" style="background-color:#4fb1ba;background-image:url(/assets/img/sidebar-bg.jpg)"></div>

    <div class="sidebar-sticky">
      <div class="sidebar-about">
        
          <a class="no-hover" href="/" tabindex="-1">
            <img src="/assets/icons/icon.png" class="avatar" alt="yizhang82's blog" data-ignore />
          </a>
        
        <h2 class="h1"><a href="/">yizhang82's blog</a></h2>
        
        
          <p class="">
            Languages, Runtime, Data structures, Databases, and everything in between

          </p>
        
      </div>

      <nav class="sidebar-nav heading" role="navigation">
        <span class="sr-only">Navigation:</span>
<ul>
  
    
    
    

    
      
        <li>
          <a
            id="_navigation"
            href="/blog/"
            class="sidebar-nav-item"
            
            >
            Blog archive
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/dotnet/"
            class="sidebar-nav-item"
            
            >
            .NET / .NET Core
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/database/"
            class="sidebar-nav-item"
            
            >
            Database
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/interop/"
            class="sidebar-nav-item"
            
            >
            Interop
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/about/"
            class="sidebar-nav-item"
            
            >
            About me
          </a>
        </li>
      
    
  
</ul>

      </nav>

      

      <div class="sidebar-social">
        <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://twitter.com/<username>" title="Twitter" class="no-mark-external">
      <span class="icon-twitter"></span>
      <span class="sr-only">Twitter</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/<username>" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
  
</ul>

      </div>
    </div>
  </header>
</hy-drawer>
<hr class="sr-only" hidden />

    <main
  id="_main"
  class="content fade-in layout-blog"
  role="main"
  data-color="#4fb1ba"
  data-theme-color="#193747"
  
    data-image="/assets/img/sidebar-bg.jpg"
    data-overlay
  
  >
  


  
    




<article id="post-nes-emu-main-loop" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/nes-emu-main-loop" class="flip-title">
        Writing your own NES emulator - writing the main loop
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2018-02-22T00:00:00-08:00">22 Feb 2018</time>
      
      
      
      
      









in <span>Nes</span> / <span>Emulator</span>

      











    </p>

    
    

    



  
    <p class="message" >
      Writing your own NES emulator - writing the main loop

    </p>
  


  </header>

  
    <p>In <a href="/nes-emu-overview">last post</a> I’ve talked how one would start writing a emulator. Now it’s time to dive a bit deeper to see how we write the main loop to drive the emulation.</p>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/nes-emu-main-loop">Writing your own NES emulator - writing the main loop</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-ref-count-handle" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/ref-counted-handle" class="flip-title">
        Top secret .NET handles - Part 2 - Ref-Counted handles
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2018-02-12T00:00:00-08:00">12 Feb 2018</time>
      
      
      
      
      









in <span>Gc</span> / <span>Handle</span> / <a href="/category/dotnet/" class="flip-title">.NET / .NET Core</a> / <span>C#</span> / <a href="/category/interop/" class="flip-title">Interop</a>

      











    </p>

    
    

    



  
    <p class="message" >
      Top secret .NET handles - Part 2 - Ref-Counted handles

    </p>
  


  </header>

  
    <p><a href="/dependent-handle">Last time</a> we talked about .NET dependent handle. It is a handle that promotes secondary if primary is promoted - as if there is a imaginary reference between them. This time let’s take a look at another secret handle - ref-counted handle. A ref-counted handle is a special handle that will become either strong or weak depending on the ref count. It’s only used in COM interop today internally in the CLR.</p>

<p>You can find its definition in <a href="https://github.com/dotnet/coreclr/blob/dev/release/2.0.0/src/gc/gcinterface.h#L311-L321">gcinterface.h</a></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/*
     * REFCOUNTED HANDLES
     *
     * Refcounted handles are handles that behave as strong handles while the
     * refcount on them is greater than 0 and behave as weak handles otherwise.
     *
     * N.B. These are currently NOT general purpose.
     *      The implementation is tied to COM Interop.
     *
     */</span>
    <span class="n">HNDTYPE_REFCOUNTED</span>   <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</code></pre></div></div>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/ref-counted-handle">Top secret .NET handles - Part 2 - Ref-Counted handles</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-dependent-handle" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/dependent-handle" class="flip-title">
        Top secret .NET handles - Part 1 - Dependent handles
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2018-01-24T00:00:00-08:00">24 Jan 2018</time>
      
      
      
      
      









in <span>Gc</span> / <span>Handle</span> / <a href="/category/dotnet/" class="flip-title">.NET / .NET Core</a> / <span>C#</span>

      











    </p>

    
    

    



  
    <p class="message" >
      Top secret .NET handles - Part 1 - Dependent handles

    </p>
  


  </header>

  
    <p>.NET publicly has documented 4 kind of handles:</p>

<ol>
  <li>
    <p><em>Weak</em> (also called Short Weak) - Don’t keep target object alive and will return null when object is gone. The target will become null when the object enters for finalization.</p>
  </li>
  <li>
    <p><em>WeakTrackResurrection</em> (also called Long Weak) - Don’t keep target object alive and will return null when object is gone. It’ll return the object even when the object is being finalized or resurrected.</p>
  </li>
  <li>
    <p><em>Normal</em> (also called strong) - keeps target object alive. If you are not careful, you may leak the object.</p>
  </li>
  <li>
    <p><em>Pinned</em> - Keeps the target object alive and prevents GC from moving this object around. Useful when you are passing this object to native code, as native code won’t know if GC moved it. Note that using a lot of pinning handles may degrade GC performance. The most common offender is pinned strings/arrays in interop calls.</p>
  </li>
</ol>

<p>You can also find them described in <a href="https://msdn.microsoft.com/en-us/library/83y4ak54.aspx">GCHandle enumeration</a>.</p>

<p>However, besides these 4 types, there are actually more secret internal handle types that are not exposed. In this post I’ll be talking about dependent handle, and why it is totally awesome.</p>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/dependent-handle">Top secret .NET handles - Part 1 - Dependent handles</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-python-interop-3" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/python-interop-inside-ctypes" class="flip-title">
        Calling C functions from Python - part 3 - deep dive into ctypes implementation in CPython
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2018-01-22T00:00:00-08:00">22 Jan 2018</time>
      
      
      
      
      









in <span>Python</span> / <a href="/category/interop/" class="flip-title">Interop</a> / <span>Ctypes</span> / <span>Cpython</span> / <span>Vm</span> / <span>Runtime</span>

      











    </p>

    
    

    



  
    <p class="message" >
      Calling C functions from Python - part 3 - deep dive into ctypes implementation in CPython

    </p>
  


  </header>

  
    <p>Last time we’ve looked at using ctypes to call C API, and writing extension module using Python/C API. Now we can finally tie these two together - looking at how ctypes is actually implemented using mix of Python/C API  and Python code.</p>

<ul>
  <li>You can find CPython source code <a href="https://github.com/python/cpython">here</a>.</li>
  <li>ctypes’ C implementation is <a href="https://github.com/python/cpython/tree/master/Modules/_ctypes">here</a></li>
  <li>ctypes’ python implementation is <a href="https://github.com/python/cpython/tree/master/Lib/ctypes">here</a>.</li>
</ul>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/python-interop-inside-ctypes">Calling C functions from Python - part 3 - deep dive into ctypes implementation in CPython</a>

      </p>
    </footer>
  
</article>

  
    




<article id="post-python-interop-2" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      <a href="/python-interop-capi" class="flip-title">
        Calling C functions from Python - part 2 - writing CPython extensions using Python/C API
      </a>
    </h1>

    <p class="post-date heading">
      
      <time datetime="2018-01-15T00:00:00-08:00">15 Jan 2018</time>
      
      
      
      
      









in <span>Python</span> / <span>Cpython</span> / <a href="/category/interop/" class="flip-title">Interop</a> / <span>Extensions</span>

      











    </p>

    
    

    



  
    <p class="message" >
      Calling C functions from Python - part 2 - writing CPython extensions using Python/C API

    </p>
  


  </header>

  
    <p>In my <a href="http://yizhang82.me/python-interop-ctypes">previous post</a> we’ve briefly looked at using ctypes module to call C APIs. In this post let’s dive into a completely different approach - writing a C extension using Python/C API. From the C extension you can then call whatever C/C++ code you want. This is a pretty popular approach to expose a 3rd party C library as python module. The downside is this module would only be loaded by CPython, which is usually not a big issue - unless you use other Python implementation like <a href="http://pypy.org/">PyPy</a>.</p>



    
    
    <footer>
      <p class="read-more">
        Continue reading <a class="heading flip-title" href="/python-interop-capi">Calling C functions from Python - part 2 - writing CPython extensions using Python/C API</a>

      </p>
    </footer>
  
</article>

  

  <h2 class="sr-only">Pagination</h2>
<nav class="pagination heading clearfix" role="navigation">
  <ul>
    <li class="pagination-item older" >
      
      
      
  <a
    class=" "
    href="/page-4/"
    rel="next"
    
  >
    Older
  </a>


    </li>
    <li class="pagination-item newer" >
      
      
      
  <a
    class=" "
    href="/page-2/"
    rel="prev"
    
  >
    Newer
  </a>


    </li>
  </ul>
</nav>



  

  
<footer role="contentinfo">
  <hr/>
  
    <p><small class="copyright">© 2017. All rights reserved.
</small></p>
  
  
  <p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">8.4.0</span></small></p>
  <hr class="sr-only"/>
</footer>


</main>

  
</hy-push-state>


  <!--[if !IE]><!---->
  <script>loadJSDeferred(document.getElementById('_hrefJS').href);</script>
  

  <!--<![endif]-->

  
  <script>!function(w, d) {
    w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;

    /**/
      ga('create', 'UA-93224322-1', 'auto');
    /**/

    var pushStateEl = d.getElementsByTagName('hy-push-state')[0];
    var timeoutId;
    pushStateEl.addEventListener('hy-push-state-load', function() {
      w.clearTimeout(timeoutId);
      timeoutId = w.setTimeout(function() {
        ga('set', 'page', w.location.pathname);
        ga('send', 'pageview');
      }, 500);
    });

    d.addEventListener('hy--cookies-ok', function () {
      w.ga(function(tracker) {
        w.ga("set", "anonymizeIp", undefined);
        localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId"));
      });
    });

    w.loadJSDeferred('https://www.google-analytics.com/analytics.js');
  }(window, document);</script>



  <script>
    if ('serviceWorker' in navigator) {
      
        navigator.serviceWorker.getRegistration()
          .then(r => r.unregister())
          .catch(() => {});
      
    }
  </script>






<h2 class="sr-only" hidden>Templates (for web app):</h2>

<template id="_animation-template" hidden>
  <div class="animation-main fixed-top">
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

<template id="_loading-template" hidden>
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

<template id="_error-template" hidden>
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

<template id="_back-template" hidden>
  <a id="_back" class="back nav-btn fl no-hover">
    <span class="sr-only">Back</span>
    <span class="icon-arrow-left2"></span>
  </a>
</template>

<template id="_permalink-template" hidden>
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="icon-link"></span>
  </a>
</template>




</body>
</html>
