<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v8.4.0 <https://hydejack.com/>
-->











<head>
  



<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">




  
<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>CoreCLR’s environment is not your environment | yizhang82’s blog</title>
<meta property="og:title" content="CoreCLR’s environment is not your environment" />
<meta name="author" content="Yi Zhang" />
<meta property="og:locale" content="en" />
<meta name="description" content="CoreCLR maintains its own private copy of environment variables" />
<meta property="og:description" content="CoreCLR maintains its own private copy of environment variables" />
<link rel="canonical" href="http://localhost:4000/set-environment-variable" />
<meta property="og:url" content="http://localhost:4000/set-environment-variable" />
<meta property="og:site_name" content="yizhang82’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-28T00:00:00-08:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/set-environment-variable","headline":"CoreCLR’s environment is not your environment","dateModified":"2019-02-28T00:00:00-08:00","datePublished":"2019-02-28T00:00:00-08:00","sameAs":null,"image":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/set-environment-variable"},"name":null,"author":{"@type":"Person","name":"Yi Zhang"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/icons/icon.png"},"name":"Yi Zhang"},"description":"CoreCLR maintains its own private copy of environment variables","@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  


<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="yizhang82's blog">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<meta name="application-name" content="yizhang82's blog">
<meta name="msapplication-config" content="/assets/ieconfig.xml">


<meta name="theme-color" content="#193747">


<meta name="generator" content="Hydejack v8.4.0" />

<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="yizhang82's blog" />



<link rel="alternate" href="http://localhost:4000/set-environment-variable" hreflang="en">

<link rel="shortcut icon" href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon.png">

<link rel="manifest" href="/assets/manifest.json">


  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">


  <link rel="dns-prefetch" href="https://www.google-analytics.com">



<link rel="dns-prefetch" href="/" id="_baseURL">
<link rel="dns-prefetch" href="/assets/js/hydejack-8.4.0.js" id="_hrefJS">
<link rel="dns-prefetch" href="/sw.js" id="_hrefSW">
<link rel="dns-prefetch" href="/assets/bower_components/fontfaceobserver/fontfaceobserver.standalone.js" id="_hrefFFO">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js" id="_hrefKatexJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_hrefKatexCSS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.js" id="_hrefKatexCopyJS">
<link rel="dns-prefetch" href="/assets/bower_components/katex/dist/contrib/copy-tex.min.css" id="_hrefKatexCopyCSS">
<link rel="dns-prefetch" href="/assets/img/swipe.svg" id="_hrefSwipeSVG">



<link rel="dns-prefetch" href="https://yizhang82.disqus.com" id="_hrefDisqus">


<script>!function(e,t){"use strict";function n(e,t,n,r){e.addEventListener?e.addEventListener(t,n,r):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,r){var o=t.createElement("script");o.src=e,r&&n(o,"load",r,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(o,a),o},e._loaded=!1,e.loadJSDeferred=function(r,o){function a(){e._loaded=!0,o&&n(d,"load",o,{once:!0});var r=t.scripts[0];r.parentNode.insertBefore(d,r)}var d=t.createElement("script");return d.src=r,e._loaded?a():n(e,"load",a,{once:!0}),d},e.setRel=e.setRelStylesheet=function(e){function n(){this.rel="stylesheet"}var r=t.getElementById(e);r.addEventListener?r.addEventListener("load",n,{once:!0}):r.onload=n}}(window,document);
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
</script>

<script>!function(w, d) {
    w._noPushState = false;
    w._noDrawer = false;

    /**/
    loadJS(d.getElementById('_hrefFFO').href, function() {
      if ('Promise' in w) Promise.all([
        new FontFaceObserver('Noto Sans').load(),
        new FontFaceObserver('Roboto Slab').load(),
      ]).then(function f() { d.body.classList.add('font-active'); }, function() {});
    });
    /**/
}(window, document);</script>

<!--[if gt IE 8]><!---->








  <link rel="stylesheet" href="/assets/css/hydejack-8.4.0.css">
  <link rel="stylesheet" href="/assets/icomoon/style.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Noto+Sans:400,400i,700,700i">
    <noscript>
      <style>
        html { font-family: Noto Sans, Helvetica, Arial, sans-serif!important; }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Roboto Slab, Helvetica, Arial, sans-serif!important; }
      </style>
    </noscript>
  


  <style id="_pageStyle">

.content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba !important}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus,.form-control:focus,.form-control.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}

</style>


<!--<![endif]-->




</head>

<body>
  <div id="_navbar" class="navbar fixed-top">
  <div class="content">
    <div class="nav-btn-bar">
      <span class="sr-only">Jump to:</span>
      <a id="_menu" class="nav-btn no-hover fl" href="#_navigation">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>
    </div>
  </div>
</div>
<hr class="sr-only" hidden />


<hy-push-state
  replace-ids="_main"
  link-selector="a[href]:not([href*='/assets/']):not(.external):not(.no-push-state)"
  duration="250"
  script-selector="script:not([type^='math/tex'])"
  prefetch
>
  
    <main
  id="_main"
  class="content fade-in layout-post"
  role="main"
  data-color="#4fb1ba"
  data-theme-color="#193747"
  
    data-image="/assets/img/sidebar-bg.jpg"
    data-overlay
  
  >
  




<article id="post-set-environment-variable" class="page post mb6" role="article">
  <header>
    <h1 class="post-title">
      
        CoreCLR's environment is not your environment
      
    </h1>

    <p class="post-date heading">
      
      <time datetime="2019-02-28T00:00:00-08:00">28 Feb 2019</time>
      
      
      
      
      









in <a href="/category/dotnet/" class="flip-title">.NET / .NET Core</a> / <span>Dotnetcore</span> / <span>Version</span> / <span>Api</span> / <span>Design</span>

      











    </p>

    
    

    



  
    <p class="message" >
      CoreCLR maintains its own private copy of environment variables

    </p>
  


  </header>

  
    <p>This came up when I was helping another collegue in a previous job (where I still write C# code probably 50% of the time), diagnosing a library load failure problem inside a linux container. Internally there is this library that loads different implementations (mock implementation and real implementation) of another library based on a environment variable <code class="highlighter-rouge">USE_MAGIC_TEST_LIB</code>, and the .NET code calling that library is calling <code class="highlighter-rouge">SetEnvironmentVariable</code> to set it conditionally as part of a testing framework:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">useTestFramework</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Environment</span><span class="p">.</span><span class="nf">SetEnvironmentVariable</span><span class="p">(</span><span class="s">"USE_MAGIC_TEST_LIB"</span><span class="p">,</span> <span class="s">"1"</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">NativeCode</span><span class="p">.</span><span class="nf">CallToSomeNativeLibraryThatLoadsDifferentLibraryDependsOnEnv</span><span class="p">();</span>

</code></pre></div></div>

<p>This looks reasonable except that it didn’t work at all. It loaded the wrong library and things quickly went down hill after that.</p>

<p>We were scratching our heads for a while until we decided to add a trace to see if the environment is actually taking effect or not in the native code. Interestingly, the native code didn’t see it at all. It’s like they don’t know about each other’s environment!</p>

<p>Actually that observation is more or less what’s going on. Before we dig in a bit deeper, here is a bit of history of CoreCLR cross-platform implementation. Not surprisingly, .NET code started as Windows centric and all the OS calls are strictly Windows API. At some point folks decide to port it to linux/Mac as part of Rotor (later Silverlight), there are two options:</p>
<ol>
  <li>Design a new platform abstraction from scratch and move it to that</li>
  <li>Align the API design to Windows and implement Windows API on top of Linux API</li>
</ol>

<p>2 is obviously the cheaper solution and has the advantage that Windows code would be untouched and therefore won’t get regressions, which is super important. The caveat is that implementing Windows API using Linux API can get tricky, but is the risk people are willing to take. So the new PAL layer is introduced with “new” APIs that looks exactly like Windows APIs implemented using Linux APIs.</p>

<p>In the case of <code class="highlighter-rouge">SetEnvironmentVariable</code>, it is implemented in PAL/environ.cpp:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span>
<span class="n">PALAPI</span>
<span class="nf">SetEnvironmentVariableA</span><span class="p">(</span>
            <span class="n">IN</span> <span class="n">LPCSTR</span> <span class="n">lpName</span><span class="p">,</span>
            <span class="n">IN</span> <span class="n">LPCSTR</span> <span class="n">lpValue</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...
</span>
    <span class="c1">// All the conditions are met. Set the variable.
</span>    <span class="kt">int</span> <span class="n">iLen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">lpName</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">lpValue</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">LPSTR</span> <span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPSTR</span><span class="p">)</span> <span class="n">PAL_malloc</span><span class="p">(</span><span class="n">iLen</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">string</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">bRet</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">ERROR</span><span class="p">(</span><span class="s">"Unable to allocate memory</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">SetLastError</span><span class="p">(</span><span class="n">ERROR_NOT_ENOUGH_MEMORY</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">sprintf_s</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">iLen</span><span class="p">,</span> <span class="s">"%s=%s"</span><span class="p">,</span> <span class="n">lpName</span><span class="p">,</span> <span class="n">lpValue</span><span class="p">);</span>
    <span class="n">nResult</span> <span class="o">=</span> <span class="n">EnvironPutenv</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">PAL_free</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
    <span class="n">string</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

    <span class="c1">// If EnvironPutenv returns FALSE, it almost certainly failed to allocate memory.
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">nResult</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">bRet</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">ERROR</span><span class="p">(</span><span class="s">"Unable to allocate memory</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">SetLastError</span><span class="p">(</span><span class="n">ERROR_NOT_ENOUGH_MEMORY</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>This looks a bit fishy. It’s allocating its own buffer and calls into EnvironPutenv, which basically does this:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">existingEquals</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sc">'='</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">existingEquals</span> <span class="o">-</span> <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">nameLength</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nameLength</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">free</span><span class="p">(</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">;</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_ASSERTE</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">palEnvironmentCapacity</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">palEnvironmentCapacity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">// We found the first null, but it's the last element in our environment
</span>            <span class="c1">// block. We need more space in our environment, so let's double its size.
</span>            <span class="kt">int</span> <span class="n">resizeRet</span> <span class="o">=</span> <span class="n">ResizeEnvironment</span><span class="p">(</span><span class="n">palEnvironmentCapacity</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">resizeRet</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">free</span><span class="p">(</span><span class="n">copy</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">_ASSERTE</span><span class="p">(</span><span class="n">copy</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">);</span>
        <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">;</span>
        <span class="n">palEnvironment</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="n">palEnvironmentCount</span><span class="o">++</span><span class="p">;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>So it’s basically managing its own memory in <code class="highlighter-rouge">palEnvironment</code> environment array! No wonder things don’t work.</p>

<p>But why go through all the trouble while Linux has its own <code class="highlighter-rouge">getenv</code>/<code class="highlighter-rouge">setenv</code>?</p>

<p>These posts provides the answer:</p>

<p>http://rachelbythebay.com/w/2017/01/30/env/</p>

<blockquote>
  <p>Modifications of environment variables are not allowed in multi-threaded programs.
– the glibc manual</p>
</blockquote>

<p>https://github.com/dotnet/coreclr/issues/635</p>

<blockquote>
  <p>From looking at the code, I suspect that the cached environment was attempt to fix thread safety or consistency problems between Environment.GetEnvironmentVariables and Environment.SetEnvironmentVariable.</p>
</blockquote>

<blockquote>
  <p>The enumeration of the environment starts by reading the <a href="http://linux.die.net/man/5/environ">environ</a> global variable, without any locks. Consider what may happen if somebody calls setenv while the enumeration is in progress.</p>
</blockquote>

<p>It’s because <code class="highlighter-rouge">setenv</code>/<code class="highlighter-rouge">getenv</code> isn’t particularly thread safe - you can crash when reading environment while the environment get modifed by another thread, or two threads modifying environment at the same time can lead to leaks.</p>

<p>In this case, one can see a few options:</p>

<ol>
  <li>Do nothing - the issues are linux-specific and you should take care when calling these functions, the same way just like you call them in linux.</li>
  <li>Throw PlatformNotSupported - getenv/setenv just isn’t safe</li>
  <li>Adding critical section around getenv/setenv - make them safe to be called in multiple threads</li>
  <li>Implement your own safe environment helpers - as a result rest of the native library won’t observe the change through <code class="highlighter-rouge">getenv</code>/<code class="highlighter-rouge">setenv</code></li>
</ol>

<p>1 isn’t really acceptable because .NET developers need the code to be portable - they don’t want handle the platform special oddies to make their code portable. They would like .NET platform library to be safe and reliable.</p>

<p>2 isn’t great either for the same reason, and also it’ll break a ton of code when ported to linux.</p>

<p>3 makes .NET code safe, but it wouldn’t protect against native code racing with getenv/setenv calls from within .NET code, so race conditions would still occur and .NET developer has little control.</p>

<p>4 is safe, but can lead to subtle breaking changes.</p>

<p>Unfortunately there isn’t a great option here. 1, 2, and 4 are safe option, but all of them have their downsides. At the end of the day, it comes down to compatibility/portability vs surprising behavior. .NET team favors compatibility and portability. While it can lead to sutble breaking changes, fortunately the breaking changes are consistent and therefore easier to diagnose. In our case being a container launched by another system makes the whole thing much harder to diagnose, but that’s more a problem of the container launcher itself. Even though we were bit by the very same problem, I agree it is most likely the better choice.</p>

<p>For more information, you can refer to CoreCLR code here:</p>

<p>https://github.com/dotnet/coreclr/blob/master/src/pal/src/misc/environ.cpp#L607</p>

<p>And here is a simple code snippet to demonstrate the issue. I’ve tested this on my MBP.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>


<span class="k">namespace</span> <span class="nn">set_env</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"/usr/lib/system/libsystem_c.dylib"</span><span class="p">)]</span>
        <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">getenv</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">);</span>

        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"/usr/lib/system/libsystem_c.dylib"</span><span class="p">)]</span>
        <span class="k">static</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">setenv</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="k">value</span><span class="p">);</span>

         <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">envName</span> <span class="p">=</span> <span class="s">"MY_ENV"</span><span class="p">;</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"MY_ENV={0}"</span><span class="p">,</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="n">envName</span><span class="p">));</span>

            <span class="n">Environment</span><span class="p">.</span><span class="nf">SetEnvironmentVariable</span><span class="p">(</span><span class="n">envName</span><span class="p">,</span> <span class="s">"~/path"</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Setting it to ~/path"</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"MY_ENV={0}"</span><span class="p">,</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="n">envName</span><span class="p">));</span>

            <span class="n">IntPtr</span> <span class="n">env</span> <span class="p">=</span> <span class="nf">getenv</span><span class="p">(</span><span class="n">envName</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">envStr</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStringAnsi</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"getenv(MY_ENV)={0}"</span><span class="p">,</span> <span class="n">envStr</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Setting it using setenv"</span><span class="p">);</span>
            <span class="nf">setenv</span><span class="p">(</span><span class="n">envName</span><span class="p">,</span> <span class="s">"~/path"</span><span class="p">);</span>

            <span class="n">env</span> <span class="p">=</span> <span class="nf">getenv</span><span class="p">(</span><span class="n">envName</span><span class="p">);</span>
            <span class="n">envStr</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStringAnsi</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"getenv(MY_ENV)={0}"</span><span class="p">,</span> <span class="n">envStr</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now if you are interested to dig in a bit more, here are some bonus questions for your consideration:</p>
<ol>
  <li>Does the same problem happen in Windows? And why/why not?</li>
  <li>Why does the above code above use <code class="highlighter-rouge">Marshal.PtrToStringAnsi</code> instead of just have <code class="highlighter-rouge">getenv</code> returning the string?</li>
</ol>

<p>That’s all for now. Thanks for reading!</p>

  
</article>


<hr class="dingbat related" />




  
     


  <aside class="about related mt4 mb4" role="complementary">
    
    

<div class="author mt4">
  

  
    


  <hy-img
    
    src="https://placehold.it/128x128"
    class="avatar"
    alt="<firstname> <lastname>"
    srcset="https://placehold.it/128x128 1x,https://placehold.it/256x256 2x"
    
  
    
    root-margin="512px"
  >
    <noscript><img data-ignore 
    src="https://placehold.it/128x128"
    class="avatar"
    alt="<firstname> <lastname>"
    srcset="https://placehold.it/128x128 1x,https://placehold.it/256x256 2x"
    
  /></noscript>
    <span class="loading" slot="loading" hidden>
      <span class="icon-cog"></span>
    </span>
  </hy-img>


  

  
  
  <h2  class="page-title hr">
    About
  </h2>

  <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit,
sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>

<p>Open <code class="highlighter-rouge">_data/authors.yml</code> to edit this text.</p>

<p><a href="https://github.com/qwtel/hydejack-starter-kit/archive/v8.1.1.zip">Download Free</a>
– or –
<a href="https://app.simplegoods.co/i/NATYVLYT">Buy PRO</a></p>



  <div class="sidebar-social">
    <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://twitter.com/<username>" title="Twitter" class="no-mark-external">
      <span class="icon-twitter"></span>
      <span class="sr-only">Twitter</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/<username>" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
  
</ul>

  </div>
</div>

  </aside>


  

  
  

  
    




<aside class="related mb4" role="complementary">
  <h2 class="hr">Related Posts</h2>

  <ul class="related-posts">
    
      


<li>
  <a href="/process-startinfo" class="h4 flip-title">
    <span>The tale of InvalidOperationException</span>
  </a>
  <time class="heading faded fine" datetime="2018-07-12T00:00:00-07:00">12 Jul 2018</time>
</li>

    
      


<li>
  <a href="/dotnet-generics-typeof-t" class="h4 flip-title">
    <span>typeof(TSecret) - the secret magic behind .NET generics</span>
  </a>
  <time class="heading faded fine" datetime="2018-04-09T00:00:00-07:00">09 Apr 2018</time>
</li>

    
      


<li>
  <a href="/ref-counted-handle" class="h4 flip-title">
    <span>Top secret .NET handles - Part 2 - Ref-Counted handles</span>
  </a>
  <time class="heading faded fine" datetime="2018-02-12T00:00:00-08:00">12 Feb 2018</time>
</li>

    
  </ul>
</aside>

  


  
<aside class="comments related" role="complementary">
  <h2 class="hr">Comments</h2>
  

<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script>!function(w, d) {
  if (d.getElementById("disqus_thread")) {
    if (w.DISQUS) {
      w.DISQUS.reset({
        reload: true,
        config() {
          this.page.url = w.location.href;
          this.page.title = d.title;
        },
      });
    } else {
      w.disqus_config = function disqusConfig() {
        this.page.url = w.location.href;
        this.page.title = d.title;
      };
      w.loadJSDeferred(d.getElementById("_hrefDisqus").href + '/embed.js');
    }
  }
}(window, document);</script>


</aside>


  
<footer role="contentinfo">
  <hr/>
  
    <p><small class="copyright">© 2017. All rights reserved.
</small></p>
  
  
  <p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">8.4.0</span></small></p>
  <hr class="sr-only"/>
</footer>


</main>

    <hy-drawer
  class=""
  align="left"
  threshold="10"
  touch-events
  prevent-default
>
  <header id="_sidebar" class="sidebar" role="banner">
    
    <div class="sidebar-bg sidebar-overlay" style="background-color:#4fb1ba;background-image:url(/assets/img/sidebar-bg.jpg)"></div>

    <div class="sidebar-sticky">
      <div class="sidebar-about">
        
          <a class="no-hover" href="/" tabindex="-1">
            <img src="/assets/icons/icon.png" class="avatar" alt="yizhang82's blog" data-ignore />
          </a>
        
        <h2 class="h1"><a href="/">yizhang82's blog</a></h2>
        
        
          <p class="">
            Languages, Runtime, Data structures, Databases, and everything in between

          </p>
        
      </div>

      <nav class="sidebar-nav heading" role="navigation">
        <span class="sr-only">Navigation:</span>
<ul>
  
    
    
    

    
      
        <li>
          <a
            id="_navigation"
            href="/blog/"
            class="sidebar-nav-item"
            
            >
            Blog archive
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/dotnet/"
            class="sidebar-nav-item"
            
            >
            .NET / .NET Core
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/database/"
            class="sidebar-nav-item"
            
            >
            Database
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/category/interop/"
            class="sidebar-nav-item"
            
            >
            Interop
          </a>
        </li>
      
    
      
        <li>
          <a
            
            href="/about/"
            class="sidebar-nav-item"
            
            >
            About me
          </a>
        </li>
      
    
  
</ul>

      </nav>

      

      <div class="sidebar-social">
        <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://twitter.com/<username>" title="Twitter" class="no-mark-external">
      <span class="icon-twitter"></span>
      <span class="sr-only">Twitter</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/<username>" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
  
</ul>

      </div>
    </div>
  </header>
</hy-drawer>
<hr class="sr-only" hidden />

  
</hy-push-state>


  <!--[if !IE]><!---->
  <script>loadJSDeferred(document.getElementById('_hrefJS').href);</script>
  

  <!--<![endif]-->

  
  <script>!function(w, d) {
    w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;

    /**/
      ga('create', 'UA-93224322-1', 'auto');
    /**/

    var pushStateEl = d.getElementsByTagName('hy-push-state')[0];
    var timeoutId;
    pushStateEl.addEventListener('hy-push-state-load', function() {
      w.clearTimeout(timeoutId);
      timeoutId = w.setTimeout(function() {
        ga('set', 'page', w.location.pathname);
        ga('send', 'pageview');
      }, 500);
    });

    d.addEventListener('hy--cookies-ok', function () {
      w.ga(function(tracker) {
        w.ga("set", "anonymizeIp", undefined);
        localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId"));
      });
    });

    w.loadJSDeferred('https://www.google-analytics.com/analytics.js');
  }(window, document);</script>



  <script>
    if ('serviceWorker' in navigator) {
      
        navigator.serviceWorker.getRegistration()
          .then(r => r.unregister())
          .catch(() => {});
      
    }
  </script>






<h2 class="sr-only" hidden>Templates (for web app):</h2>

<template id="_animation-template" hidden>
  <div class="animation-main fixed-top">
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

<template id="_loading-template" hidden>
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

<template id="_error-template" hidden>
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

<template id="_back-template" hidden>
  <a id="_back" class="back nav-btn fl no-hover">
    <span class="sr-only">Back</span>
    <span class="icon-arrow-left2"></span>
  </a>
</template>

<template id="_permalink-template" hidden>
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="icon-link"></span>
  </a>
</template>




</body>
</html>
