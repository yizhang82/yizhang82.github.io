<h2 id="callback-pain">Callback pain</h2>

<p>I was experimenting with <a href="https://github.com/mapbox/node-sqlite3">sqlite package</a> with node.js the other day and the async programming style is rather painful, so I did some experiment to wrap it with promise + async/await to make it easier to use. This post shows you how to do that.</p>

<p>For example, let’s say I’m working with a database with a <code class="highlighter-rouge">Voters</code> table that has two fields - <code class="highlighter-rouge">Name</code> and <code class="highlighter-rouge">Count</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">sqlite</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'sqlite3'</span><span class="p">).</span><span class="nx">verbose</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sqlite</span><span class="p">.</span><span class="nx">Database</span><span class="p">(</span><span class="s1">'test_db'</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'sqlite3...'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">stmt</span> <span class="o">=</span> <span class="s2">"CREATE TABLE IF NOT EXISTS Voters (Name TEXT, Count int)"</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">stmt</span><span class="p">);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">stmt</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>                        
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">vote</span><span class="p">(</span><span class="s2">"john doe"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`New vote for John Doe is </span><span class="p">${</span><span class="nx">val</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>
<p>And I need to write a function that increase the vote count by 1 or add a new voter entry for a specific voter:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">vote</span><span class="p">(</span><span class="nx">voter</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">val</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">getStmt</span> <span class="o">=</span> <span class="s2">`SELECT Name, Count FROM Voters WHERE Name="</span><span class="p">${</span><span class="nx">voter</span><span class="p">}</span><span class="s2">"`</span><span class="p">;</span>
    <span class="nx">db</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">getStmt</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">row</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">row</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">insertSql</span> <span class="o">=</span> <span class="s2">`INSERT INTO Voters (Name, Count) VALUES ("</span><span class="p">${</span><span class="nx">voter</span><span class="p">}</span><span class="s2">", 1)`</span><span class="p">;</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">insertSql</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span>    
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">val</span> <span class="o">=</span> <span class="nx">row</span><span class="p">[</span><span class="s2">"Count"</span><span class="p">];</span>
            <span class="nx">val</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">updateSql</span> <span class="o">=</span> <span class="s2">`UPDATE Voters SET Count = </span><span class="p">${</span><span class="nx">val</span><span class="p">}</span><span class="s2"> WHERE Name = "</span><span class="p">${</span><span class="nx">voter</span><span class="p">}</span><span class="s2">"`</span><span class="p">;</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">updateSql</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see, the async callback style gets pretty painful here. You need to pass a callback to every function that returns an error or result, and within that callback you need to nest your remaining logic, and on and on. Writing a custom function <code class="highlighter-rouge">vote</code> also need to pass a callback and call when the final callback is done. The code is difficult to read and maintain.</p>

<h2 id="the-promise-land">The promise land</h2>

<p>In ES6, you can wrap callback based functions with Promise, which are essentially a return value with state (pending, resolved, rejected). If a function returns a Promise, it’s the function’s job to either resolve or reject it eventually, so that the caller knows when it’s done - either successfully or unsuccessfully.</p>

<p>It’s best to demonstrate this with an example:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">getAsync</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">sql</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">row</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="nx">resolve</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div></div>

<p>In this function, we are wrapping sqlite <code class="highlighter-rouge">get</code> method and make it returns a promise. When do we know the promise is going to be fullfilled? When the callback arrives. If it fails, call reject and pass the error. If it succeeded, pass the result.</p>

<p>Once you have getAsync, you can now call the function like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">db</span><span class="p">.</span><span class="nx">getAsync</span><span class="p">(</span><span class="nx">stmt</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// print row</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// handle error</span>
<span class="p">});</span>    
</code></pre></div></div>

<p>With the returned promise, you need to chain the promise with the next work using <code class="highlighter-rouge">then</code>, and handle the unhandled error with <code class="highlighter-rouge">catch</code>. The way to think about the <code class="highlighter-rouge">then</code> function is to treat them as a list of work - the next work inside the <code class="highlighter-rouge">then</code> callback will only get executed when the previous promise gets fullfilled. If it succeeded, then will get called next, otherwise <code class="highlighter-rouge">catch</code> is called with the error. If your <code class="highlighter-rouge">then</code> callback wants to do more work, it needs to return another promise that you can chain further using then.</p>

<p>With this, our vote code would look like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">voteAsync</span><span class="p">(</span><span class="nx">voter</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">val</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">getStmt</span> <span class="o">=</span> <span class="s2">`SELECT Name, Count FROM Voters WHERE Name="</span><span class="p">${</span><span class="nx">voter</span><span class="p">}</span><span class="s2">"`</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getAsync</span><span class="p">(</span><span class="nx">getStmt</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">row</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">insertSql</span> <span class="o">=</span> <span class="s2">`INSERT INTO Voters (Name, Count) VALUES ("</span><span class="p">${</span><span class="nx">voter</span><span class="p">}</span><span class="s2">", 1)`</span><span class="p">;</span>
            <span class="nx">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">runAsync</span><span class="p">(</span><span class="nx">insertSql</span><span class="p">);</span>  <span class="c1">// more work to do</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">val</span> <span class="o">=</span> <span class="nx">row</span><span class="p">[</span><span class="s2">"Count"</span><span class="p">];</span>
            <span class="nx">val</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">updateSql</span> <span class="o">=</span> <span class="s2">`UPDATE Voters SET Count = </span><span class="p">${</span><span class="nx">val</span><span class="p">}</span><span class="s2"> WHERE Name = "</span><span class="p">${</span><span class="nx">voter</span><span class="p">}</span><span class="s2">"`</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">runAsync</span><span class="p">(</span><span class="nx">updateSql</span><span class="p">);</span>  <span class="c1">// more work to do</span>
        <span class="p">}</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>     <span class="c1">// when runAsync is done</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note how voteAsync chains multiple promise together by returning another promise (from <code class="highlighter-rouge">runAsync</code>) and then applying <code class="highlighter-rouge">then</code> on top of that promise.</p>

<p>To call the code, it looks like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">stmt</span> <span class="o">=</span> <span class="s2">"CREATE TABLE IF NOT EXISTS Voters (Name TEXT, Count int)"</span><span class="p">;</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">runAsync</span><span class="p">(</span><span class="nx">stmt</span><span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">voteAsync</span><span class="p">(</span><span class="s2">"john doe"</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">val</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`New vote for John Doe is </span><span class="p">${</span><span class="nx">val</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
<span class="p">});</span>    
</code></pre></div></div>

<p>This is an improvement, but still not quite as natural as you need to explicitly chain then using promise functions and follow those pattern.</p>

<h2 id="asyncaawait">Async/Aawait</h2>

<p>Fortunately, there are better ways to do this. With async/await support in node.js, you can write these async code just like how you would write regular synchronous code. That is, all javascript statements are <em>serialized</em>. The async/await infrastructure makes sure your code is split into multiple “phases” just like how you would write it in an promise <code class="highlighter-rouge">then</code> pattern, except that compiler does all the job for you. And all you need to do is to write this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">voteAsync</span><span class="p">(</span><span class="nx">voter</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">val</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">getStmt</span> <span class="o">=</span> <span class="s2">`SELECT Name, Count FROM Voters WHERE Name="</span><span class="p">${</span><span class="nx">voter</span><span class="p">}</span><span class="s2">"`</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getAsync</span><span class="p">(</span><span class="nx">getStmt</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">row</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">insertSql</span> <span class="o">=</span> <span class="s2">`INSERT INTO Voters (Name, Count) VALUES ("</span><span class="p">${</span><span class="nx">voter</span><span class="p">}</span><span class="s2">", 1)`</span><span class="p">;</span>
        <span class="kr">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">runAsync</span><span class="p">(</span><span class="nx">insertSql</span><span class="p">);</span>
        <span class="nx">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">val</span> <span class="o">=</span> <span class="nx">row</span><span class="p">[</span><span class="s2">"Count"</span><span class="p">];</span>
        <span class="nx">val</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">updateSql</span> <span class="o">=</span> <span class="s2">`UPDATE Voters SET Count = </span><span class="p">${</span><span class="nx">val</span><span class="p">}</span><span class="s2"> WHERE Name = "</span><span class="p">${</span><span class="nx">voter</span><span class="p">}</span><span class="s2">"`</span><span class="p">;</span>
        <span class="kr">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">runAsync</span><span class="p">(</span><span class="nx">updateSql</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The code isn’t significantly smaller, but the logic is much simplified. You don’t need to think in terms of promise chaining - you just write the code without worrying about the underlying “async-ness” of those calls. You do need to call <code class="highlighter-rouge">await</code> operator on functions that returns promise, and the compiler automatically</p>
<ul>
  <li>suspends the execution when the promise is in-progress but not done. This is very important as you don’t want to block node.js main event loop.</li>
  <li>resumes execution when the promise resolves</li>
  <li>throw exception when promise rejects.</li>
</ul>

<p>The function also needs to have <code class="highlighter-rouge">async</code> keyword to indicate it is a async function. Without it compiler will refuse to understand await keyword.</p>

<p>To call the async version, just call the function like a normal person (with await, of course):</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stmt</span> <span class="o">=</span> <span class="s2">"CREATE TABLE IF NOT EXISTS Voters (Name TEXT, Count int)"</span><span class="p">;</span>
        <span class="kr">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">runAsync</span><span class="p">(</span><span class="nx">stmt</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">voteAsync</span><span class="p">(</span><span class="s2">"john doe"</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`New vote for John Doe is </span><span class="p">${</span><span class="nx">val</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="p">}</span> 
    <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ex</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Again, this is slightly more code due to the try/catch and function goo (javascript doesn’t let you call await without an async function), but the concepts are significantly simpler to understand and code much easier to write.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Javascript promise and async/await is reasonably straight-forward abstraction for async programming once you get used to the model. Wrapping an “classic” callback model API with promise then calling it with async/await greatly simplifies your client code.</p>

<p>For your reference, I’m put 3 versions of javascript code that runs (provided that you created a npm and added sqlite package):</p>
<ol>
  <li><a href="https://gist.github.com/yizhang82/e0cf283340860710cdc7ed54131d200a">Callback version</a></li>
  <li><a href="https://gist.github.com/yizhang82/2ab802f1439490984eb998af3d96b16b">Promise version</a></li>
  <li><a href="https://gist.github.com/yizhang82/26101c92faeea19568e48224b09e2d1c">Await version</a></li>
</ol>

<p>BTW, in the upcoming C++ coroutine series, I’ll be talking about how to wrap C async API with C++ coroutines, which are much more involved but would greatly help understand async/await model in a much deeper level.</p>

<p>Hope this helps.</p>

